# 手动标记实习结束功能方案文档

## 一、需求分析

### 1.1 业务背景
- 当前系统只有"解绑"功能，解绑后自主实习会标记为"实习结束"（status=13），但合作企业保持"已录用"（status=3）
- 需要提供手动标记实习结束的功能，支持合作企业和自主实习
- 标记实习结束后，需要触发相关的联动操作

### 1.2 功能要求
- 支持手动标记单个实习申请为"实习结束"
- 支持批量标记多个实习申请为"实习结束"
- 根据申请类型设置正确的状态：
  - 合作企业：status=7（InternshipApplyStatus.COMPLETED）
  - 自主实习：status=13（SelfInternshipApplyStatus.COMPLETED）
- 标记后需要触发相关联动操作

## 二、方案设计

### 方案一：在 InternshipApplyController 中添加新接口（推荐）

#### 2.1 方案描述
在 `InternshipApplyController` 中添加新的接口，专门用于标记实习结束。

#### 2.2 优点
- 功能职责清晰，与解绑功能分离
- 接口语义明确，易于理解和维护
- 可以灵活设置参数（如结束日期、备注等）
- 不影响现有的解绑功能

#### 2.3 缺点
- 需要新增接口和Service方法
- 需要前端新增操作入口

#### 2.4 实现位置
- **Controller**: `internship-server/src/main/java/com/server/internshipserver/controller/internship/InternshipApplyController.java`
- **Service接口**: `internship-server/src/main/java/com/server/internshipserver/service/internship/InternshipApplyService.java`
- **Service实现**: `internship-server/src/main/java/com/server/internshipserver/service/impl/internship/InternshipApplyServiceImpl.java`

#### 2.5 接口设计

**单个标记接口：**
```
POST /internship/apply/{applyId}/complete
参数：
- applyId: 申请ID（路径参数）
- endDate: 实习结束日期（可选，不传则使用当前日期）
- remark: 备注
```

**批量标记接口：**
```
POST /internship/apply/batch-complete
参数：
- applyIds: 申请ID列表（必填）
- endDate: 实习结束日期（可选，不传则使用当前日期）
- remark: 备注
```

#### 2.6 权限设计
- **系统管理员**：可以标记所有实习申请
- **学校管理员**：可以标记本校学生的实习申请
- **学院负责人**：可以标记本院学生的实习申请
- **班主任**：可以标记本班学生的实习申请
- **企业管理员/企业导师**：可以标记本企业的实习申请（仅合作企业）

---

### 方案二：扩展现有的解绑接口

#### 2.1 方案描述
修改现有的 `unbindInternship` 方法，增加参数控制是否标记为"实习结束"。

#### 2.2 优点
- 复用现有代码，改动较小
- 解绑和标记结束可以统一处理

#### 2.3 缺点
- 解绑和标记结束的业务含义不同，混在一起不够清晰
- 解绑主要用于"提前离职"，标记结束用于"正常结束"
- 可能影响现有功能

#### 2.4 实现位置
- **Controller**: `InternshipApplyController.unbindInternship`
- **Service**: `InternshipApplyServiceImpl.unbindInternship`

#### 2.5 接口设计
```
POST /internship/apply/{applyId}/unbind
参数：
- applyId: 申请ID（路径参数）
- reason: 解绑原因
- remark: 备注
- markAsCompleted: 是否标记为实习结束（新增，默认false）
```

---

### 方案三：在企业管理页面添加批量操作

#### 2.1 方案描述
在企业导师/企业管理员的学生列表页面，添加批量标记实习结束的功能。

#### 2.2 优点
- 操作便捷，适合批量处理
- 符合企业用户的使用场景

#### 2.3 缺点
- 只能企业用户使用，学校用户无法使用
- 需要前端配合开发

#### 2.4 实现位置
- **后端接口**：复用方案一的接口
- **前端页面**：`internship-web/src/views/enterprise/StudentEvaluation.vue` 或学生列表页面

---

## 三、推荐方案：方案一

**推荐理由：**
1. 功能职责清晰，符合单一职责原则
2. 接口语义明确，易于理解和维护
3. 支持多种角色使用，灵活性高
4. 不影响现有功能，风险低

## 四、详细实现方案（方案一）

### 4.1 后端实现

#### 4.1.1 Controller 层

**文件位置：** `InternshipApplyController.java`

```java
@ApiOperation("标记实习结束（单个）")
@PreAuthorize("hasAnyRole('ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER', 'ROLE_CLASS_TEACHER', 'ROLE_ENTERPRISE_ADMIN', 'ROLE_ENTERPRISE_MENTOR')")
@PostMapping("/{applyId}/complete")
public Result<?> completeInternship(
        @ApiParam(value = "申请ID", required = true) @PathVariable Long applyId,
        @ApiParam(value = "实习结束日期（可选，格式：yyyy-MM-dd）", required = false) @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate,
        @ApiParam(value = "备注", required = false) @RequestParam(required = false) String remark) {
    internshipApplyService.completeInternship(applyId, endDate, remark);
    return Result.success("标记实习结束成功");
}

@ApiOperation("批量标记实习结束")
@PreAuthorize("hasAnyRole('ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER', 'ROLE_CLASS_TEACHER', 'ROLE_ENTERPRISE_ADMIN', 'ROLE_ENTERPRISE_MENTOR')")
@PostMapping("/batch-complete")
public Result<?> batchCompleteInternship(
        @ApiParam(value = "申请ID列表", required = true) @RequestParam List<Long> applyIds,
        @ApiParam(value = "实习结束日期（可选，格式：yyyy-MM-dd）", required = false) @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate,
        @ApiParam(value = "备注", required = false) @RequestParam(required = false) String remark) {
    internshipApplyService.batchCompleteInternship(applyIds, endDate, remark);
    return Result.success("批量标记实习结束成功");
}
```

#### 4.1.2 Service 接口层

**文件位置：** `InternshipApplyService.java`

```java
/**
 * 标记实习结束（单个）
 * @param applyId 申请ID
 * @param endDate 实习结束日期（可选，不传则使用当前日期）
 * @param remark 备注
 */
void completeInternship(Long applyId, LocalDate endDate, String remark);

/**
 * 批量标记实习结束
 * @param applyIds 申请ID列表
 * @param endDate 实习结束日期（可选，不传则使用当前日期）
 * @param remark 备注
 */
void batchCompleteInternship(List<Long> applyIds, LocalDate endDate, String remark);
```

#### 4.1.3 Service 实现层

**文件位置：** `InternshipApplyServiceImpl.java`

**核心方法：**
```java
@Override
@Transactional(rollbackFor = Exception.class)
public void completeInternship(Long applyId, LocalDate endDate, String remark) {
    // 1. 参数校验
    EntityValidationUtil.validateIdNotNull(applyId, "申请ID");
    
    // 2. 查询申请信息
    InternshipApply apply = this.getById(applyId);
    EntityValidationUtil.validateEntityExists(apply, "申请");
    
    // 3. 权限检查
    checkCompletePermission(apply);
    
    // 4. 状态检查：只有"已录用"或"实习中"状态才能标记为结束
    validateStatusForComplete(apply);
    
    // 5. 更新申请信息
    updateApplyForComplete(apply, endDate, remark);
    
    // 6. 触发联动操作
    triggerCompleteActions(apply);
}

private void checkCompletePermission(InternshipApply apply) {
    // 系统管理员可以标记所有实习申请
    if (dataPermissionUtil.isSystemAdmin()) {
        return;
    }
    
    // 学校管理员可以标记本校学生的实习申请
    if (dataPermissionUtil.hasRole(Constants.ROLE_SCHOOL_ADMIN)) {
        // 可以添加学校ID验证
        return;
    }
    
    // 学院负责人可以标记本院学生的实习申请
    if (dataPermissionUtil.hasRole(Constants.ROLE_COLLEGE_LEADER)) {
        if (apply.getStudentId() == null) {
            throw new BusinessException("无权标记该实习申请");
        }
        Student student = studentMapper.selectById(apply.getStudentId());
        if (student == null || student.getCollegeId() == null) {
            throw new BusinessException("无权标记该实习申请");
        }
        Long currentUserCollegeId = dataPermissionUtil.getCurrentUserCollegeId();
        if (currentUserCollegeId == null || !currentUserCollegeId.equals(student.getCollegeId())) {
            throw new BusinessException("无权标记该实习申请");
        }
        return;
    }
    
    // 班主任可以标记本班学生的实习申请
    if (dataPermissionUtil.hasRole(Constants.ROLE_CLASS_TEACHER)) {
        if (apply.getStudentId() == null) {
            throw new BusinessException("无权标记该实习申请");
        }
        Student student = studentMapper.selectById(apply.getStudentId());
        if (student == null || student.getClassId() == null) {
            throw new BusinessException("无权标记该实习申请");
        }
        List<Long> classIds = dataPermissionUtil.getCurrentUserClassIds();
        if (classIds == null || !classIds.contains(student.getClassId())) {
            throw new BusinessException("无权标记该实习申请");
        }
        return;
    }
    
    // 企业管理员/企业导师可以标记本企业的实习申请（仅合作企业）
    if (dataPermissionUtil.hasRole(Constants.ROLE_ENTERPRISE_ADMIN) || 
        dataPermissionUtil.hasRole(Constants.ROLE_ENTERPRISE_MENTOR)) {
        if (apply.getApplyType() == null || !apply.getApplyType().equals(ApplyType.COOPERATION.getCode())) {
            throw new BusinessException("企业用户只能标记合作企业的实习申请");
        }
        Long currentUserEnterpriseId = dataPermissionUtil.getCurrentUserEnterpriseId();
        if (currentUserEnterpriseId == null || apply.getEnterpriseId() == null ||
            !currentUserEnterpriseId.equals(apply.getEnterpriseId())) {
            throw new BusinessException("无权标记该实习申请");
        }
        return;
    }
    
    throw new BusinessException("无权标记该实习申请");
}

private void validateStatusForComplete(InternshipApply apply) {
    Integer status = apply.getStatus();
    Integer applyType = apply.getApplyType();
    
    if (applyType == null) {
        throw new BusinessException("申请类型不能为空");
    }
    
    // 合作企业：只有"已录用"（status=3）才能标记为结束
    if (applyType.equals(ApplyType.COOPERATION.getCode())) {
        if (status == null || !status.equals(InternshipApplyStatus.ACCEPTED.getCode())) {
            throw new BusinessException("只有已录用的合作企业实习申请才能标记为结束");
        }
        // 检查是否已经结束
        if (status.equals(InternshipApplyStatus.COMPLETED.getCode())) {
            throw new BusinessException("该实习申请已经标记为结束");
        }
    }
    
    // 自主实习：只有"实习中"（status=11）才能标记为结束
    if (applyType.equals(ApplyType.SELF.getCode())) {
        if (status == null || !status.equals(SelfInternshipApplyStatus.IN_PROGRESS.getCode())) {
            throw new BusinessException("只有实习中的自主实习申请才能标记为结束");
        }
        // 检查是否已经结束
        if (status.equals(SelfInternshipApplyStatus.COMPLETED.getCode())) {
            throw new BusinessException("该实习申请已经标记为结束");
        }
    }
}

private void updateApplyForComplete(InternshipApply apply, LocalDate endDate, String remark) {
    // 设置实习结束日期
    if (endDate != null) {
        apply.setInternshipEndDate(endDate);
    } else {
        // 如果没有传入结束日期，使用当前日期
        apply.setInternshipEndDate(LocalDate.now());
    }
    
    // 根据申请类型设置状态
    if (apply.getApplyType().equals(ApplyType.COOPERATION.getCode())) {
        // 合作企业：设置为实习结束（status=7）
        apply.setStatus(InternshipApplyStatus.COMPLETED.getCode());
    } else if (apply.getApplyType().equals(ApplyType.SELF.getCode())) {
        // 自主实习：设置为实习结束（status=13）
        apply.setStatus(SelfInternshipApplyStatus.COMPLETED.getCode());
    }
    
    // 保存备注（如果有）
    if (remark != null && !remark.trim().isEmpty()) {
        // 可以使用现有的字段或新增字段存储备注
        // 这里假设使用 unbindAuditOpinion 字段存储（如果该字段未被使用）
        apply.setUnbindAuditOpinion(remark);
    }
    
    this.updateById(apply);
}

private void triggerCompleteActions(InternshipApply apply) {
    // 1. 更新学生信息（如果有相关字段需要更新）
    updateStudentAfterComplete(apply.getStudentId());
    
    // 2. 触发评价流程通知
    // 可以发送通知给企业导师和学校教师，提醒进行评价
    // notifyEvaluationRequired(apply);
    
    // 3. 记录操作日志
    // logOperation(apply, "标记实习结束");
}

private void updateStudentAfterComplete(Long studentId) {
    // 更新学生的实习状态
    // 如果 Student 表有相关字段，可以在这里更新
    // 例如：student.setInternshipStatus(StudentInternshipStatus.COMPLETED.getCode());
}
```

### 4.2 联动操作说明

#### 4.2.1 必须执行的联动操作

1. **更新申请状态**
   - 合作企业：status=7（InternshipApplyStatus.COMPLETED）
   - 自主实习：status=13（SelfInternshipApplyStatus.COMPLETED）

2. **更新实习结束日期**
   - 如果传入了结束日期，使用传入的日期
   - 如果没有传入，使用当前日期

3. **保存备注信息**
   - 将备注信息保存到申请记录中

#### 4.2.2 可选执行的联动操作

1. **更新学生信息**
   - 如果 Student 表有实习状态字段，可以更新为"已结束"
   - 更新学生的当前实习申请ID（如果有）

2. **发送通知**
   - 通知企业导师：可以开始进行企业评价
   - 通知学校教师：可以开始进行学校评价
   - 通知学生：实习已结束，可以进行自我评价

3. **记录操作日志**
   - 记录谁在什么时候标记了哪个实习申请为结束
   - 记录操作原因和备注

4. **触发评价流程**
   - 自动创建评价记录（草稿状态）
   - 或者发送评价提醒通知

### 4.3 前端实现建议

#### 4.3.1 操作入口位置

1. **实习申请列表页面**
   - 在操作列添加"标记结束"按钮
   - 支持批量选择后批量标记

2. **实习申请详情页面**
   - 在详情页面添加"标记结束"按钮

3. **企业学生列表页面**（企业用户）
   - 在学生列表添加"标记结束"按钮
   - 支持批量操作

#### 4.3.2 交互设计

1. **单个标记**
   - 点击"标记结束"按钮
   - 弹出确认对话框，可以填写结束日期和备注
   - 确认后调用接口

2. **批量标记**
   - 选择多个申请
   - 点击"批量标记结束"按钮
   - 弹出确认对话框，可以填写结束日期和备注（统一应用到所有选中的申请）
   - 确认后调用批量接口

## 五、数据库变更

### 5.1 无需新增字段
- 使用现有的 `status` 字段存储状态
- 使用现有的 `internship_end_date` 字段存储结束日期
- 可以使用现有的 `unbind_audit_opinion` 字段存储备注（如果该字段未被使用）

### 5.2 可选：新增字段
如果需要更详细的记录，可以考虑新增字段：
- `complete_time`: 标记结束的时间
- `complete_user_id`: 标记结束的操作人ID
- `complete_remark`: 标记结束的备注

## 六、测试要点

### 6.1 功能测试
1. 单个标记功能
   - 正常标记
   - 重复标记（应该提示已结束）
   - 状态不符合要求（应该提示错误）
   - 权限不足（应该提示无权限）

2. 批量标记功能
   - 批量标记多个申请
   - 部分成功部分失败的处理

3. 权限测试
   - 不同角色的权限验证
   - 跨权限操作应该被拒绝

### 6.2 联动测试
1. 状态更新是否正确
2. 结束日期是否正确设置
3. 备注是否正确保存
4. 学生信息是否更新（如果有）

## 七、实施计划

### 7.1 第一阶段：后端开发
1. 添加 Service 接口方法
2. 实现 Service 方法
3. 添加 Controller 接口
4. 编写单元测试

### 7.2 第二阶段：前端开发
1. 在申请列表页面添加操作按钮
2. 在申请详情页面添加操作按钮
3. 实现批量操作功能
4. 添加确认对话框

### 7.3 第三阶段：测试和优化
1. 功能测试
2. 权限测试
3. 联动测试
4. 性能优化

## 八、注意事项

1. **状态一致性**
   - 确保状态更新的原子性（使用事务）
   - 避免重复标记

2. **权限控制**
   - 严格按照权限设计实现
   - 企业用户只能操作本企业的申请

3. **数据完整性**
   - 结束日期不能早于开始日期
   - 结束日期不能晚于当前日期（可选，根据业务需求）

4. **向后兼容**
   - 不影响现有的解绑功能
   - 不影响现有的评价功能

5. **性能考虑**
   - 批量操作时注意性能
   - 可以考虑异步处理通知等操作

## 九、扩展功能

1. **自动标记功能**
   - 定时任务：每天检查实习结束日期，自动标记已到期的实习

2. **标记历史记录**
   - 记录标记操作的历史
   - 支持撤销标记（如果业务需要）

3. **评价提醒**
   - 标记结束后自动发送评价提醒
   - 支持配置提醒时间

4. **统计报表**
   - 统计已结束的实习数量
   - 统计实习时长分布

