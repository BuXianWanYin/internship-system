# 学校管理员和学院负责人批阅权限分析

## 一、当前状态

### 1.1 后端权限配置

| 功能 | 查看列表权限 | 批阅权限 | 数据权限过滤 |
|------|------------|---------|-------------|
| 实习日志 | `ROLE_STUDENT`, `ROLE_INSTRUCTOR`, `ROLE_CLASS_TEACHER` | `ROLE_INSTRUCTOR`, `ROLE_CLASS_TEACHER` | ✅ 系统管理员、学生、班主任 |
| 周报 | `ROLE_STUDENT`, `ROLE_INSTRUCTOR`, `ROLE_CLASS_TEACHER` | `ROLE_INSTRUCTOR`, `ROLE_CLASS_TEACHER` | ✅ 系统管理员、学生、班主任 |
| 成果 | `ROLE_STUDENT`, `ROLE_INSTRUCTOR`, `ROLE_CLASS_TEACHER` | `ROLE_INSTRUCTOR`, `ROLE_CLASS_TEACHER` | ✅ 系统管理员、学生、班主任 |

### 1.2 前端菜单配置

| 功能 | 学校管理员 | 学院负责人 | 班主任 |
|------|-----------|-----------|--------|
| 实习日志批阅 | ❌ 无 | ❌ 无 | ✅ 有 |
| 周报批阅 | ❌ 无 | ❌ 无 | ✅ 有 |
| 成果审核 | ❌ 无 | ❌ 无 | ✅ 有 |

### 1.3 数据权限过滤逻辑

**当前实现：**
- ✅ **系统管理员**：无限制，可以查看所有数据
- ✅ **学生**：只能查看自己的数据
- ✅ **班主任**：只能查看管理的班级学生的数据
- ❌ **学校管理员**：未实现数据权限过滤
- ❌ **学院负责人**：未实现数据权限过滤
- ❌ **指导教师**：TODO，未实现

---

## 二、建议方案

### 2.1 建议：允许学校管理员和学院负责人批阅

**理由：**
1. ✅ **职责匹配**：学校管理员负责全校实习管理，学院负责人负责本学院实习管理
2. ✅ **数据权限工具已具备**：`DataPermissionUtil` 已提供 `getCurrentUserSchoolId()` 和 `getCurrentUserCollegeId()` 方法
3. ✅ **与实习申请审核一致**：这两个角色已有实习申请审核权限，批阅权限应该保持一致
4. ✅ **管理需求**：学校管理员和学院负责人需要监督和检查实习质量

### 2.2 数据权限范围

| 角色 | 数据权限范围 |
|------|------------|
| 系统管理员 | 所有数据（无限制） |
| 学校管理员 | 本学校所有学生的数据 |
| 学院负责人 | 本学院所有学生的数据 |
| 班主任 | 管理的班级学生的数据 |
| 指导教师 | 分配指导的学生的数据（TODO） |
| 学生 | 自己的数据 |

---

## 三、需要修改的内容

### 3.1 后端权限修改

#### 3.1.1 实习日志批阅

**文件**：`internship-server/src/main/java/com/server/internshipserver/controller/internship/InternshipLogController.java`

**修改内容：**
```java
// 第45行，修改前：
@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER')")

// 修改后：
@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER')")

// 第60行，修改前：
@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER')")

// 修改后：
@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER')")

// 第69行，修改前：
@PreAuthorize("hasAnyRole('ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER')")

// 修改后：
@PreAuthorize("hasAnyRole('ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER')")
```

#### 3.1.2 周报批阅

**文件**：`internship-server/src/main/java/com/server/internshipserver/controller/internship/InternshipWeeklyReportController.java`

**修改内容：**
```java
// 第44行，修改前：
@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER')")

// 修改后：
@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER')")

// 第59行，修改前：
@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER')")

// 修改后：
@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER')")

// 第68行，修改前：
@PreAuthorize("hasAnyRole('ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER')")

// 修改后：
@PreAuthorize("hasAnyRole('ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER')")
```

#### 3.1.3 成果审核

**文件**：`internship-server/src/main/java/com/server/internshipserver/controller/internship/InternshipAchievementController.java`

**修改内容：**
```java
// 第42行，修改前：
@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER')")

// 修改后：
@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER')")

// 第57行，修改前：
@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER')")

// 修改后：
@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER')")

// 第66行，修改前：
@PreAuthorize("hasAnyRole('ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER')")

// 修改后：
@PreAuthorize("hasAnyRole('ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER')")
```

### 3.2 数据权限过滤逻辑修改

#### 3.2.1 实习日志数据权限过滤

**文件**：`internship-server/src/main/java/com/server/internshipserver/service/impl/internship/InternshipLogServiceImpl.java`

**修改位置**：`applyDataPermissionFilter` 方法（第295行）

**修改内容：**
```java
private void applyDataPermissionFilter(LambdaQueryWrapper<InternshipLog> wrapper) {
    // 系统管理员不添加限制
    if (dataPermissionUtil.isSystemAdmin()) {
        return;
    }
    
    // 学生只能查看自己的日志
    Long currentUserId = dataPermissionUtil.getCurrentUserId();
    if (currentUserId != null && dataPermissionUtil.hasRole("ROLE_STUDENT")) {
        Student student = studentMapper.selectOne(
                new LambdaQueryWrapper<Student>()
                        .eq(Student::getUserId, currentUserId)
                        .eq(Student::getDeleteFlag, DeleteFlag.NORMAL.getCode())
        );
        if (student != null) {
            wrapper.eq(InternshipLog::getStudentId, student.getStudentId());
        }
        return;
    }
    
    // 学校管理员：只能查看本学校学生的日志
    if (dataPermissionUtil.hasRole("ROLE_SCHOOL_ADMIN")) {
        Long schoolId = dataPermissionUtil.getCurrentUserSchoolId();
        if (schoolId != null) {
            // 查询本学校的所有学生
            List<Student> students = studentMapper.selectList(
                    new LambdaQueryWrapper<Student>()
                            .eq(Student::getSchoolId, schoolId)
                            .eq(Student::getDeleteFlag, DeleteFlag.NORMAL.getCode())
                            .select(Student::getStudentId)
            );
            if (students != null && !students.isEmpty()) {
                List<Long> studentIds = students.stream()
                        .map(Student::getStudentId)
                        .collect(java.util.stream.Collectors.toList());
                wrapper.in(InternshipLog::getStudentId, studentIds);
            } else {
                wrapper.eq(InternshipLog::getLogId, -1L);
            }
        }
        return;
    }
    
    // 学院负责人：只能查看本学院学生的日志
    if (dataPermissionUtil.hasRole("ROLE_COLLEGE_LEADER")) {
        Long collegeId = dataPermissionUtil.getCurrentUserCollegeId();
        if (collegeId != null) {
            // 查询本学院的所有学生
            List<Student> students = studentMapper.selectList(
                    new LambdaQueryWrapper<Student>()
                            .eq(Student::getCollegeId, collegeId)
                            .eq(Student::getDeleteFlag, DeleteFlag.NORMAL.getCode())
                            .select(Student::getStudentId)
            );
            if (students != null && !students.isEmpty()) {
                List<Long> studentIds = students.stream()
                        .map(Student::getStudentId)
                        .collect(java.util.stream.Collectors.toList());
                wrapper.in(InternshipLog::getStudentId, studentIds);
            } else {
                wrapper.eq(InternshipLog::getLogId, -1L);
            }
        }
        return;
    }
    
    // 班主任：只能查看管理的班级的学生的日志
    List<Long> currentUserClassIds = dataPermissionUtil.getCurrentUserClassIds();
    if (currentUserClassIds != null && !currentUserClassIds.isEmpty()) {
        List<Student> students = studentMapper.selectList(
                new LambdaQueryWrapper<Student>()
                        .in(Student::getClassId, currentUserClassIds)
                        .eq(Student::getDeleteFlag, DeleteFlag.NORMAL.getCode())
                        .select(Student::getStudentId)
        );
        if (students != null && !students.isEmpty()) {
            List<Long> studentIds = students.stream()
                    .map(Student::getStudentId)
                    .collect(java.util.stream.Collectors.toList());
            wrapper.in(InternshipLog::getStudentId, studentIds);
        } else {
            wrapper.eq(InternshipLog::getLogId, -1L);
        }
    }
    // 指导教师可以查看分配的学生的日志
    // TODO: 实现指导教师数据权限过滤
}
```

#### 3.2.2 周报数据权限过滤

**文件**：`internship-server/src/main/java/com/server/internshipserver/service/impl/internship/InternshipWeeklyReportServiceImpl.java`

**修改位置**：`applyDataPermissionFilter` 方法（第316行）

**修改内容：**（与实习日志类似，将 `InternshipLog` 替换为 `InternshipWeeklyReport`，`getLogId` 替换为 `getReportId`）

#### 3.2.3 成果数据权限过滤

**文件**：`internship-server/src/main/java/com/server/internshipserver/service/impl/internship/InternshipAchievementServiceImpl.java`

**修改位置**：`applyDataPermissionFilter` 方法（第282行）

**修改内容：**（与实习日志类似，将 `InternshipLog` 替换为 `InternshipAchievement`，`getLogId` 替换为 `getAchievementId`）

### 3.3 前端菜单配置修改

**文件**：`internship-web/src/config/menu.config.js`

**修改位置**：实习管理（教师）模块（第275-307行）

**修改内容：**
```javascript
// ========== 实习管理（教师） ==========
{
  index: 'internship-teacher',
  title: '实习管理',
  icon: Document,
  roles: ['ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_ENTERPRISE_MENTOR', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER'],
  children: [
    {
      index: '/teacher/internship/log',
      title: '实习日志批阅',
      icon: Document,
      roles: ['ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER']
    },
    {
      index: '/teacher/internship/weekly-report',
      title: '周报批阅',
      icon: Files,
      roles: ['ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER']
    },
    {
      index: '/teacher/internship/achievement',
      title: '成果审核',
      icon: Files,
      roles: ['ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER']
    },
    {
      index: '/teacher/internship/feedback',
      title: '问题反馈处理',
      icon: ChatLineRound,
      roles: ['ROLE_INSTRUCTOR', 'ROLE_ENTERPRISE_MENTOR', 'ROLE_CLASS_TEACHER']
    }
  ]
}
```

### 3.4 前端路由配置修改

**文件**：`internship-web/src/router/modules/internship.js`

**修改内容：**
```javascript
// 第96-103行，实习日志批阅路由
{
  path: '/teacher/internship/log',
  name: 'TeacherInternshipLog',
  component: () => import('@/views/teacher/InternshipLog.vue'),
  meta: {
    title: '实习日志批阅',
    requiresAuth: true,
    roles: ['ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER']
  }
},

// 第116-123行，周报批阅路由
{
  path: '/teacher/internship/weekly-report',
  name: 'TeacherWeeklyReport',
  component: () => import('@/views/teacher/WeeklyReport.vue'),
  meta: {
    title: '周报批阅',
    requiresAuth: true,
    roles: ['ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER']
  }
},

// 第156-163行，成果审核路由
{
  path: '/teacher/internship/achievement',
  name: 'TeacherAchievement',
  component: () => import('@/views/teacher/Achievement.vue'),
  meta: {
    title: '成果审核',
    requiresAuth: true,
    roles: ['ROLE_INSTRUCTOR', 'ROLE_CLASS_TEACHER', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER']
  }
}
```

---

## 四、修改影响分析

### 4.1 功能影响

| 功能 | 修改前 | 修改后 | 影响 |
|------|--------|--------|------|
| 学校管理员查看日志/周报/成果 | ❌ 无权限 | ✅ 可查看本学校所有数据 | ✅ 新增功能 |
| 学校管理员批阅日志/周报/成果 | ❌ 无权限 | ✅ 可批阅本学校所有数据 | ✅ 新增功能 |
| 学院负责人查看日志/周报/成果 | ❌ 无权限 | ✅ 可查看本学院所有数据 | ✅ 新增功能 |
| 学院负责人批阅日志/周报/成果 | ❌ 无权限 | ✅ 可批阅本学院所有数据 | ✅ 新增功能 |
| 班主任功能 | ✅ 正常 | ✅ 正常 | ✅ 无影响 |
| 指导教师功能 | ✅ 正常 | ✅ 正常 | ✅ 无影响 |
| 学生功能 | ✅ 正常 | ✅ 正常 | ✅ 无影响 |

### 4.2 数据权限影响

- ✅ **数据隔离正确**：学校管理员只能看到本学校数据，学院负责人只能看到本学院数据
- ✅ **权限层级清晰**：系统管理员 > 学校管理员 > 学院负责人 > 班主任 > 学生
- ✅ **不影响现有功能**：班主任、指导教师、学生的权限保持不变

---

## 五、实施建议

### 5.1 实施步骤

1. **第一步**：修改后端权限（Controller 的 `@PreAuthorize`）
2. **第二步**：修改数据权限过滤逻辑（Service 的 `applyDataPermissionFilter`）
3. **第三步**：修改前端菜单配置
4. **第四步**：修改前端路由配置
5. **第五步**：测试验证

### 5.2 测试要点

1. ✅ **学校管理员**：
   - 可以查看本学校所有学生的日志/周报/成果
   - 可以批阅本学校所有学生的日志/周报/成果
   - 不能查看其他学校的数据

2. ✅ **学院负责人**：
   - 可以查看本学院所有学生的日志/周报/成果
   - 可以批阅本学院所有学生的日志/周报/成果
   - 不能查看其他学院的数据

3. ✅ **班主任**：
   - 功能保持不变
   - 只能查看管理的班级学生的数据

4. ✅ **指导教师**：
   - 功能保持不变

5. ✅ **学生**：
   - 功能保持不变
   - 只能查看自己的数据

---

## 六、总结

### 6.1 建议

✅ **强烈建议**允许学校管理员和学院负责人批阅实习日志、周报、成果。

### 6.2 理由

1. ✅ 职责匹配，符合管理需求
2. ✅ 数据权限工具已具备，实现成本低
3. ✅ 与实习申请审核权限保持一致
4. ✅ 不影响现有功能

### 6.3 实施难度

- **难度**：⭐⭐（中等）
- **工作量**：约 2-3 小时
- **风险**：低（主要是新增功能，不影响现有功能）

---

**文档生成时间**：2025-11-24
**分析人员**：AI Assistant

