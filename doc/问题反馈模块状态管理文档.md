# 问题反馈模块状态管理文档

## 1. 状态定义

问题反馈模块包含以下4种状态：

| 状态值 | 状态名称 | 说明 | 颜色标识 |
|--------|---------|------|---------|
| 0 | 待处理 | 学生刚提交的反馈，等待教师/企业导师处理 | 橙色（warning） |
| 1 | 处理中 | 教师/企业导师已回复，正在处理中 | 蓝色（primary） |
| 2 | 已解决 | 问题已解决 | 绿色（success） |
| 3 | 已关闭 | 反馈已关闭 | 灰色（info） |

## 2. 状态流转图

```
学生提交反馈
    ↓
[0] 待处理
    ↓ (教师/企业导师回复)
[1] 处理中
    ↓ (学生标记已解决 或 教师/企业导师标记已解决)
[2] 已解决
    ↓ (学生/教师/企业导师关闭)
[3] 已关闭

或者：

[0] 待处理
    ↓ (学生/教师/企业导师直接关闭)
[3] 已关闭

[1] 处理中
    ↓ (学生/教师/企业导师关闭)
[3] 已关闭
```

## 3. 状态变更权限

### 3.1 学生（ROLE_STUDENT）

**可以执行的操作：**

1. **提交反馈**
   - 创建新反馈，状态自动设置为 `0`（待处理）
   - 权限控制：`@PreAuthorize("hasRole('ROLE_STUDENT')")`
   - 后端方法：`addFeedback()`

2. **编辑反馈**
   - 只能编辑自己提交的反馈
   - **限制条件**：只有状态为 `0`（待处理）的反馈才能编辑
   - 权限控制：`@PreAuthorize("hasRole('ROLE_STUDENT')")`
   - 后端方法：`updateFeedback()`
   - 后端验证：
     ```java
     // 只有待处理状态的反馈才能修改
     if (existFeedback.getFeedbackStatus() == null || existFeedback.getFeedbackStatus() != 0) {
         throw new BusinessException("只有待处理状态的反馈才能修改");
     }
     ```

3. **删除反馈**
   - 只能删除自己提交的反馈
   - **限制条件**：只有状态为 `0`（待处理）的反馈才能删除
   - 权限控制：`@PreAuthorize("hasRole('ROLE_STUDENT')")`
   - 后端方法：`deleteFeedback()`
   - 前端显示条件：`v-if="row.feedbackStatus === 0"`

4. **标记已解决**
   - 可以标记反馈为已解决
   - **限制条件**：只有状态为 `1`（处理中）的反馈才能标记为已解决
   - 权限控制：`@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_ENTERPRISE_MENTOR')")`
   - 后端方法：`solveFeedback()`
   - 后端验证：
     ```java
     // 只有处理中状态的反馈才能标记为已解决
     if (feedback.getFeedbackStatus() == null || feedback.getFeedbackStatus() != 1) {
         throw new BusinessException("只有处理中状态的反馈才能标记为已解决");
     }
     ```
   - **前端问题**：学生页面显示条件为 `v-if="row.feedbackStatus === 2"`，这是错误的，应该改为 `v-if="row.feedbackStatus === 1"`

5. **关闭反馈**
   - 可以关闭反馈
   - **限制条件**：状态不为 `3`（已关闭）的反馈都可以关闭
   - 权限控制：`@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_ENTERPRISE_MENTOR')")`
   - 后端方法：`closeFeedback()`
   - 前端显示条件：`v-if="row.feedbackStatus !== 3"`

### 3.2 教师/企业导师（ROLE_INSTRUCTOR / ROLE_ENTERPRISE_MENTOR）

**可以执行的操作：**

1. **回复反馈**
   - 可以回复状态为 `0`（待处理）或 `1`（处理中）的反馈
   - 回复后，状态自动变为 `1`（处理中）
   - 权限控制：`@PreAuthorize("hasAnyRole('ROLE_INSTRUCTOR', 'ROLE_ENTERPRISE_MENTOR')")`
   - 后端方法：`replyFeedback()`
   - 后端逻辑：
     ```java
     feedback.setReplyContent(replyContent);
     feedback.setReplyTime(LocalDateTime.now());
     feedback.setReplyUserType(replyUserType);
     feedback.setFeedbackStatus(1); // 处理中
     ```
   - 前端显示条件：`v-if="row.feedbackStatus === 0 || row.feedbackStatus === 1"`

2. **标记已解决**
   - 可以标记反馈为已解决
   - **限制条件**：只有状态为 `1`（处理中）的反馈才能标记为已解决
   - 权限控制：`@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_ENTERPRISE_MENTOR')")`
   - 后端方法：`solveFeedback()`
   - 后端验证：
     ```java
     // 只有处理中状态的反馈才能标记为已解决
     if (feedback.getFeedbackStatus() == null || feedback.getFeedbackStatus() != 1) {
         throw new BusinessException("只有处理中状态的反馈才能标记为已解决");
     }
     ```

3. **关闭反馈**
   - 可以关闭反馈
   - **限制条件**：无状态限制（后端未做限制）
   - 权限控制：`@PreAuthorize("hasAnyRole('ROLE_STUDENT', 'ROLE_INSTRUCTOR', 'ROLE_ENTERPRISE_MENTOR')")`
   - 后端方法：`closeFeedback()`

## 4. 状态变更详细说明

### 4.1 提交反馈（学生）

- **触发操作**：学生点击"提交反馈"按钮
- **状态变更**：无 → `0`（待处理）
- **后端代码位置**：`InternshipFeedbackServiceImpl.addFeedback()`
  ```java
  feedback.setFeedbackStatus(0); // 待处理
  ```

### 4.2 编辑反馈（学生）

- **触发操作**：学生点击"编辑"按钮
- **状态变更**：无（状态保持不变，仍为 `0`）
- **限制条件**：只有状态为 `0`（待处理）的反馈才能编辑
- **后端代码位置**：`InternshipFeedbackServiceImpl.updateFeedback()`

### 4.3 回复反馈（教师/企业导师）

- **触发操作**：教师/企业导师点击"回复"按钮
- **状态变更**：`0`（待处理）或 `1`（处理中） → `1`（处理中）
- **限制条件**：只有状态为 `0`（待处理）或 `1`（处理中）的反馈才能回复
- **后端代码位置**：`InternshipFeedbackServiceImpl.replyFeedback()`
  ```java
  feedback.setFeedbackStatus(1); // 处理中
  ```

### 4.4 标记已解决（学生/教师/企业导师）

- **触发操作**：学生/教师/企业导师点击"标记已解决"按钮
- **状态变更**：`1`（处理中） → `2`（已解决）
- **限制条件**：只有状态为 `1`（处理中）的反馈才能标记为已解决
- **后端代码位置**：`InternshipFeedbackServiceImpl.solveFeedback()`
  ```java
  feedback.setFeedbackStatus(2);
  feedback.setSolveTime(LocalDateTime.now());
  ```

### 4.5 关闭反馈（学生/教师/企业导师）

- **触发操作**：学生/教师/企业导师点击"关闭"按钮
- **状态变更**：`0`（待处理）/ `1`（处理中）/ `2`（已解决） → `3`（已关闭）
- **限制条件**：无（后端未做状态限制）
- **后端代码位置**：`InternshipFeedbackServiceImpl.closeFeedback()`
  ```java
  feedback.setFeedbackStatus(3);
  ```

### 4.6 删除反馈（学生）

- **触发操作**：学生点击"删除"按钮
- **状态变更**：无（软删除，设置 `deleteFlag = 1`）
- **限制条件**：只有状态为 `0`（待处理）的反馈才能删除
- **后端代码位置**：`InternshipFeedbackServiceImpl.deleteFeedback()`

## 5. 前端页面功能对比

### 5.1 学生页面（`internship-web/src/views/student/Feedback.vue`）

| 操作 | 显示条件 | 后端权限 | 状态限制 |
|------|---------|---------|---------|
| 提交反馈 | 始终显示 | `ROLE_STUDENT` | 无 |
| 编辑反馈 | `row.feedbackStatus === 0` | `ROLE_STUDENT` | 仅待处理 |
| 删除反馈 | `row.feedbackStatus === 0` | `ROLE_STUDENT` | 仅待处理 |
| **标记已解决** | `row.feedbackStatus === 2` ❌ | `ROLE_STUDENT` | **仅处理中** |
| 关闭反馈 | `row.feedbackStatus !== 3` | `ROLE_STUDENT` | 无 |

**问题**：学生页面的"标记已解决"按钮显示条件错误，应该改为 `row.feedbackStatus === 1`（处理中），而不是 `row.feedbackStatus === 2`（已解决）。

### 5.2 教师页面（`internship-web/src/views/teacher/Feedback.vue`）

| 操作 | 显示条件 | 后端权限 | 状态限制 |
|------|---------|---------|---------|
| 查看详情 | 始终显示 | `ROLE_INSTRUCTOR` | 无 |
| 回复反馈 | `row.feedbackStatus === 0 \|\| row.feedbackStatus === 1` | `ROLE_INSTRUCTOR` | 待处理或处理中 |

**注意**：教师页面没有"标记已解决"和"关闭"按钮，但后端接口允许教师执行这些操作。

## 6. 后端API接口权限

| 接口 | 方法 | 路径 | 权限要求 | 状态限制 |
|------|------|------|---------|---------|
| 提交反馈 | POST | `/internship/feedback` | `ROLE_STUDENT` | 无 |
| 更新反馈 | PUT | `/internship/feedback` | `ROLE_STUDENT` | 仅待处理 |
| 查询反馈列表 | GET | `/internship/feedback/page` | `ROLE_STUDENT`, `ROLE_INSTRUCTOR`, `ROLE_ENTERPRISE_MENTOR`, `ROLE_CLASS_TEACHER` | 无 |
| 查询反馈详情 | GET | `/internship/feedback/{feedbackId}` | `ROLE_STUDENT`, `ROLE_INSTRUCTOR`, `ROLE_ENTERPRISE_MENTOR`, `ROLE_CLASS_TEACHER` | 无 |
| 回复反馈 | POST | `/internship/feedback/{feedbackId}/reply` | `ROLE_INSTRUCTOR`, `ROLE_ENTERPRISE_MENTOR` | 待处理或处理中 |
| 标记已解决 | POST | `/internship/feedback/{feedbackId}/solve` | `ROLE_STUDENT`, `ROLE_INSTRUCTOR`, `ROLE_ENTERPRISE_MENTOR` | 仅处理中 |
| 关闭反馈 | POST | `/internship/feedback/{feedbackId}/close` | `ROLE_STUDENT`, `ROLE_INSTRUCTOR`, `ROLE_ENTERPRISE_MENTOR` | 无 |
| 删除反馈 | DELETE | `/internship/feedback/{feedbackId}` | `ROLE_STUDENT` | 仅待处理 |

## 7. 数据权限

### 7.1 学生
- 只能查看、编辑、删除自己提交的反馈
- 后端验证：`user.getUserId().equals(existFeedback.getUserId())`

### 7.2 教师（ROLE_INSTRUCTOR）
- 可以查看、回复自己指导的学生的反馈
- 数据权限过滤：通过 `internship_apply` 表关联，查询 `instructor_id` 匹配的反馈

### 7.3 企业导师（ROLE_ENTERPRISE_MENTOR）
- 可以查看、回复自己企业的学生的反馈
- 数据权限过滤：通过 `internship_apply` 表关联，查询 `enterprise_id` 匹配的反馈

### 7.4 班主任（ROLE_CLASS_TEACHER）
- 可以查看自己班级的学生的反馈
- 数据权限过滤：通过学生所属班级进行过滤

## 8. 发现的问题

### 8.1 前端显示条件错误

**问题**：学生页面的"标记已解决"按钮显示条件错误

**位置**：`internship-web/src/views/student/Feedback.vue` 第83行

**当前代码**：
```vue
<el-button
  v-if="row.feedbackStatus === 2"
  link
  type="success"
  size="small"
  @click="handleSolve(row)"
>
  标记已解决
</el-button>
```

**问题说明**：
- 当前显示条件是 `row.feedbackStatus === 2`（已解决状态）
- 但后端要求只有状态为 `1`（处理中）的反馈才能标记为已解决
- 这导致按钮在错误的状态下显示，点击后会报错

**修复建议**：
```vue
<el-button
  v-if="row.feedbackStatus === 1"
  link
  type="success"
  size="small"
  @click="handleSolve(row)"
>
  标记已解决
</el-button>
```

### 8.2 教师页面缺少功能

**问题**：教师页面没有"标记已解决"和"关闭"按钮

**说明**：
- 后端接口允许教师执行这些操作（权限为 `hasAnyRole('ROLE_INSTRUCTOR', 'ROLE_ENTERPRISE_MENTOR')`）
- 但前端教师页面没有提供这些功能的入口
- 建议在教师页面添加这些按钮，提升用户体验

## 9. 总结

### 9.1 状态管理特点

1. **状态流转清晰**：从待处理 → 处理中 → 已解决 → 已关闭，流程明确
2. **权限控制严格**：不同角色有不同的操作权限
3. **状态限制明确**：每个操作都有明确的状态限制条件

### 9.2 需要修复的问题

1. **学生页面**：修复"标记已解决"按钮的显示条件（从 `=== 2` 改为 `=== 1`）
2. **教师页面**：考虑添加"标记已解决"和"关闭"按钮（可选）

### 9.3 状态变更权限总结

| 操作 | 学生 | 教师 | 企业导师 |
|------|------|------|---------|
| 提交反馈 | ✅ | ❌ | ❌ |
| 编辑反馈（仅待处理） | ✅ | ❌ | ❌ |
| 删除反馈（仅待处理） | ✅ | ❌ | ❌ |
| 回复反馈 | ❌ | ✅ | ✅ |
| 标记已解决（仅处理中） | ✅ | ✅ | ✅ |
| 关闭反馈 | ✅ | ✅ | ✅ |

---

**文档版本**：v1.0  
**最后更新**：2025-11-24  
**维护人员**：系统开发团队

