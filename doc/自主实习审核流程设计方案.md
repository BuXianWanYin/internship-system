# 自主实习审核流程设计方案

## 一、背景说明

### 当前情况
- **合作企业实习**：有企业ID，有企业导师，企业导师和班主任都可以审批
- **自主实习**：没有企业ID，没有企业导师，需要重新设计审核流程

### 涉及功能模块
1. **考勤管理**：学生打卡、请假、休息等
2. **实习日志**：学生提交的实习日志
3. **周报**：学生提交的周报
4. **阶段性成果**：学生提交的成果
5. **问题反馈**：学生提交的问题反馈

---

## 二、方案对比

### 方案一：基于申请类型的权限控制（推荐）

#### 核心思路
- 根据 `apply_type` 字段判断申请类型
- 合作企业实习（apply_type=1）：企业导师审批，班主任查看
- 自主实习（apply_type=2）：班主任审批

#### 实现方式

**1. 后端权限控制**
```java
// 在Service层添加判断逻辑
private boolean canReview(InternshipApply apply, UserInfo currentUser) {
    // 系统管理员和学校管理员可以审批所有
    if (isSystemAdmin() || isSchoolAdmin()) {
        return true;
    }
    
    // 根据申请类型判断
    if (apply.getApplyType() == ApplyType.COOPERATION.getCode()) {
        // 合作企业实习：企业导师可以审批
        return isEnterpriseMentor() && isSameEnterprise(apply);
    } else if (apply.getApplyType() == ApplyType.SELF.getCode()) {
        // 自主实习：班主任可以审批
        return isClassTeacher() && isSameClass(apply);
    }
    return false;
}
```

**2. 前端按钮显示控制**
```javascript
// 根据申请类型和当前用户角色控制按钮显示
const canReview = computed(() => {
  if (isSystemAdmin || isSchoolAdmin) return true;
  
  if (apply.applyType === 1) {
    // 合作企业实习：只有企业导师显示审批按钮
    return isEnterpriseMentor;
  } else if (apply.applyType === 2) {
    // 自主实习：只有班主任显示审批按钮
    return isClassTeacher;
  }
  return false;
});
```

**3. 考勤管理**
- **合作企业实习**：企业导师确认考勤，班主任查看
- **自主实习**：班主任确认考勤（或学生自己确认，无需审批）

#### 优点
- ✅ 逻辑清晰，易于理解和维护
- ✅ 权限控制精确，符合业务需求
- ✅ 代码改动相对较小
- ✅ 前端可以根据申请类型动态显示按钮

#### 缺点
- ⚠️ 需要在多个Service中添加判断逻辑
- ⚠️ 前端需要传递申请类型信息

---

### 方案二：基于企业ID的权限控制

#### 核心思路
- 通过 `enterprise_id` 是否为null判断
- `enterprise_id != null`：合作企业实习，企业导师审批
- `enterprise_id == null`：自主实习，班主任审批

#### 实现方式

**1. 后端判断**
```java
private boolean canReview(InternshipApply apply, UserInfo currentUser) {
    if (isSystemAdmin() || isSchoolAdmin()) {
        return true;
    }
    
    // 有企业ID：合作企业实习
    if (apply.getEnterpriseId() != null) {
        return isEnterpriseMentor() && isSameEnterprise(apply);
    } else {
        // 无企业ID：自主实习
        return isClassTeacher() && isSameClass(apply);
    }
}
```

#### 优点
- ✅ 判断逻辑简单，只需判断企业ID
- ✅ 不需要修改数据库结构

#### 缺点
- ⚠️ 依赖字段值，不够明确
- ⚠️ 如果未来有其他类型，扩展性较差

---

### 方案三：统一审核流程，后端自动路由

#### 核心思路
- 前端统一调用审核接口
- 后端根据申请类型自动判断审核人
- 审核时记录审核人角色信息

#### 实现方式

**1. 后端统一审核接口**
```java
@PostMapping("/{id}/review")
public Result<?> review(@PathVariable Long id, @RequestBody ReviewDTO dto) {
    // 获取申请信息
    InternshipApply apply = applyService.getById(id);
    
    // 根据申请类型判断审核权限
    if (apply.getApplyType() == ApplyType.COOPERATION.getCode()) {
        // 合作企业：验证企业导师权限
        validateEnterpriseMentorPermission(apply);
    } else {
        // 自主实习：验证班主任权限
        validateClassTeacherPermission(apply);
    }
    
    // 执行审核
    return service.review(id, dto);
}
```

#### 优点
- ✅ 前端逻辑简单，统一调用
- ✅ 后端统一处理，易于维护

#### 缺点
- ⚠️ 需要修改所有审核接口
- ⚠️ 前端无法提前判断是否显示按钮

---

### 方案四：混合方案（推荐用于考勤）

#### 核心思路
- **考勤**：自主实习学生自己确认，无需审批（或班主任审批）
- **日志/周报/成果/反馈**：使用方案一的权限控制

#### 考勤处理方式

**方式A：自主实习无需审批**
- 学生打卡后自动确认
- 班主任可以查看，但不需要确认

**方式B：班主任审批**
- 学生打卡后，状态为"待确认"
- 班主任可以确认或拒绝

#### 优点
- ✅ 考勤流程简化，自主实习学生更灵活
- ✅ 其他模块保持统一审核流程

#### 缺点
- ⚠️ 考勤和其他模块处理方式不一致

---

## 三、推荐方案

### 推荐：方案一 + 方案四（考勤部分）

#### 整体设计

**1. 考勤管理**
- **合作企业实习**：
  - 学生打卡 → 企业导师确认/拒绝
  - 班主任可以查看，不显示确认按钮
- **自主实习**：
  - 学生打卡 → 自动确认（或班主任确认）
  - 班主任可以查看和确认

**2. 日志/周报/成果/反馈**
- **合作企业实习**：
  - 企业导师可以审批
  - 班主任可以查看，不显示审批按钮
- **自主实习**：
  - 班主任可以审批
  - 企业导师不显示（因为没有企业）

#### 实现要点

**1. 后端修改**
- 在 `AttendanceService`、`InternshipLogService`、`InternshipWeeklyReportService`、`InternshipAchievementService`、`InternshipFeedbackService` 中添加权限判断
- 根据 `apply_type` 或 `enterprise_id` 判断审核权限

**2. 前端修改**
- 在列表和详情页面，根据申请类型和当前用户角色控制按钮显示
- 添加工具函数判断是否可以审核

**3. 数据库查询**
- 查询时关联 `internship_apply` 表获取 `apply_type` 和 `enterprise_id`
- 在DTO中返回申请类型信息

---

## 四、具体实现建议

### 1. 考勤管理

**自主实习考勤流程：**
- 选项A：学生打卡后自动确认（推荐）
  - 学生打卡 → `confirm_status = 1`（已确认）
  - 班主任可以查看，但不需要操作
- 选项B：班主任确认
  - 学生打卡 → `confirm_status = 0`（待确认）
  - 班主任可以确认或拒绝

### 2. 日志/周报/成果/反馈

**统一审核流程：**
- 合作企业实习：企业导师审批
- 自主实习：班主任审批
- 系统管理员和学校管理员：都可以审批

### 3. 前端按钮控制

```javascript
// 判断是否可以审核
const canReview = computed(() => {
  // 系统管理员和学校管理员可以审核所有
  if (hasAnyRole(['ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN'])) {
    return true;
  }
  
  // 获取申请信息
  const apply = currentItem.apply || {};
  
  if (apply.applyType === 1) {
    // 合作企业实习：企业导师可以审核
    return hasAnyRole(['ROLE_ENTERPRISE_MENTOR', 'ROLE_ENTERPRISE_ADMIN']);
  } else if (apply.applyType === 2) {
    // 自主实习：班主任可以审核
    return hasAnyRole(['ROLE_CLASS_TEACHER']);
  }
  
  return false;
});
```

---

## 五、数据库设计

### 现有字段
- `internship_apply.apply_type`：申请类型（1-合作企业，2-自主实习）
- `internship_apply.enterprise_id`：企业ID（合作企业有值，自主实习为null）

### 无需新增字段
- 使用现有字段即可实现权限控制

---

## 六、实施步骤

1. **后端权限判断**
   - 在Service层添加 `canReview` 方法
   - 修改所有审核接口，添加权限验证

2. **前端按钮控制**
   - 在列表和详情页面添加权限判断
   - 根据申请类型和用户角色控制按钮显示

3. **考勤特殊处理**
   - 自主实习考勤自动确认或班主任确认
   - 修改考勤确认逻辑

4. **测试验证**
   - 测试合作企业实习的审核流程
   - 测试自主实习的审核流程
   - 验证权限控制是否正确

---

## 七、方案选择建议

| 方案 | 适用场景 | 推荐度 |
|------|---------|--------|
| 方案一 | 所有模块统一处理 | ⭐⭐⭐⭐⭐ |
| 方案二 | 简单场景 | ⭐⭐⭐ |
| 方案三 | 需要统一接口 | ⭐⭐⭐⭐ |
| 方案四 | 考勤特殊处理 | ⭐⭐⭐⭐⭐ |

**最终推荐：方案一（日志/周报/成果/反馈）+ 方案四（考勤）**

