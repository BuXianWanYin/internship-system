# 筛选框权限控制优化方案

## 一、需求分析

### 1.1 用户管理页面筛选框要求

**学校管理员**：
- 所属学校：绑定该用户所在的学校，不允许修改（禁用）
- 所属学院：可以下拉选择（本学校的所有学院）
- 所属班级：可以下拉选择（根据选择的学院）

**学院负责人**：
- 所属学校：绑定该用户所在的学校，不允许修改（禁用）
- 所属学院：绑定该用户所在的学院，不允许修改（禁用）
- 所属班级：可以下拉选择（本学院的所有班级）

**班主任**：
- 所属学校：绑定该用户所在的学校，不允许修改（禁用）
- 所属学院：绑定该用户所在的学院，不允许修改（禁用）
- 所属班级：可以下拉选择（管理的多个班级，支持多选）

**系统管理员**：
- 所有筛选框都可以自由选择

### 1.2 教师管理页面筛选框要求

**学校管理员**：
- 所属学校：绑定该用户所在的学校，不允许修改（禁用）
- 所属学院：可以下拉选择（本学校的所有学院）

**学院负责人**：
- 所属学校：绑定该用户所在的学校，不允许修改（禁用）
- 所属学院：绑定该用户所在的学院，不允许修改（禁用）

**系统管理员**：
- 所有筛选框都可以自由选择

### 1.3 数据权限要求

- **学校管理员**：只能看到本学校的用户和教师
- **学院负责人**：只能看到本学院的用户和教师
- **班主任**：只能看到管理的班级的学生用户

## 二、需要修改的页面清单

### 2.1 必须修改的页面

1. **用户管理页面** (`UserManagement.vue`)
   - 需要根据角色设置筛选框的默认值和禁用状态
   - 需要获取当前用户的组织信息

2. **教师管理页面** (`TeacherManagement.vue`)
   - 需要根据角色设置筛选框的默认值和禁用状态
   - 需要获取当前用户的组织信息

### 2.2 需要检查的页面

1. **学生管理页面** (`StudentManagement.vue`)
   - 需要检查筛选框是否根据角色设置了默认值和禁用状态
   - 班主任应该只能看到管理的班级的学生

2. **班级管理页面** (`ClassManagement.vue`)
   - 需要检查筛选框是否根据角色设置了默认值和禁用状态
   - 学院负责人应该只能看到本学院的班级
   - 班主任应该只能看到管理的班级

3. **学院管理页面** (`CollegeManagement.vue`)
   - 需要检查筛选框是否根据角色设置了默认值和禁用状态
   - 学校管理员应该只能看到本学校的学院

4. **专业管理页面** (`MajorManagement.vue`)
   - 需要检查筛选框是否根据角色设置了默认值和禁用状态
   - 学院负责人应该只能看到本学院的专业

5. **实习计划管理页面** (`InternshipPlanManagement.vue`)
   - 需要检查筛选框是否根据角色设置了默认值和禁用状态
   - 学院负责人应该只能看到本学院的实习计划

## 三、技术实现方案

### 3.1 后端API设计

#### 3.1.1 获取当前用户组织信息接口

**接口路径**：`GET /user/current/org-info`

**返回数据**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "schoolId": 1,
    "schoolName": "XX大学",
    "collegeId": 2,
    "collegeName": "计算机学院",
    "classIds": [10, 11, 12],
    "classNames": ["计算机1班", "计算机2班", "计算机3班"]
  }
}
```

**实现逻辑**：
- 系统管理员：返回 null（不限制）
- 学校管理员：返回学校ID和学校名称
- 学院负责人：返回学校ID、学校名称、学院ID、学院名称
- 班主任：返回学校ID、学校名称、学院ID、学院名称、班级ID列表、班级名称列表

### 3.2 前端实现方案

#### 3.2.1 用户管理页面修改

1. **添加获取组织信息的API调用**
2. **在 `onMounted` 中获取当前用户的组织信息**
3. **根据角色设置筛选框的默认值和禁用状态**：
   ```javascript
   // 学校管理员
   if (hasRole('ROLE_SCHOOL_ADMIN')) {
     searchForm.schoolId = currentOrgInfo.schoolId
     // 学校下拉框禁用
     // 学院下拉框可选（本学校的所有学院）
   }
   
   // 学院负责人
   if (hasRole('ROLE_COLLEGE_LEADER')) {
     searchForm.schoolId = currentOrgInfo.schoolId
     searchForm.collegeId = currentOrgInfo.collegeId
     // 学校和学院下拉框禁用
     // 班级下拉框可选（本学院的所有班级）
   }
   
   // 班主任
   if (hasRole('ROLE_CLASS_TEACHER')) {
     searchForm.schoolId = currentOrgInfo.schoolId
     searchForm.collegeId = currentOrgInfo.collegeId
     // 学校和学院下拉框禁用
     // 班级下拉框可选（管理的多个班级，支持多选）
   }
   ```

#### 3.2.2 教师管理页面修改

类似用户管理页面，但不需要班级筛选框。

### 3.3 其他页面检查清单

#### 3.3.1 学生管理页面
- [ ] 检查筛选框是否根据角色设置了默认值和禁用状态
- [ ] 班主任的班级筛选框是否支持多选（管理的多个班级）

#### 3.3.2 班级管理页面
- [ ] 检查筛选框是否根据角色设置了默认值和禁用状态
- [ ] 学院负责人的学院筛选框是否禁用
- [ ] 班主任的班级筛选框是否只显示管理的班级

#### 3.3.3 学院管理页面
- [ ] 检查筛选框是否根据角色设置了默认值和禁用状态
- [ ] 学校管理员的学校筛选框是否禁用

#### 3.3.4 专业管理页面
- [ ] 检查筛选框是否根据角色设置了默认值和禁用状态
- [ ] 学院负责人的学院筛选框是否禁用

#### 3.3.5 实习计划管理页面
- [ ] 检查筛选框是否根据角色设置了默认值和禁用状态
- [ ] 学院负责人的学院筛选框是否禁用

## 四、详细实现步骤

### 4.1 第一步：创建后端API

1. 在 `UserController` 中添加 `getCurrentUserOrgInfo` 方法
2. 在 `UserService` 中添加 `getCurrentUserOrgInfo` 方法
3. 在 `UserServiceImpl` 中实现该方法，调用 `DataPermissionUtil` 获取组织信息

### 4.2 第二步：创建前端API

1. 在 `internship-web/src/api/user/user.js` 中添加 `getCurrentUserOrgInfo` 方法

### 4.3 第三步：修改用户管理页面

1. 在 `onMounted` 中调用 `getCurrentUserOrgInfo` 获取组织信息
2. 根据角色设置筛选框的默认值和禁用状态
3. 修改重置逻辑，重置时保持组织信息的绑定

### 4.4 第四步：修改教师管理页面

1. 在 `onMounted` 中调用 `getCurrentUserOrgInfo` 获取组织信息
2. 根据角色设置筛选框的默认值和禁用状态
3. 修改重置逻辑，重置时保持组织信息的绑定

### 4.5 第五步：检查并修改其他页面

按照检查清单逐一检查并修改其他管理页面。

## 五、代码示例

### 5.1 后端API实现

```java
@ApiOperation("获取当前用户组织信息")
@GetMapping("/current/org-info")
public Result<Map<String, Object>> getCurrentUserOrgInfo() {
    Map<String, Object> orgInfo = userService.getCurrentUserOrgInfo();
    return Result.success("查询成功", orgInfo);
}
```

```java
@Override
public Map<String, Object> getCurrentUserOrgInfo() {
    Map<String, Object> orgInfo = new HashMap<>();
    
    Long schoolId = dataPermissionUtil.getCurrentUserSchoolId();
    Long collegeId = dataPermissionUtil.getCurrentUserCollegeId();
    List<Long> classIds = dataPermissionUtil.getCurrentUserClassIds();
    
    if (schoolId != null) {
        School school = schoolMapper.selectById(schoolId);
        if (school != null) {
            orgInfo.put("schoolId", schoolId);
            orgInfo.put("schoolName", school.getSchoolName());
        }
    }
    
    if (collegeId != null) {
        College college = collegeMapper.selectById(collegeId);
        if (college != null) {
            orgInfo.put("collegeId", collegeId);
            orgInfo.put("collegeName", college.getCollegeName());
        }
    }
    
    if (classIds != null && !classIds.isEmpty()) {
        List<Class> classes = classMapper.selectBatchIds(classIds);
        orgInfo.put("classIds", classIds);
        orgInfo.put("classNames", classes.stream()
            .map(Class::getClassName)
            .collect(Collectors.toList()));
    }
    
    return orgInfo;
}
```

### 5.2 前端API实现

```javascript
// 获取当前用户组织信息
getCurrentUserOrgInfo() {
  return request.get('/user/current/org-info')
}
```

### 5.3 前端页面实现

```javascript
// 当前用户组织信息
const currentOrgInfo = ref({
  schoolId: null,
  schoolName: '',
  collegeId: null,
  collegeName: '',
  classIds: [],
  classNames: []
})

// 加载当前用户组织信息
const loadCurrentUserOrgInfo = async () => {
  try {
    const res = await userApi.getCurrentUserOrgInfo()
    if (res.code === 200 && res.data) {
      currentOrgInfo.value = res.data
      
      // 根据角色设置筛选框默认值
      if (hasRole('ROLE_SCHOOL_ADMIN')) {
        if (currentOrgInfo.value.schoolId) {
          searchForm.schoolId = currentOrgInfo.value.schoolId
        }
      } else if (hasRole('ROLE_COLLEGE_LEADER')) {
        if (currentOrgInfo.value.schoolId) {
          searchForm.schoolId = currentOrgInfo.value.schoolId
        }
        if (currentOrgInfo.value.collegeId) {
          searchForm.collegeId = currentOrgInfo.value.collegeId
        }
      } else if (hasRole('ROLE_CLASS_TEACHER')) {
        if (currentOrgInfo.value.schoolId) {
          searchForm.schoolId = currentOrgInfo.value.schoolId
        }
        if (currentOrgInfo.value.collegeId) {
          searchForm.collegeId = currentOrgInfo.value.collegeId
        }
      }
    }
  } catch (error) {
    console.error('获取组织信息失败:', error)
  }
}

// 计算属性：学校下拉框是否禁用
const isSchoolDisabled = computed(() => {
  return hasAnyRole(['ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER', 'ROLE_CLASS_TEACHER'])
})

// 计算属性：学院下拉框是否禁用
const isCollegeDisabled = computed(() => {
  return hasAnyRole(['ROLE_COLLEGE_LEADER', 'ROLE_CLASS_TEACHER'])
})
```

## 六、其他页面检查结果

### 6.1 学生管理页面 (`StudentManagement.vue`)
- **问题**：筛选框没有根据角色设置默认值和禁用状态
- **需要修改**：
  - 学校管理员：学校筛选框禁用，默认绑定学校
  - 班主任：学校和学院筛选框禁用，默认绑定学校和学院；班级筛选框支持多选，只显示管理的班级

### 6.2 班级管理页面 (`ClassManagement.vue`)
- **问题**：筛选框没有根据角色设置默认值和禁用状态
- **需要修改**：
  - 学校管理员：学校筛选框禁用，默认绑定学校
  - 学院负责人：学校和学院筛选框禁用，默认绑定学校和学院
  - 班主任：学校和学院筛选框禁用，默认绑定学校和学院；班级筛选框只显示管理的班级

### 6.3 学院管理页面 (`CollegeManagement.vue`)
- **问题**：筛选框没有根据角色设置默认值和禁用状态
- **需要修改**：
  - 学校管理员：学校筛选框禁用，默认绑定学校

### 6.4 专业管理页面 (`MajorManagement.vue`)
- **问题**：筛选框没有根据角色设置默认值和禁用状态
- **需要修改**：
  - 学校管理员：学校筛选框禁用，默认绑定学校
  - 学院负责人：学校和学院筛选框禁用，默认绑定学校和学院

### 6.5 实习计划管理页面 (`InternshipPlanManagement.vue`)
- **问题**：筛选框没有根据角色设置默认值和禁用状态
- **需要修改**：
  - 学校管理员：学校筛选框禁用，默认绑定学校
  - 学院负责人：学校和学院筛选框禁用，默认绑定学校和学院

## 七、实施优先级

1. **高优先级**（必须修改）：
   - 用户管理页面
   - 教师管理页面

2. **中优先级**（建议修改）：
   - 学生管理页面
   - 班级管理页面

3. **低优先级**（可选修改）：
   - 学院管理页面
   - 专业管理页面
   - 实习计划管理页面

## 八、注意事项

1. **数据权限**：后端已经实现了数据权限过滤，前端筛选框的设置主要是为了提升用户体验，避免用户选择无权限的数据
2. **重置逻辑**：重置筛选条件时，需要保持组织信息的绑定，不能清空
3. **班级多选**：班主任管理的班级筛选框应该支持多选，因为一个班主任可以管理多个班级
4. **默认加载**：页面加载时，应该自动根据角色设置筛选条件并加载数据

