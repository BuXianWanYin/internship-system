# 自主实习考勤设计说明

## 一、设计概述

根据方案一（基于申请类型的权限控制），自主实习学生的考勤管理流程如下：

### 1. 学生端考勤操作

**自主实习学生可以进行的考勤操作：**
- ✅ **上班打卡**：学生可以打卡上班（不需要考勤组）
- ✅ **下班打卡**：学生可以打卡下班
- ✅ **申请请假**：学生可以申请请假
- ✅ **选择休息**：学生可以选择休息日期

**与合作企业实习的区别：**
- ❌ **不需要考勤组**：自主实习学生不需要分配考勤组，可以直接打卡
- ❌ **不需要选择时间段**：自主实习学生打卡时不需要选择时间段（因为没有考勤组）

### 2. 考勤确认流程

**自主实习考勤确认：**
- 学生打卡后，考勤状态为 **待确认（PENDING）**
- 由 **班主任** 进行确认或拒绝
- 企业导师 **不显示** 自主实习学生的考勤记录（数据权限已过滤）

**合作企业实习考勤确认：**
- 学生打卡后，考勤状态为 **待确认（PENDING）**
- 由 **企业导师** 进行确认或拒绝
- 班主任可以查看，但 **不显示** 确认按钮

## 二、技术实现

### 1. 后端实现

#### 1.1 学生打卡逻辑

**文件：** `AttendanceServiceImpl.java`

**方法：** `studentCheckIn`、`studentCheckOut`、`studentApplyLeave`、`studentSelectRest`

**关键逻辑：**
```java
// 只有合作企业实习才需要考勤组
if (apply.getApplyType() != null && apply.getApplyType().equals(ApplyType.COOPERATION.getCode())) {
    group = attendanceGroupService.getGroupByApplyId(apply.getApplyId());
    // ... 考勤组相关逻辑
}
// 自主实习不需要考勤组，可以直接打卡
```

**考勤状态设置：**
- 所有学生打卡后，状态都设置为 `PENDING`（待确认）
- 确认权限根据申请类型判断：
  - 合作企业实习 → 企业导师确认
  - 自主实习 → 班主任确认

#### 1.2 数据权限过滤

**文件：** `AttendanceServiceImpl.java`

**方法：** `getAttendancePage`

**关键逻辑：**
```java
// 企业管理员或企业导师只能查看本企业的考勤（只包含合作企业实习）
if (currentUserEnterpriseId != null) {
    // 方式1：通过applyId关联查询，过滤企业ID（只包含合作企业实习）
    List<InternshipApply> applies = internshipApplyMapper.selectList(
        new LambdaQueryWrapper<InternshipApply>()
            .eq(InternshipApply::getEnterpriseId, currentUserEnterpriseId)
            .eq(InternshipApply::getApplyType, ApplyType.COOPERATION.getCode()) // 只查询合作企业实习
            .eq(InternshipApply::getDeleteFlag, DeleteFlag.NORMAL.getCode())
            .select(InternshipApply::getApplyId)
    );
    // ...
}
```

**说明：**
- 企业导师的数据权限过滤中，**只查询合作企业实习的申请**（`applyType = 1`）
- 自主实习的考勤记录（`applyType = 2`）**不会出现在企业导师的查询结果中**

#### 1.3 权限判断

**文件：** `AttendanceServiceImpl.java`

**方法：** `confirmAttendance`、`addAttendance`、`updateAttendance`、`deleteAttendance`

**关键逻辑：**
```java
if (apply.getApplyType() != null && apply.getApplyType().equals(ApplyType.COOPERATION.getCode())) {
    // 合作企业实习：企业管理员或企业导师只能确认本企业的考勤
    // ...
} else if (apply.getApplyType() != null && apply.getApplyType().equals(ApplyType.SELF.getCode())) {
    // 自主实习：班主任可以确认所管理班级学生的考勤
    // ...
}
```

### 2. 前端实现

#### 2.1 学生端考勤页面

**文件：** `internship-web/src/views/student/Attendance.vue`

**关键逻辑：**
- 学生打卡时，如果是自主实习，不需要选择时间段
- 时间段选择器只在有考勤组且时间段数量大于1时显示

#### 2.2 企业导师考勤管理页面

**文件：** `internship-web/src/views/enterprise/AttendanceManagement.vue`

**关键逻辑：**
```javascript
// 判断是否可以审核考勤
const canReview = (row) => {
  const authStore = useAuthStore()
  const roles = authStore.roles || []
  
  // 系统管理员和学校管理员可以审核所有
  if (roles.includes('ROLE_SYSTEM_ADMIN') || roles.includes('ROLE_SCHOOL_ADMIN')) {
    return true
  }
  
  // 如果没有申请类型信息，默认允许企业导师审核（兼容旧数据）
  if (row.applyType === null || row.applyType === undefined) {
    return roles.includes('ROLE_ENTERPRISE_MENTOR') || roles.includes('ROLE_ENTERPRISE_ADMIN')
  }
  
  // 根据申请类型判断
  if (row.applyType === 1) {
    // 合作企业实习：企业导师可以审核
    return roles.includes('ROLE_ENTERPRISE_MENTOR') || roles.includes('ROLE_ENTERPRISE_ADMIN')
  } else if (row.applyType === 2) {
    // 自主实习：班主任可以审核（企业导师不应该看到，但为了安全还是判断一下）
    return roles.includes('ROLE_CLASS_TEACHER')
  }
  
  return false
}
```

**说明：**
- 企业导师只能看到合作企业实习的考勤记录（后端已过滤）
- 如果数据中没有 `applyType` 字段（旧数据），默认允许企业导师审核（兼容性处理）

#### 2.3 班主任考勤管理页面

**文件：** `internship-web/src/views/teacher/Attendance.vue`

**关键逻辑：**
- 班主任可以查看所有学生的考勤（包括合作企业实习和自主实习）
- 但只能确认自主实习学生的考勤
- 合作企业实习的考勤不显示确认按钮（由企业导师确认）

## 三、数据流程

### 1. 学生打卡流程

```
学生打卡
  ↓
检查申请类型
  ↓
如果是合作企业实习 → 检查考勤组 → 选择时间段 → 打卡
如果是自主实习 → 直接打卡（不需要考勤组）
  ↓
创建/更新考勤记录
  ↓
设置状态为 PENDING（待确认）
  ↓
等待确认
```

### 2. 考勤确认流程

```
查看考勤记录
  ↓
检查申请类型
  ↓
如果是合作企业实习 → 企业导师确认
如果是自主实习 → 班主任确认
  ↓
更新确认状态
```

## 四、权限矩阵

| 角色 | 合作企业实习 | 自主实习 |
|------|------------|---------|
| **学生** | 可以打卡、请假、休息 | 可以打卡、请假、休息 |
| **企业导师** | ✅ 可以查看、确认、拒绝 | ❌ 不能查看（数据权限已过滤） |
| **企业管理员** | ✅ 可以查看、确认、拒绝 | ❌ 不能查看（数据权限已过滤） |
| **班主任** | ✅ 可以查看（不显示确认按钮） | ✅ 可以查看、确认、拒绝 |
| **系统管理员** | ✅ 可以查看、确认、拒绝 | ✅ 可以查看、确认、拒绝 |
| **学校管理员** | ✅ 可以查看、确认、拒绝 | ✅ 可以查看、确认、拒绝 |

## 五、注意事项

1. **数据权限过滤**：
   - 企业导师的数据权限过滤中，只查询合作企业实习的申请（`applyType = 1`）
   - 自主实习的考勤记录不会出现在企业导师的查询结果中

2. **考勤组**：
   - 自主实习学生不需要分配考勤组
   - 学生打卡时不需要选择时间段

3. **确认状态**：
   - 所有学生打卡后，状态都设置为 `PENDING`（待确认）
   - 确认权限根据申请类型判断

4. **兼容性**：
   - 如果数据中没有 `applyType` 字段（旧数据），前端默认允许企业导师审核（兼容性处理）

## 六、待优化点

1. **自主实习考勤确认**：
   - 当前设计：学生打卡后，由班主任确认
   - 可优化：考虑自主实习学生打卡后自动确认（无需审批）

2. **考勤组设计**：
   - 当前设计：自主实习不需要考勤组
   - 可优化：考虑为自主实习学生也提供考勤组功能（可选）

