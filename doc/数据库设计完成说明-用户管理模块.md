# 数据库设计完成说明 - 用户管理模块

## 已完成的工作

### 一、数据库连接

- ✅ 使用 `mcp_mysql_connect_db` 成功建立数据库连接
- ✅ 数据库：`internship_management_db`
- ✅ 连接信息：localhost:3306, root

### 二、创建的表结构

#### 2.1 用户基础表（user_info）
- ✅ 主键：user_id (BIGINT自增)
- ✅ 唯一约束：username（用户名）
- ✅ 字段：用户名、密码、真实姓名、身份证号、手机号、邮箱、头像等
- ✅ 索引：主键、唯一索引、状态索引、删除标志索引、手机号索引、邮箱索引

#### 2.2 角色信息表（role_info）
- ✅ 主键：role_id (BIGINT自增)
- ✅ 唯一约束：role_code（角色代码）
- ✅ 字段：角色代码、角色名称、角色描述等
- ✅ 已插入8种角色数据

#### 2.3 权限信息表（permission_info）
- ✅ 主键：permission_id (BIGINT自增)
- ✅ 唯一约束：permission_code（权限代码）
- ✅ 字段：权限代码、权限名称、权限类型、父权限ID等
- ✅ 已插入30个权限数据（系统管理25个 + 用户管理5个）

#### 2.4 用户角色关联表（user_role）
- ✅ 主键：id (BIGINT自增)
- ✅ 唯一约束：user_id + role_id（用户和角色组合唯一）
- ✅ 外键：user_id → user_info.user_id，role_id → role_info.role_id
- ✅ 支持一个用户拥有多个角色

#### 2.5 角色权限关联表（role_permission）
- ✅ 主键：id (BIGINT自增)
- ✅ 唯一约束：role_id + permission_id（角色和权限组合唯一）
- ✅ 外键：role_id → role_info.role_id，permission_id → permission_info.permission_id
- ✅ 系统管理员已分配所有30个权限

#### 2.6 学生信息表（student_info）
- ✅ 主键：student_id (BIGINT自增)
- ✅ 唯一约束：student_no（学号）、user_id（用户ID）
- ✅ 外键：user_id → user_info.user_id，class_id → class_info.class_id
- ✅ 冗余字段：major_id、college_id、school_id（提高查询性能）
- ✅ 字段：学号、所属班级、入学年份、毕业年份等

#### 2.7 教师信息表（teacher_info）
- ✅ 主键：teacher_id (BIGINT自增)
- ✅ 唯一约束：teacher_no（工号）、user_id（用户ID）
- ✅ 外键：user_id → user_info.user_id，college_id → college_info.college_id
- ✅ 冗余字段：school_id（提高查询性能）
- ✅ 字段：工号、所属学院、职称、部门等

#### 2.8 企业信息表（enterprise_info）
- ✅ 主键：enterprise_id (BIGINT自增)
- ✅ 唯一约束：enterprise_code（企业代码）、unified_social_credit_code（统一社会信用代码）
- ✅ 外键：user_id → user_info.user_id（ON DELETE SET NULL）
- ✅ 字段：企业名称、法人代表、注册资本、行业、地址、联系方式等
- ✅ 审核字段：audit_status（审核状态）、audit_opinion（审核意见）、audit_time（审核时间）、auditor_id（审核人ID）

#### 2.9 企业导师信息表（enterprise_mentor_info）
- ✅ 主键：mentor_id (BIGINT自增)
- ✅ 唯一约束：user_id（用户ID）
- ✅ 外键：user_id → user_info.user_id，enterprise_id → enterprise_info.enterprise_id
- ✅ 字段：导师姓名、职位、部门、联系方式等

### 三、外键约束完善

- ✅ 更新class_info表，添加class_teacher_id外键约束
- ✅ 所有外键约束已创建，确保数据完整性

### 四、初始数据

#### 4.1 角色数据（8种）
1. ROLE_SYSTEM_ADMIN - 系统管理员
2. ROLE_SCHOOL_ADMIN - 学校管理员
3. ROLE_COLLEGE_LEADER - 学院负责人
4. ROLE_CLASS_TEACHER - 班主任
5. ROLE_INSTRUCTOR - 指导教师
6. ROLE_ENTERPRISE_ADMIN - 企业管理员
7. ROLE_ENTERPRISE_MENTOR - 企业导师
8. ROLE_STUDENT - 学生

#### 4.2 权限数据（30个）
- 系统管理模块权限（25个）：
  - 学校管理：view、add、edit、delete
  - 学院管理：view、add、edit、delete
  - 专业管理：view、add、edit、delete
  - 班级管理：view、add、edit、delete、sharecode
  - 学期管理：view、add、edit、delete
  - 系统配置：view、add、edit、delete
- 用户管理模块权限（5个）：
  - 用户管理：view、add、edit、delete、resetPassword

#### 4.3 角色权限关联
- ✅ 系统管理员已分配所有30个权限

### 五、表结构特点

#### 5.1 符合开发规范
- ✅ 所有表使用 `utf8mb4` 字符集
- ✅ 所有表使用 `InnoDB` 存储引擎
- ✅ 所有表使用 `BIGINT` 自增主键
- ✅ 所有表包含软删除字段（delete_flag）
- ✅ 所有表包含创建时间、更新时间字段（DATETIME(6)）
- ✅ 时间字段支持微秒精度

#### 5.2 索引优化
- ✅ 所有主键创建主键索引
- ✅ 所有外键创建索引
- ✅ 唯一性约束字段创建唯一索引
- ✅ 常用查询字段（delete_flag、status）创建索引
- ✅ 复合唯一索引（user_id + role_id、role_id + permission_id）

#### 5.3 外键约束
- ✅ user_role.user_id → user_info.user_id
- ✅ user_role.role_id → role_info.role_id
- ✅ role_permission.role_id → role_info.role_id
- ✅ role_permission.permission_id → permission_info.permission_id
- ✅ student_info.user_id → user_info.user_id
- ✅ student_info.class_id → class_info.class_id
- ✅ teacher_info.user_id → user_info.user_id
- ✅ teacher_info.college_id → college_info.college_id
- ✅ enterprise_info.user_id → user_info.user_id（ON DELETE SET NULL）
- ✅ enterprise_mentor_info.user_id → user_info.user_id
- ✅ enterprise_mentor_info.enterprise_id → enterprise_info.enterprise_id
- ✅ class_info.class_teacher_id → user_info.user_id（ON DELETE SET NULL）

#### 5.4 软删除机制
- ✅ 所有表包含 `delete_flag` 字段
- ✅ `delete_flag = 0` 表示未删除
- ✅ `delete_flag = 1` 表示已删除
- ✅ 所有查询需要过滤已删除数据

## 六、表关系

```
user_info (用户基础表)
    │
    ├── student_info (学生表) → class_info (班级)
    │       └── 冗余字段：major_id, college_id, school_id
    │
    ├── teacher_info (教师表) → college_info (学院)
    │       └── 冗余字段：school_id
    │
    ├── enterprise_info (企业表)
    │       └── enterprise_mentor_info (企业导师表)
    │
    ├── user_role (用户角色关联) → role_info (角色表)
    │                                   │
    │                                   └── role_permission (角色权限关联) → permission_info (权限表)
    │
    └── class_info.class_teacher_id (班主任关联)
```

## 七、数据权限设计

### 7.1 权限范围
- **系统管理员**：可访问所有数据
- **学校管理员**：只能访问本校数据（自动过滤 school_id）
- **学院负责人**：只能访问本院数据（自动过滤 college_id）
- **班主任**：只能访问本班数据（自动过滤 class_id）
- **指导教师**：只能访问分配的学生数据
- **企业管理员**：只能访问本企业数据
- **企业导师**：只能访问本企业实习生数据
- **学生**：只能访问个人数据

### 7.2 实现方式
在Service层查询时，根据当前登录用户角色自动添加查询条件。

## 八、验证结果

### 8.1 表创建验证
- ✅ 所有9张表创建成功
- ✅ 表结构符合设计规范
- ✅ 索引创建成功
- ✅ 外键约束创建成功
- ✅ 初始数据插入成功

### 8.2 表列表
1. user_info - 用户基础信息表
2. role_info - 角色信息表
3. permission_info - 权限信息表
4. user_role - 用户角色关联表
5. role_permission - 角色权限关联表
6. student_info - 学生信息表
7. teacher_info - 教师信息表
8. enterprise_info - 企业信息表
9. enterprise_mentor_info - 企业导师信息表

### 8.3 数据验证
- ✅ 8种角色已插入
- ✅ 30个权限已插入
- ✅ 系统管理员已分配所有权限

## 九、后续工作

根据开发计划，下一步是：

### 9.1 用户注册与添加功能开发（第5周第2-3天）
- 创建User、Student、Teacher、Enterprise、EnterpriseMentor实体类
- 创建对应的Mapper、Service、Controller
- 实现企业自主注册功能
- 实现学生注册功能（两种方式：Excel批量导入、分享码自主注册）
- 实现教师添加功能
- 实现班主任任命功能

### 9.2 用户管理功能开发（第5周第4-5天）
- 实现用户信息查询、编辑
- 实现用户状态管理
- 实现密码重置功能
- 实现数据权限过滤

### 9.3 权限控制系统完善（第6周）
- 完善@PreAuthorize注解使用
- 实现数据权限过滤逻辑（Service层）
- 权限变更时更新用户会话
- 权限缓存机制（Redis）
- 前端权限控制

## 十、注意事项

1. **外键约束**：所有外键约束已创建，确保数据完整性
2. **数据权限**：所有查询必须实现数据权限过滤
3. **软删除**：所有删除操作使用软删除，只更新delete_flag
4. **冗余字段**：学生表和教师表包含冗余字段，用于提高查询性能
5. **企业审核**：企业注册后需要审核，审核通过后激活账号
6. **多角色支持**：一个用户可以有多个角色（通过user_role表关联）
7. **密码加密**：用户密码使用BCrypt加密存储
8. **角色权限**：系统管理员已分配所有权限，其他角色的权限分配待后续完善

## 十一、数据库设计文档

详细的数据库设计文档已保存在：`doc/数据库设计文档-用户管理模块.md`

包含：
- 完整的表结构设计
- 字段说明
- 索引设计
- 外键约束
- 业务规则
- 数据权限设计
- 初始数据说明

