# 实习管理系统优化方案文档

## 一、优化概述

本文档针对实习管理系统中的离职功能、权限控制和状态联动进行优化，提升系统的实用性和逻辑严谨性。

## 二、优化目标

1. **简化离职流程**：移除学生自主申请离职功能，改为由班主任进行解绑操作（管理员、学校负责人、学院负责人也有解绑权限）
2. **删除冗余状态**：删除"已离职"状态，通过解绑状态标识，简化状态管理
3. **完善解绑后数据操作**：解绑后更新相关数据表（面试表、学生表等），保留历史数据
4. **加强权限控制**：确保学生只有在有实习企业的情况下才能进行相关操作
5. **优化状态联动**：完善实习申请状态、学生实习状态、解绑状态的联动逻辑

---

## 三、详细优化方案

### 3.1 离职功能优化

#### 3.1.1 现状分析

**当前实现：**
- 学生可以自主申请离职
- 离职申请需要企业管理员和学校端两级审批
- 离职状态通过 `unbindStatus` 字段管理

**存在的问题：**
1. 学生自主申请离职不符合实际业务流程（学生离职后告知班主任，由班主任操作）
2. 离职申请流程复杂，增加了不必要的审批环节
3. 学生端需要维护离职申请相关功能，增加系统复杂度

#### 3.1.2 优化方案

**方案：移除学生自主申请离职功能，改为由班主任/管理员进行解绑操作**

**具体实现：**

1. **移除学生端离职申请功能**
   - 删除学生端的"申请离职"按钮和相关对话框
   - 删除 `applyUnbind` 接口的学生端调用
   - 保留学生查看离职信息的功能（只读）

2. **新增解绑功能（班主任为主，管理员辅助）**
   - 在实习申请审核页面、学生管理页面添加"解绑企业"操作
   - **主要操作者：班主任** - 学生离职后告知班主任，由班主任进行解绑操作
   - **辅助操作者（也有解绑权限）：**
     - 学院负责人：可以解绑本院学生的企业
     - 学校管理员：可以解绑本校学生的企业
     - 系统管理员：可以解绑所有学生的企业

3. **简化解绑流程**
   - 班主任/管理员直接执行解绑操作，无需审批流程
   - 解绑时记录操作人、操作时间、解绑原因（可选）
   - 解绑后自动更新相关状态

#### 3.1.3 数据库变更

**字段变更：**
- `unbind_status`: 简化为 `0-未解绑，2-已解绑`（移除申请中、企业审批等中间状态）
- `unbind_reason`: 保留，用于记录解绑原因
- `unbind_audit_user_id`: 改为 `unbind_operator_id`（解绑操作人ID）
- `unbind_audit_time`: 改为 `unbind_time`（解绑时间）
- `unbind_audit_opinion`: 改为 `unbind_remark`（解绑备注）

**状态枚举变更：**
- **删除 `InternshipApplyStatus.RESIGNED(6, "已离职")`** - 不再使用申请状态标识离职
- **删除 `StudentInternshipStatus.RESIGNED(2, "已离职")`** - 解绑后恢复为"未实习"状态
- 通过 `unbind_status = 2` 标识已解绑，申请状态保持为"已录用"

#### 3.1.4 接口变更

**删除接口：**
- `POST /internship/apply/{applyId}/unbind` - 学生申请离职

**修改接口：**
- `POST /internship/apply/{applyId}/unbind` - 改为解绑接口（班主任为主，管理员辅助）
  - 权限：`ROLE_CLASS_TEACHER, ROLE_COLLEGE_LEADER, ROLE_SCHOOL_ADMIN, ROLE_SYSTEM_ADMIN`
  - 参数：`applyId`（申请ID）、`reason`（解绑原因，可选）、`remark`（备注，可选）
  - 说明：班主任是主要操作者，其他角色在需要时也可以进行解绑操作

**新增接口：**
- `GET /internship/apply/unbind-history` - 查询解绑历史（可选）

---

### 3.2 权限控制优化

#### 3.2.1 现状分析

**当前实现：**
- 学生提交日志、周报、成果、问题反馈时，只验证申请是否属于当前学生
- 未验证学生是否有已确认上岗的实习企业
- 未区分合作企业实习和自主实习

**存在的问题：**
1. 学生可能在没有实习企业的情况下提交日志等数据
2. 未验证学生确认上岗状态
3. 未考虑自主实习的情况

#### 3.2.2 优化方案

**方案：统一权限检查，确保学生有已确认上岗的实习才能操作**

**权限检查规则：**

1. **检查条件（必须同时满足）：**
   - 学生必须有 `current_apply_id`（当前实习申请ID）
   - 申请状态必须为 `已录用`（`status = 3`）
   - 学生确认状态必须为 `已确认上岗`（`student_confirm_status = 1`）
   - 解绑状态不能为 `已解绑`（`unbind_status != 2`）
   - 学生实习状态必须为 `实习中`（`internship_status = 1`）

2. **适用功能：**
   - 提交/更新实习日志
   - 提交/更新周报
   - 提交/更新阶段性成果
   - 提交问题反馈
   - 考勤签到/签退
   - 请假申请

3. **统一权限检查方法：**
   ```java
   /**
    * 验证学生是否有有效的实习申请（已确认上岗且未离职）
    * @param studentId 学生ID
    * @return 有效的实习申请，如果不存在则抛出异常
    */
   private InternshipApply validateStudentActiveInternship(Long studentId) {
       Student student = studentMapper.selectById(studentId);
       if (student == null || student.getCurrentApplyId() == null) {
           throw new BusinessException("您当前没有实习企业，无法进行此操作");
       }
       
       InternshipApply apply = this.getById(student.getCurrentApplyId());
       if (apply == null) {
           throw new BusinessException("实习申请不存在");
       }
       
       // 验证申请状态
       if (!apply.getStatus().equals(InternshipApplyStatus.ACCEPTED.getCode())) {
           throw new BusinessException("您的实习申请尚未被录用，无法进行此操作");
       }
       
       // 验证学生确认状态
       if (apply.getStudentConfirmStatus() == null 
           || !apply.getStudentConfirmStatus().equals(StudentConfirmStatus.CONFIRMED.getCode())) {
           throw new BusinessException("您尚未确认上岗，无法进行此操作");
       }
       
       // 验证是否已解绑
       if (apply.getUnbindStatus() != null 
           && apply.getUnbindStatus().equals(UnbindStatus.UNBOUND.getCode())) {
           throw new BusinessException("您已与企业解绑，无法进行此操作");
       }
       
       return apply;
   }
   ```

4. **前端权限控制：**
   - 在相关页面加载时，调用 `getCurrentInternship` 接口检查
   - 如果没有有效的实习，隐藏或禁用相关操作按钮
   - 显示提示信息："您当前没有实习企业，无法进行此操作"

#### 3.2.3 涉及的服务类

需要在以下服务类中添加权限检查：

1. **InternshipLogServiceImpl** - 实习日志服务
   - `addLog()` - 提交日志
   - `updateLog()` - 更新日志

2. **WeeklyReportServiceImpl** - 周报服务
   - `addWeeklyReport()` - 提交周报
   - `updateWeeklyReport()` - 更新周报

3. **InternshipAchievementServiceImpl** - 成果服务
   - `addAchievement()` - 提交成果
   - `updateAchievement()` - 更新成果

4. **InternshipFeedbackServiceImpl** - 问题反馈服务
   - `addFeedback()` - 提交反馈

5. **AttendanceServiceImpl** - 考勤服务
   - `checkIn()` - 签到
   - `checkOut()` - 签退
   - `applyLeave()` - 请假

---

### 3.3 状态联动优化

#### 3.3.1 状态定义

**实习申请状态（InternshipApplyStatus）：**
- `0` - 待审核
- `1` - 已通过（学校审核通过，等待企业处理）
- `2` - 已拒绝（学校审核拒绝）
- `3` - 已录用（企业录用，学生可确认上岗）
- `4` - 已拒绝录用（企业拒绝录用）
- `5` - 已取消（学生取消申请）
- **注意：删除"已离职"状态，解绑后申请状态保持为"已录用"，通过解绑状态标识**

**学生确认状态（StudentConfirmStatus）：**
- `0` - 未确认
- `1` - 已确认上岗
- `2` - 已拒绝

**解绑状态（UnbindStatus）：**
- `0` - 未解绑
- `2` - 已解绑

**学生实习状态（StudentInternshipStatus）：**
- `0` - 未实习
- `1` - 实习中
- `3` - 已结束
- **注意：删除"已离职"状态，解绑后学生实习状态恢复为"未实习"**

**面试状态（InterviewStatus）：**
- `0` - 待确认
- `1` - 已确认
- `2` - 已完成
- `3` - 已取消

#### 3.3.2 状态流转规则

**1. 申请流程状态流转：**
```
待审核(0) 
  → 已通过(1) [学校审核通过]
    → 已录用(3) [企业录用]
      → 已确认上岗 [学生确认]
        → 实习中 [开始实习]
    → 已拒绝录用(4) [企业拒绝]
  → 已拒绝(2) [学校审核拒绝]
  → 已取消(5) [学生取消]
```

**2. 解绑流程状态流转：**
```
实习中 [已确认上岗]
  → 已解绑(2) [班主任/管理员解绑]
    → 申请状态保持为"已录用"(3)，解绑状态更新为"已解绑"(2)
    → 学生实习状态恢复为"未实习"(0)
    → 学生确认状态恢复为"未确认"(0)
    → 相关面试状态更新为"已取消"(3)
```

**3. 状态联动规则：**

| 操作 | 申请状态 | 学生确认状态 | 解绑状态 | 学生实习状态 |
|------|---------|-------------|---------|-------------|
| 学生确认上岗 | 3(已录用) | 0→1 | 0 | 0→1(实习中) |
| 班主任/管理员解绑 | 3(保持已录用) | 1→0 | 0→2 | 1→0(未实习) |
| 学生取消申请 | 0/1→5(已取消) | - | - | - |

#### 3.3.3 状态更新逻辑

**1. 学生确认上岗时：**
```java
// 更新申请
apply.setStudentConfirmStatus(StudentConfirmStatus.CONFIRMED.getCode());
apply.setStudentConfirmTime(LocalDateTime.now());
// 注意：申请状态保持为"已录用"，不更新

// 更新学生
student.setCurrentApplyId(applyId);
student.setCurrentEnterpriseId(apply.getEnterpriseId());
student.setInternshipStatus(StudentInternshipStatus.IN_PROGRESS.getCode());
```

**2. 班主任/管理员解绑时：**
```java
// ========== 1. 更新申请信息 ==========
// 注意：申请状态保持为"已录用"，不更新为"已离职"
apply.setUnbindStatus(UnbindStatus.UNBOUND.getCode());
apply.setStudentConfirmStatus(StudentConfirmStatus.NOT_CONFIRMED.getCode());
apply.setUnbindOperatorId(currentUserId);
apply.setUnbindTime(LocalDateTime.now());
apply.setUnbindReason(reason);
apply.setInternshipEndDate(LocalDate.now());
this.updateById(apply);

// ========== 2. 更新学生信息 ==========
student.setCurrentApplyId(null);
student.setCurrentEnterpriseId(null);
student.setInternshipStatus(StudentInternshipStatus.NOT_STARTED.getCode()); // 恢复为"未实习"
studentMapper.updateById(student);

// ========== 3. 更新相关面试记录 ==========
// 将该申请相关的所有未完成的面试状态更新为"已取消"
List<Interview> interviews = interviewMapper.selectList(
    new LambdaQueryWrapper<Interview>()
        .eq(Interview::getApplyId, applyId)
        .in(Interview::getStatus, 
            Arrays.asList(InterviewStatus.PENDING.getCode(), 
                         InterviewStatus.CONFIRMED.getCode()))
        .eq(Interview::getDeleteFlag, DeleteFlag.NORMAL.getCode())
);
for (Interview interview : interviews) {
    interview.setStatus(InterviewStatus.CANCELLED.getCode());
    interviewMapper.updateById(interview);
}

// ========== 4. 处理其他相关数据（可选） ==========
// 注意：日志、周报、成果、反馈等数据保留，不删除
// 学生解绑后无法继续提交新的数据，但历史数据保留用于记录和统计
```

**3. 学生取消申请时：**
```java
// 更新申请
apply.setStatus(InternshipApplyStatus.CANCELLED.getCode());

// 如果学生有当前申请，需要清空
if (student.getCurrentApplyId() != null && student.getCurrentApplyId().equals(applyId)) {
    student.setCurrentApplyId(null);
    student.setCurrentEnterpriseId(null);
    student.setInternshipStatus(StudentInternshipStatus.NOT_STARTED.getCode());
}
```

#### 3.3.4 状态查询优化

**1. 获取当前实习申请：**
```java
public InternshipApply getCurrentInternship() {
    // 获取学生信息
    Student student = getCurrentStudent();
    
    // 检查是否有当前申请
    if (student.getCurrentApplyId() == null) {
        return null;
    }
    
    // 查询申请
    InternshipApply apply = this.getById(student.getCurrentApplyId());
    
   // 验证申请有效性
   if (apply == null 
       || apply.getDeleteFlag().equals(DeleteFlag.DELETED.getCode())
       || !apply.getStudentId().equals(student.getStudentId())
       || (apply.getUnbindStatus() != null 
           && apply.getUnbindStatus().equals(UnbindStatus.UNBOUND.getCode()))
       || student.getInternshipStatus() == null
       || !student.getInternshipStatus().equals(StudentInternshipStatus.IN_PROGRESS.getCode())) {
       return null;
   }
    
    return apply;
}
```

**2. 判断学生是否有有效实习：**
```java
public boolean hasActiveInternship(Long studentId) {
    InternshipApply apply = getCurrentInternship();
    if (apply == null) {
        return false;
    }
    
   return apply.getStatus().equals(InternshipApplyStatus.ACCEPTED.getCode())
       && apply.getStudentConfirmStatus() != null
       && apply.getStudentConfirmStatus().equals(StudentConfirmStatus.CONFIRMED.getCode())
       && (apply.getUnbindStatus() == null 
           || !apply.getUnbindStatus().equals(UnbindStatus.UNBOUND.getCode()))
       && student.getInternshipStatus() != null
       && student.getInternshipStatus().equals(StudentInternshipStatus.IN_PROGRESS.getCode());
}
```

---

### 3.4 解绑后相关数据操作详细说明

#### 3.4.1 需要更新的数据表

解绑操作需要更新以下数据表：

| 数据表 | 字段 | 更新内容 | 说明 |
|--------|------|---------|------|
| **internship_apply** | `unbind_status` | `0` → `2` | 标记为已解绑 |
| | `student_confirm_status` | `1` → `0` | 恢复为未确认 |
| | `unbind_operator_id` | 设置操作人ID | 记录解绑操作人 |
| | `unbind_time` | 设置解绑时间 | 记录解绑时间 |
| | `unbind_reason` | 设置解绑原因 | 记录解绑原因 |
| | `internship_end_date` | 设置结束日期 | 记录实习结束日期 |
| | `status` | **保持不变** | 保持为"已录用"（不更新为"已离职"） |
| **student** | `current_apply_id` | 设置为 `NULL` | 清空当前申请ID |
| | `current_enterprise_id` | 设置为 `NULL` | 清空当前企业ID |
| | `internship_status` | `1` → `0` | 恢复为"未实习"（不更新为"已离职"） |
| **interview** | `status` | `0/1` → `3` | 未完成的面试改为"已取消" |
| | | **条件** | 仅更新 `status IN (0, 1)` 的面试记录 |

#### 3.4.2 保留的数据（不删除）

以下数据表的数据保留，不进行删除操作：
- **internship_log**（实习日志）：保留所有历史日志
- **weekly_report**（周报）：保留所有历史周报
- **internship_achievement**（成果）：保留所有历史成果
- **internship_feedback**（问题反馈）：保留所有历史反馈
- **attendance**（考勤）：保留所有历史考勤
- **evaluation**（评价）：保留所有历史评价

**原因：** 这些数据是历史记录，用于统计和分析，不应删除。

#### 3.4.3 解绑后权限控制

解绑后，学生无法继续操作以下功能：
- ❌ 提交/更新实习日志
- ❌ 提交/更新周报
- ❌ 提交/更新阶段性成果
- ❌ 提交问题反馈
- ❌ 考勤签到/签退
- ❌ 请假申请

但可以查看历史数据：
- ✅ 查看已提交的日志、周报、成果、反馈
- ✅ 查看历史考勤记录
- ✅ 查看评价记录
- ✅ 查看解绑信息

---

## 四、实施计划

### 4.1 第一阶段：离职功能优化（优先级：高）

**任务清单：**

1. **后端枚举修改：**
   - 删除 `InternshipApplyStatus.RESIGNED(6, "已离职")`
   - 删除 `StudentInternshipStatus.RESIGNED(2, "已离职")`
   - 修改 `UnbindStatus` 枚举，简化状态（移除申请中、企业审批等中间状态）
   - 更新枚举注释和文档

2. **后端代码修改：**
   - 删除学生端离职申请相关代码（`applyUnbind` 方法的学生端调用）
   - 修改解绑接口，改为管理员解绑（班主任为主，管理员辅助）
   - 修改解绑逻辑，移除审批流程
   - 实现解绑后相关数据更新：
     - 更新申请表的解绑状态和相关字段
     - 更新学生表的实习状态和关联字段（恢复为"未实习"）
     - 更新面试表的状态（未完成的面试改为"已取消"）
   - 删除所有对"已离职"状态的引用和判断
   - 更新权限检查方法，移除对"已离职"状态的判断
   - 更新 `getCurrentInternship` 方法，移除对"已离职"状态的判断

3. **前端代码修改：**
   - 删除学生端"申请离职"按钮和相关对话框
   - 删除前端对"已离职"状态的显示和判断
   - 更新状态显示逻辑（移除"已离职"状态）
   - 在管理页面添加解绑操作（班主任、学院负责人、学校管理员、系统管理员）
   - 更新状态文本映射（移除"已离职"相关文本）

4. **数据库迁移：**
   - 编写数据迁移脚本
   - 将 `unbind_status = 1` 或 `4` 的记录更新为 `0`（未解绑）
   - 将 `status = 6`（已离职）的申请状态更新为 `3`（已录用），并设置 `unbind_status = 2`
   - 将 `internship_status = 2`（已离职）的学生状态更新为 `0`（未实习），并清空 `current_apply_id` 和 `current_enterprise_id`

**预计工作量：** 3-4天

### 4.2 第二阶段：权限控制优化（优先级：高）

**任务清单：**
1. 在 `InternshipApplyService` 中添加统一权限检查方法 `validateStudentActiveInternship()`
2. 在各个服务类中添加权限检查调用：
   - `InternshipLogServiceImpl` - 日志服务
   - `WeeklyReportServiceImpl` - 周报服务
   - `InternshipAchievementServiceImpl` - 成果服务
   - `InternshipFeedbackServiceImpl` - 反馈服务
   - `AttendanceServiceImpl` - 考勤服务
3. 前端添加权限检查逻辑：
   - 页面加载时调用 `getCurrentInternship` 检查
   - 无有效实习时隐藏/禁用操作按钮
   - 显示友好提示信息
4. 测试各种场景（有实习/无实习、已确认/未确认、已解绑等）

**预计工作量：** 2-3天

### 4.3 第三阶段：状态联动优化（优先级：中）

**任务清单：**
1. 优化状态更新逻辑（确认上岗、解绑、取消申请）
2. 完善状态查询方法（`getCurrentInternship`、`hasActiveInternship`）
3. 添加状态一致性检查
4. 更新状态流转文档
5. 验证所有状态流转场景

**预计工作量：** 1-2天

---

## 五、测试要点

### 5.1 离职功能测试

1. **解绑功能测试：**
   - **班主任解绑测试**（主要操作者）：
     - 班主任解绑本班学生
     - 班主任无法解绑其他班级学生
   - **管理员解绑测试**（辅助操作者）：
     - 学院负责人解绑本院学生
     - 学校管理员解绑本校学生
     - 系统管理员解绑任意学生
   - **权限测试**：
     - 权限不足时拒绝操作
     - 验证各角色的数据权限范围

2. **状态更新测试：**
   - 解绑后申请状态保持为"已录用"（不更新为"已离职"）
   - 解绑后申请的解绑状态更新为"已解绑"
   - 解绑后学生实习状态恢复为"未实习"（不更新为"已离职"）
   - 解绑后学生 `current_apply_id` 清空
   - 解绑后学生 `current_enterprise_id` 清空
   - 解绑后学生确认状态恢复为"未确认"
   - 解绑后相关面试状态更新为"已取消"（仅未完成的面试）

3. **学生端测试：**
   - 学生无法申请离职
   - 学生可以查看离职信息（只读）

### 5.2 权限控制测试

1. **无实习企业测试：**
   - 学生无 `current_apply_id` 时，无法提交日志/周报/成果/反馈
   - 前端正确显示提示信息

2. **未确认上岗测试：**
   - 学生有申请但未确认上岗时，无法提交日志等
   - 前端正确显示提示信息

3. **已解绑测试：**
   - 学生已解绑后，无法提交日志等
   - 前端正确显示提示信息
   - 验证解绑状态判断逻辑

4. **正常实习测试：**
   - 学生已确认上岗且未解绑时，可以正常提交日志等
   - 学生实习状态为"实习中"时，可以正常操作

### 5.3 状态联动测试

1. **确认上岗测试：**
   - 确认上岗后，学生实习状态更新为"实习中"
   - 确认上岗后，`current_apply_id` 和 `current_enterprise_id` 正确设置

2. **解绑测试：**
   - 解绑后，所有相关状态正确更新
   - 解绑后，学生无法进行实习相关操作

3. **状态一致性测试：**
   - 申请状态、学生确认状态、解绑状态、学生实习状态保持一致
   - 不存在矛盾的状态组合
   - 解绑后所有相关状态正确更新

4. **解绑后数据完整性测试：**
   - 解绑后面试记录状态正确更新
   - 解绑后历史数据（日志、周报、成果、反馈）保留
   - 解绑后学生无法继续提交新数据

---

## 六、风险评估

### 6.1 数据迁移风险

**风险：** 
- 现有数据中可能有处于"申请中"状态的离职申请
- 现有数据中可能有 `status = 6`（已离职）的申请记录
- 现有数据中可能有 `internship_status = 2`（已离职）的学生记录

**应对：**
- **数据迁移脚本：**
  ```sql
  -- 1. 处理离职申请状态：将 unbind_status = 1 或 4 的记录更新为 0（未解绑）
  UPDATE internship_apply 
  SET unbind_status = 0 
  WHERE unbind_status IN (1, 4);
  
  -- 2. 处理已离职的申请：将 status = 6 的申请状态更新为 3（已录用），并设置 unbind_status = 2
  UPDATE internship_apply 
  SET status = 3, unbind_status = 2 
  WHERE status = 6;
  
  -- 3. 处理已离职的学生：将 internship_status = 2 的学生状态更新为 0（未实习）
  UPDATE student 
  SET internship_status = 0, current_apply_id = NULL, current_enterprise_id = NULL 
  WHERE internship_status = 2;
  ```

### 6.2 功能兼容性风险

**风险：** 
- 前端可能依赖离职申请功能
- 前端可能依赖"已离职"状态的显示和判断
- 后端代码中可能有对"已离职"状态的判断逻辑

**应对：**
- 全面检查前端代码，移除所有离职申请相关功能
- 全面检查前后端代码，删除所有对"已离职"状态的引用
- 更新API文档，明确接口变更
- 使用代码搜索工具查找所有 `RESIGNED`、`已离职` 的引用

### 6.3 用户体验风险

**风险：** 
- 学生可能不理解为什么不能申请离职
- 学生可能不理解解绑后状态的变化

**应对：**
- 在"我的实习"页面添加说明："如需离职，请联系班主任"
- 在相关页面添加友好的提示信息
- 说明班主任是主要操作者，其他管理员在必要时也可以协助
- 解绑后，在"我的实习"页面显示解绑信息，说明当前状态

---

## 七、解绑后相关数据操作说明

### 7.1 需要更新的数据表

解绑操作需要更新以下数据表：

1. **实习申请表（internship_apply）**
   - `unbind_status`: `0` → `2`（已解绑）
   - `student_confirm_status`: `1` → `0`（恢复为未确认）
   - `unbind_operator_id`: 记录解绑操作人ID
   - `unbind_time`: 记录解绑时间
   - `unbind_reason`: 记录解绑原因
   - `internship_end_date`: 记录实习结束日期
   - **注意：`status` 保持为 `3`（已录用），不更新**

2. **学生表（student）**
   - `current_apply_id`: 设置为 `NULL`
   - `current_enterprise_id`: 设置为 `NULL`
   - `internship_status`: `1`（实习中）→ `0`（未实习）
   - **注意：不更新为"已离职"状态**

3. **面试表（interview）**
   - 将该申请相关的所有未完成的面试状态更新为"已取消"
   - 查询条件：`apply_id = 申请ID` 且 `status IN (0, 1)`（待确认、已确认）
   - 更新：`status = 3`（已取消）
   - **注意：已完成的面试（status = 2）不更新，保留历史记录**

4. **其他数据表（保留，不删除）**
   - **实习日志表（internship_log）**：保留所有历史日志，不删除
   - **周报表（weekly_report）**：保留所有历史周报，不删除
   - **成果表（internship_achievement）**：保留所有历史成果，不删除
   - **问题反馈表（internship_feedback）**：保留所有历史反馈，不删除
   - **考勤表（attendance）**：保留所有历史考勤，不删除
   - **评价表（evaluation）**：保留所有历史评价，不删除

### 7.2 解绑后数据访问控制

解绑后，学生无法继续操作以下功能：
- 提交/更新实习日志
- 提交/更新周报
- 提交/更新阶段性成果
- 提交问题反馈
- 考勤签到/签退
- 请假申请

但可以查看历史数据：
- 查看已提交的日志、周报、成果、反馈
- 查看历史考勤记录
- 查看评价记录

### 7.3 解绑操作完整代码示例

```java
@Override
@Transactional(rollbackFor = Exception.class)
public boolean unbindInternship(Long applyId, String reason, String remark) {
    // 1. 验证申请
    InternshipApply apply = this.getById(applyId);
    EntityValidationUtil.validateEntityExists(apply, "申请");
    
    // 验证申请状态
    if (!apply.getStatus().equals(InternshipApplyStatus.ACCEPTED.getCode())) {
        throw new BusinessException("只有已录用的申请才能解绑");
    }
    
    // 验证是否已解绑
    if (apply.getUnbindStatus() != null 
        && apply.getUnbindStatus().equals(UnbindStatus.UNBOUND.getCode())) {
        throw new BusinessException("该申请已解绑");
    }
    
    // 验证权限
    checkUnbindPermission(apply);
    
    // 2. 获取当前用户
    Long currentUserId = dataPermissionUtil.getCurrentUserId();
    
    // 3. 更新申请信息
    apply.setUnbindStatus(UnbindStatus.UNBOUND.getCode());
    apply.setStudentConfirmStatus(StudentConfirmStatus.NOT_CONFIRMED.getCode());
    apply.setUnbindOperatorId(currentUserId);
    apply.setUnbindTime(LocalDateTime.now());
    apply.setUnbindReason(reason);
    apply.setUnbindRemark(remark);
    apply.setInternshipEndDate(LocalDate.now());
    // 注意：status 保持为 ACCEPTED，不更新
    this.updateById(apply);
    
    // 4. 更新学生信息
    Student student = studentMapper.selectById(apply.getStudentId());
    if (student != null) {
        student.setCurrentApplyId(null);
        student.setCurrentEnterpriseId(null);
        student.setInternshipStatus(StudentInternshipStatus.NOT_STARTED.getCode());
        studentMapper.updateById(student);
    }
    
    // 5. 更新相关面试记录
    List<Interview> interviews = interviewMapper.selectList(
        new LambdaQueryWrapper<Interview>()
            .eq(Interview::getApplyId, applyId)
            .in(Interview::getStatus, 
                Arrays.asList(InterviewStatus.PENDING.getCode(), 
                             InterviewStatus.CONFIRMED.getCode()))
            .eq(Interview::getDeleteFlag, DeleteFlag.NORMAL.getCode())
    );
    for (Interview interview : interviews) {
        interview.setStatus(InterviewStatus.CANCELLED.getCode());
        interviewMapper.updateById(interview);
    }
    
    return true;
}
```

---

## 八、后续优化建议

1. **解绑历史记录：** 可以考虑添加解绑历史记录表，记录所有解绑操作
2. **批量解绑：** 支持管理员批量解绑多个学生
3. **解绑原因统计：** 统计解绑原因，用于数据分析
4. **实习状态监控：** 添加实习状态异常监控，及时发现状态不一致问题
5. **数据归档：** 考虑对解绑后的历史数据进行归档处理

---

## 九、总结

本次优化主要解决了以下问题：

1. ✅ **简化离职流程**：移除学生自主申请，改为由班主任进行解绑操作（管理员、学校负责人、学院负责人也有解绑权限）

2. ✅ **删除冗余状态**：删除"已离职"状态，通过解绑状态标识，简化状态管理
   - 删除 `InternshipApplyStatus.RESIGNED`（申请状态不再有"已离职"）
   - 删除 `StudentInternshipStatus.RESIGNED`（学生实习状态不再有"已离职"）
   - 解绑后申请状态保持为"已录用"，通过 `unbind_status = 2` 标识
   - 解绑后学生实习状态恢复为"未实习"

3. ✅ **完善解绑后数据操作**：
   - 更新申请表的解绑状态和相关字段
   - 更新学生表的实习状态和关联字段
   - 更新面试表的状态（未完成的面试改为"已取消"）
   - 保留历史数据（日志、周报、成果、反馈等）

4. ✅ **加强权限控制**：确保学生有有效实习才能进行相关操作

5. ✅ **优化状态联动**：完善状态流转逻辑，确保状态一致性

优化后的系统更加符合实际业务流程，逻辑更加清晰，维护成本更低，状态管理更加简洁。

