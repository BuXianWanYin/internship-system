# 用户管理与筛选功能问题修复报告

## 一、问题概述

本报告记录了用户管理页面及其他相关页面的筛选功能问题和班级停用功能问题，并提供详细的修复方案。

## 二、问题清单

### 2.1 用户管理页面筛选功能问题

#### 问题1：缺少专业筛选字段
**问题描述**：
- 学校管理员和学院负责人在筛选用户时，应该能够先选择专业，再选择班级
- 当前筛选逻辑：学校 → 学院 → 班级（缺少专业层级）

**影响范围**：
- `internship-web/src/views/admin/UserManagement.vue`

**修复方案**：
1. 在筛选表单中添加"所属专业"下拉框
2. 调整筛选逻辑：学校 → 学院 → 专业 → 班级
3. 添加 `majorId` 到 `searchForm`
4. 添加 `majorList` 数据源
5. 添加 `loadMajorList` 方法
6. 添加 `handleMajorChange` 方法
7. 修改 `handleCollegeChange` 方法，清空专业和班级选择
8. 修改 `loadClassList` 方法，支持通过 `majorId` 筛选
9. 修改 `loadData` 方法，添加 `majorId` 参数
10. 修改 `handleReset` 方法，处理专业字段重置

#### 问题2：入学年份筛选应为下拉框
**问题描述**：
- 当前入学年份使用输入框，用户体验不佳
- 应该改为下拉框，提供常用年份选项

**影响范围**：
- `internship-web/src/views/admin/UserManagement.vue`

**修复方案**：
1. 将入学年份输入框改为下拉框（`el-select`）
2. 生成年份选项（例如：2020-2030年）
3. 添加 `enrollmentYear` 到 `searchForm`
4. 修改 `loadData` 方法，添加 `enrollmentYear` 参数
5. 修改 `handleReset` 方法，重置入学年份

**参考实现**：
- 参考 `StudentManagement.vue` 中的入学年份实现（但需要改为下拉框）

#### 问题3：角色筛选权限控制不正确
**问题描述**：
- 当前角色筛选下拉框显示所有角色，包括系统管理员
- 应该根据当前登录用户的角色，限制可筛选的角色范围：
  - 系统管理员：可以筛选所有角色
  - 学校管理员：不能筛选系统管理员，可以筛选其他角色
  - 学院负责人：不能筛选系统管理员、学校管理员，可以筛选其他角色
  - 班主任：不能筛选系统管理员、学校管理员、学院负责人，可以筛选其他角色

**影响范围**：
- `internship-web/src/views/admin/UserManagement.vue`
- 需要检查其他页面是否有类似问题

**修复方案**：
1. 创建 `filteredRoleListForSearch` 计算属性，过滤角色列表
2. 根据当前用户角色，排除不能筛选的角色：
   - 系统管理员：显示所有角色
   - 学校管理员：排除 `ROLE_SYSTEM_ADMIN`
   - 学院负责人：排除 `ROLE_SYSTEM_ADMIN`、`ROLE_SCHOOL_ADMIN`
   - 班主任：排除 `ROLE_SYSTEM_ADMIN`、`ROLE_SCHOOL_ADMIN`、`ROLE_COLLEGE_LEADER`
3. 在角色筛选下拉框中使用 `filteredRoleListForSearch` 而不是 `roleList`

**代码位置**：
- `UserManagement.vue` 第55-72行：角色筛选下拉框
- `UserManagement.vue` 第826-835行：`loadRoleList` 方法
- `UserManagement.vue` 第838-845行：`filteredRoleList` 计算属性（用于编辑对话框，需要新增一个用于筛选）

### 2.2 班级停用功能问题

#### 问题4：班级停用后状态未更新
**问题描述**：
- 班主任用户在班级管理页面点击"停用"后，提示"停用班级成功"
- 但实际班级状态仍然是"启用"，没有真正停用
- 后端只更新了 `deleteFlag`（软删除），没有更新 `status` 字段

**影响范围**：
- `internship-server/src/main/java/com/server/internshipserver/service/impl/system/ClassServiceImpl.java`
- `internship-server/src/main/java/com/server/internshipserver/controller/system/ClassController.java`

**问题分析**：
1. 后端 `deleteClass` 方法只设置了 `deleteFlag = 1`（软删除）
2. 没有设置 `status = 0`（停用状态）
3. 前端显示的状态是基于 `status` 字段，而不是 `deleteFlag`

**修复方案**：
1. 修改 `ClassServiceImpl.deleteClass` 方法：
   - 同时设置 `deleteFlag = 1`（软删除）
   - 同时设置 `status = 0`（停用状态）
2. 或者，如果"停用"和"删除"是两个不同的操作：
   - 创建 `disableClass` 方法：只设置 `status = 0`，不设置 `deleteFlag`
   - 保留 `deleteClass` 方法：设置 `deleteFlag = 1` 和 `status = 0`
   - 在 `ClassController` 中添加 `disableClass` 接口
   - 前端调用 `disableClass` 接口而不是 `deleteClass` 接口

**推荐方案**：
- 采用第二种方案，区分"停用"和"删除"操作
- "停用"：`status = 0`，`deleteFlag = 0`（数据保留，但不可用）
- "删除"：`status = 0`，`deleteFlag = 1`（数据软删除）

**代码位置**：
- `ClassServiceImpl.java` 第291-306行：`deleteClass` 方法
- `ClassController.java` 第72-79行：`deleteClass` 接口

### 2.3 其他页面检查

#### 问题5：其他页面角色筛选问题
**问题描述**：
- 需要检查其他管理页面是否也存在角色筛选权限控制问题

**需要检查的页面**：
1. `TeacherManagement.vue` - 教师管理
2. `StudentManagement.vue` - 学生管理（如果有角色筛选）
3. 其他可能有角色筛选的页面

**检查项**：
- 是否有角色筛选下拉框
- 是否根据当前用户角色过滤可选角色
- 是否排除了不应该显示的角色（如系统管理员）

## 三、修复优先级

| 优先级 | 问题编号 | 问题描述 | 影响范围 |
|--------|---------|---------|---------|
| P0 | 问题4 | 班级停用功能不生效 | 功能缺陷 |
| P1 | 问题1 | 缺少专业筛选字段 | 功能不完整 |
| P1 | 问题2 | 入学年份应为下拉框 | 用户体验 |
| P1 | 问题3 | 角色筛选权限控制 | 权限安全 |
| P2 | 问题5 | 其他页面检查 | 代码质量 |

## 四、详细修复方案

### 4.1 用户管理页面筛选功能修复

#### 4.1.1 添加专业筛选字段

**前端修改（UserManagement.vue）**：

1. **模板部分**（在"所属学院"和"所属班级"之间添加）：
```vue
<el-form-item label="所属专业">
  <el-select
    v-model="searchForm.majorId"
    placeholder="请选择专业"
    clearable
    style="width: 200px"
    :disabled="!searchForm.collegeId"
    @change="handleMajorChange"
  >
    <el-option
      v-for="major in majorList"
      :key="major.majorId"
      :label="major.majorName"
      :value="major.majorId"
    />
  </el-select>
</el-form-item>
```

2. **修改"所属班级"的禁用条件**：
```vue
:disabled="!searchForm.majorId"
```

3. **Script部分**：
```javascript
// 添加专业列表
const majorList = ref([])

// 修改 searchForm
const searchForm = reactive({
  // ... 其他字段
  majorId: null,  // 新增
  enrollmentYear: null  // 新增
})

// 添加加载专业列表方法
const loadMajorList = async (collegeId) => {
  try {
    const params = { current: 1, size: 1000 }
    if (collegeId) {
      params.collegeId = collegeId
    }
    const res = await majorApi.getMajorPage(params)
    if (res.code === 200) {
      majorList.value = res.data.records || []
    }
  } catch (error) {
    console.error('加载专业列表失败:', error)
  }
}

// 添加专业改变处理方法
const handleMajorChange = () => {
  // 清空班级选择
  searchForm.classId = null
  // 加载该专业下的班级列表
  if (searchForm.majorId) {
    loadClassList(null, null, searchForm.majorId)
  } else if (searchForm.collegeId) {
    loadClassList(searchForm.collegeId, null, null)
  } else if (searchForm.schoolId && hasAnyRole(['ROLE_SCHOOL_ADMIN'])) {
    loadClassList(null, searchForm.schoolId, null)
  } else {
    classList.value = []
  }
}

// 修改 handleCollegeChange 方法
const handleCollegeChange = () => {
  // 清空专业和班级选择
  searchForm.majorId = null
  searchForm.classId = null
  // 加载该学院下的专业列表
  if (searchForm.collegeId) {
    loadMajorList(searchForm.collegeId)
  } else {
    majorList.value = []
    classList.value = []
  }
}

// 修改 loadClassList 方法，支持 majorId 参数
const loadClassList = async (collegeId, schoolId, majorId) => {
  try {
    const params = { current: 1, size: 1000 }
    // 优先级：majorId > collegeId > schoolId
    if (majorId) {
      params.majorId = majorId
    } else if (collegeId) {
      params.collegeId = collegeId
    } else if (schoolId) {
      params.schoolId = schoolId
    }
    const res = await classApi.getClassPage(params)
    if (res.code === 200) {
      classList.value = res.data.records || []
    }
  } catch (error) {
    console.error('加载班级列表失败:', error)
  }
}

// 修改 loadData 方法，添加 majorId 和 enrollmentYear 参数
const loadData = async () => {
  loading.value = true
  try {
    const params = {
      // ... 其他参数
      majorId: searchForm.majorId || undefined,
      enrollmentYear: searchForm.enrollmentYear || undefined,
    }
    // ...
  } finally {
    loading.value = false
  }
}

// 修改 loadCurrentUserOrgInfo 方法，加载专业列表
const loadCurrentUserOrgInfo = async () => {
  // ... 现有代码
  if (hasAnyRole(['ROLE_COLLEGE_LEADER', 'ROLE_CLASS_TEACHER'])) {
    if (currentOrgInfo.value.collegeId) {
      searchForm.collegeId = currentOrgInfo.value.collegeId
      // 加载该学院的专业列表
      await loadMajorList(currentOrgInfo.value.collegeId)
    }
  }
  // ...
}

// 修改 handleReset 方法
const handleReset = () => {
  // ... 其他重置逻辑
  searchForm.majorId = null
  searchForm.enrollmentYear = null
  // 重新加载列表
  if (searchForm.collegeId) {
    loadMajorList(searchForm.collegeId)
  }
  // ...
}
```

#### 4.1.2 入学年份改为下拉框

**前端修改（UserManagement.vue）**：

```vue
<el-form-item label="入学年份">
  <el-select
    v-model="searchForm.enrollmentYear"
    placeholder="请选择入学年份"
    clearable
    style="width: 200px"
  >
    <el-option
      v-for="year in enrollmentYearOptions"
      :key="year"
      :label="`${year}年`"
      :value="year"
    />
  </el-select>
</el-form-item>
```

```javascript
// 添加入学年份选项
const enrollmentYearOptions = computed(() => {
  const currentYear = new Date().getFullYear()
  const years = []
  // 生成最近10年的选项（例如：2015-2025）
  for (let i = currentYear; i >= currentYear - 10; i--) {
    years.push(i)
  }
  return years
})
```

#### 4.1.3 角色筛选权限控制

**前端修改（UserManagement.vue）**：

```javascript
// 添加用于筛选的角色列表（排除不能筛选的角色）
const filteredRoleListForSearch = computed(() => {
  const currentRoles = getCurrentUserRoles()
  if (!currentRoles || currentRoles.length === 0) {
    return []
  }
  
  // 系统管理员：可以筛选所有角色
  if (currentRoles.includes('ROLE_SYSTEM_ADMIN')) {
    return roleList.value
  }
  
  // 学校管理员：不能筛选系统管理员
  if (currentRoles.includes('ROLE_SCHOOL_ADMIN')) {
    return roleList.value.filter(role => role.roleCode !== 'ROLE_SYSTEM_ADMIN')
  }
  
  // 学院负责人：不能筛选系统管理员、学校管理员
  if (currentRoles.includes('ROLE_COLLEGE_LEADER')) {
    return roleList.value.filter(role => 
      role.roleCode !== 'ROLE_SYSTEM_ADMIN' && 
      role.roleCode !== 'ROLE_SCHOOL_ADMIN'
    )
  }
  
  // 班主任：不能筛选系统管理员、学校管理员、学院负责人
  if (currentRoles.includes('ROLE_CLASS_TEACHER')) {
    return roleList.value.filter(role => 
      role.roleCode !== 'ROLE_SYSTEM_ADMIN' && 
      role.roleCode !== 'ROLE_SCHOOL_ADMIN' &&
      role.roleCode !== 'ROLE_COLLEGE_LEADER'
    )
  }
  
  // 其他角色：不能筛选任何角色
  return []
})
```

```vue
<!-- 修改角色筛选下拉框 -->
<el-option
  v-for="role in filteredRoleListForSearch"
  :key="role.roleCode"
  :label="role.roleName"
  :value="role.roleCode"
/>
```

### 4.2 班级停用功能修复

#### 4.2.1 后端修改

**方案一：修改现有 deleteClass 方法（简单方案）**

```java
// ClassServiceImpl.java
@Override
@Transactional(rollbackFor = Exception.class)
public boolean deleteClass(Long classId) {
    if (classId == null) {
        throw new BusinessException("班级ID不能为空");
    }
    
    Class classInfo = this.getById(classId);
    if (classInfo == null || classInfo.getDeleteFlag().equals(DeleteFlag.DELETED.getCode())) {
        throw new BusinessException("班级不存在");
    }
    
    // 同时设置删除标志和停用状态
    classInfo.setDeleteFlag(DeleteFlag.DELETED.getCode());
    classInfo.setStatus(0);  // 新增：设置停用状态
    return this.updateById(classInfo);
}
```

**方案二：区分停用和删除操作（推荐方案）**

```java
// ClassServiceImpl.java
/**
 * 停用班级（不删除数据）
 */
@Override
@Transactional(rollbackFor = Exception.class)
public boolean disableClass(Long classId) {
    if (classId == null) {
        throw new BusinessException("班级ID不能为空");
    }
    
    Class classInfo = this.getById(classId);
    if (classInfo == null || classInfo.getDeleteFlag().equals(DeleteFlag.DELETED.getCode())) {
        throw new BusinessException("班级不存在");
    }
    
    // 只设置停用状态，不删除数据
    classInfo.setStatus(0);
    return this.updateById(classInfo);
}

/**
 * 启用班级
 */
@Override
@Transactional(rollbackFor = Exception.class)
public boolean enableClass(Long classId) {
    if (classId == null) {
        throw new BusinessException("班级ID不能为空");
    }
    
    Class classInfo = this.getById(classId);
    if (classInfo == null || classInfo.getDeleteFlag().equals(DeleteFlag.DELETED.getCode())) {
        throw new BusinessException("班级不存在");
    }
    
    // 设置启用状态
    classInfo.setStatus(1);
    return this.updateById(classInfo);
}

/**
 * 删除班级（软删除）
 */
@Override
@Transactional(rollbackFor = Exception.class)
public boolean deleteClass(Long classId) {
    if (classId == null) {
        throw new BusinessException("班级ID不能为空");
    }
    
    Class classInfo = this.getById(classId);
    if (classInfo == null || classInfo.getDeleteFlag().equals(DeleteFlag.DELETED.getCode())) {
        throw new BusinessException("班级不存在");
    }
    
    // 软删除：同时设置删除标志和停用状态
    classInfo.setDeleteFlag(DeleteFlag.DELETED.getCode());
    classInfo.setStatus(0);
    return this.updateById(classInfo);
}
```

```java
// ClassService.java 接口
/**
 * 停用班级
 */
boolean disableClass(Long classId);

/**
 * 启用班级
 */
boolean enableClass(Long classId);
```

```java
// ClassController.java
@ApiOperation("停用班级")
@PreAuthorize("hasAnyRole('ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER', 'ROLE_CLASS_TEACHER')")
@PutMapping("/{id}/disable")
public Result<?> disableClass(
        @ApiParam(value = "班级ID", required = true) @PathVariable Long id) {
    classService.disableClass(id);
    return Result.success("停用班级成功");
}

@ApiOperation("启用班级")
@PreAuthorize("hasAnyRole('ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER', 'ROLE_CLASS_TEACHER')")
@PutMapping("/{id}/enable")
public Result<?> enableClass(
        @ApiParam(value = "班级ID", required = true) @PathVariable Long id) {
    classService.enableClass(id);
    return Result.success("启用班级成功");
}

@ApiOperation("删除班级")
@PreAuthorize("hasAnyRole('ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN')")
@DeleteMapping("/{id}")
public Result<?> deleteClass(
        @ApiParam(value = "班级ID", required = true) @PathVariable Long id) {
    classService.deleteClass(id);
    return Result.success("删除班级成功");
}
```

#### 4.2.2 前端修改

**方案一：修改现有调用（如果采用方案一）**

无需修改，后端已修复。

**方案二：修改为调用新接口（如果采用方案二）**

```javascript
// class.js API
// 停用班级
disableClass(id) {
  return request.put(`/system/class/${id}/disable`)
},
// 启用班级
enableClass(id) {
  return request.put(`/system/class/${id}/enable`)
},
// 删除班级（保留原有方法）
deleteClass(id) {
  return request.delete(`/system/class/${id}`)
}
```

```vue
<!-- ClassManagement.vue -->
<!-- 修改停用按钮的点击事件 -->
<el-button
  v-if="row.status === 1"
  type="danger"
  link
  size="small"
  @click="handleDisable(row)"
>
  停用
</el-button>
<el-button
  v-if="row.status === 0"
  type="success"
  link
  size="small"
  @click="handleEnable(row)"
>
  启用
</el-button>
```

```javascript
// ClassManagement.vue
const handleDisable = (row) => {
  ElMessageBox.confirm(
    `确定要停用班级 "${row.className}" 吗？`,
    '提示',
    {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning'
    }
  ).then(async () => {
    try {
      const res = await classApi.disableClass(row.classId)
      if (res.code === 200) {
        ElMessage.success('停用成功')
        loadData()
      }
    } catch (error) {
      const errorMessage = error.response?.data?.message || error.message || '停用失败'
      ElMessage.error(errorMessage)
    }
  }).catch(() => {})
}

const handleEnable = (row) => {
  ElMessageBox.confirm(
    `确定要启用班级 "${row.className}" 吗？`,
    '提示',
    {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning'
    }
  ).then(async () => {
    try {
      const res = await classApi.enableClass(row.classId)
      if (res.code === 200) {
        ElMessage.success('启用成功')
        loadData()
      }
    } catch (error) {
      const errorMessage = error.response?.data?.message || error.message || '启用失败'
      ElMessage.error(errorMessage)
    }
  }).catch(() => {})
}
```

### 4.3 其他页面检查

#### 4.3.1 检查清单

需要检查以下页面是否有角色筛选功能：

1. **TeacherManagement.vue**
   - 检查是否有角色筛选
   - 如果有，应用相同的权限控制逻辑

2. **StudentManagement.vue**
   - 检查是否有角色筛选
   - 如果有，应用相同的权限控制逻辑

3. **其他管理页面**
   - 检查是否有角色筛选
   - 如果有，应用相同的权限控制逻辑

## 五、测试验证

### 5.1 用户管理页面筛选功能测试

1. **专业筛选测试**：
   - 以学校管理员身份登录
   - 选择学校 → 选择学院 → 验证专业下拉框是否显示
   - 选择专业 → 验证班级下拉框是否根据专业筛选
   - 切换学院 → 验证专业和班级是否清空

2. **入学年份筛选测试**：
   - 验证入学年份下拉框是否显示
   - 选择年份 → 查询 → 验证结果是否正确

3. **角色筛选权限测试**：
   - 以系统管理员身份登录 → 验证可以筛选所有角色
   - 以学校管理员身份登录 → 验证不能筛选系统管理员
   - 以学院负责人身份登录 → 验证不能筛选系统管理员、学校管理员
   - 以班主任身份登录 → 验证不能筛选系统管理员、学校管理员、学院负责人

### 5.2 班级停用功能测试

1. **停用功能测试**：
   - 以班主任身份登录
   - 进入班级管理页面
   - 点击"停用"按钮
   - 验证提示"停用成功"
   - 验证班级状态是否变为"停用"
   - 刷新页面，验证状态是否持久化

2. **启用功能测试**（如果采用方案二）：
   - 点击"启用"按钮
   - 验证提示"启用成功"
   - 验证班级状态是否变为"启用"

## 六、修复时间估算

| 任务 | 预计时间 |
|------|---------|
| 添加专业筛选字段 | 2小时 |
| 入学年份改为下拉框 | 1小时 |
| 角色筛选权限控制 | 2小时 |
| 班级停用功能修复 | 3小时 |
| 其他页面检查与修复 | 2小时 |
| 测试验证 | 2小时 |
| **总计** | **12小时** |

## 七、注意事项

1. **数据兼容性**：
   - 确保后端API支持 `majorId` 和 `enrollmentYear` 参数
   - 确保数据库查询逻辑正确处理这些参数

2. **权限安全**：
   - 角色筛选权限控制必须严格，防止越权操作
   - 后端也需要验证角色分配权限

3. **用户体验**：
   - 筛选字段的禁用/启用逻辑要清晰
   - 下拉框选项要按合理顺序排列

4. **代码一致性**：
   - 参考 `StudentManagement.vue` 的实现
   - 保持代码风格一致

## 八、后续优化建议

1. **筛选条件保存**：
   - 可以考虑将筛选条件保存到 localStorage
   - 用户刷新页面后自动恢复筛选条件

2. **批量操作**：
   - 可以考虑添加批量停用/启用班级功能

3. **筛选条件导出**：
   - 可以考虑将筛选结果导出为Excel

---

**报告生成时间**：2025-11-25  
**报告版本**：v1.0

