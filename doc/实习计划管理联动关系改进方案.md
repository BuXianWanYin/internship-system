# 实习计划管理联动关系改进方案

## 一、总体方案概述

### 1.1 改进目标
1. **权限优化**：允许学院负责人创建自己学院的实习计划
2. 在数据库层面建立实习计划与实习申请的直接关联
3. 完善业务逻辑，实现计划发布后对学生申请的影响
4. 在前端实现计划选择、显示和验证功能
5. 实现评价管理从计划中获取考核标准

### 1.2 权限设计调整

#### 1.2.1 创建权限
- **系统管理员**：可以创建任意学校的实习计划
- **学校管理员**：可以创建本校的实习计划（全校性或指定学院/专业）
- **学院负责人**：只能创建本学院的实习计划（全院性或指定专业）
- **班主任**：❌ 无创建权限（同一专业不同班级的计划应该相同）

#### 1.2.2 审核权限
- 学院负责人创建的计划 → 由学校管理员审核
- 学校管理员创建的计划 → 由系统管理员审核（或自审）
- 系统管理员创建的计划 → 无需审核（或自审）

#### 1.2.3 数据权限
- 系统管理员：可以查看所有计划
- 学校管理员：只能查看本校的计划
- 学院负责人：只能查看本学院的计划（college_id 为 NULL 的除外，表示全校计划）
- 班主任：可以查看本学院的所有计划
- 学生：只能查看已发布的、匹配自己组织架构的计划

### 1.3 实施步骤
1. **第一阶段**：权限调整（允许学院负责人创建计划）
2. **第二阶段**：数据库结构改造
3. **第三阶段**：后端业务逻辑实现
4. **第四阶段**：前端功能实现
5. **第五阶段**：测试与优化

---

## 二、数据库改动方案

### 2.1 实习申请表添加 plan_id 字段

```sql
-- 1. 添加 plan_id 字段
ALTER TABLE internship_apply 
ADD COLUMN plan_id BIGINT NULL COMMENT '关联实习计划ID' AFTER user_id;

-- 2. 添加索引
ALTER TABLE internship_apply 
ADD INDEX idx_plan_id (plan_id);

-- 3. 添加外键约束（可选，如果不需要外键约束可以跳过）
-- ALTER TABLE internship_apply 
-- ADD CONSTRAINT fk_apply_plan FOREIGN KEY (plan_id) REFERENCES internship_plan(plan_id);
```

### 2.2 实习日志表添加 plan_id 字段（可选，用于直接关联）

```sql
-- 1. 添加 plan_id 字段
ALTER TABLE internship_log 
ADD COLUMN plan_id BIGINT NULL COMMENT '关联实习计划ID' AFTER apply_id;

-- 2. 添加索引
ALTER TABLE internship_log 
ADD INDEX idx_plan_id (plan_id);
```

**说明**：实习日志可以通过 `apply_id` 间接获取 `plan_id`，但直接添加字段可以提高查询效率。

### 2.3 数据迁移脚本（针对历史数据）

```sql
-- 为历史数据匹配实习计划（基于组织架构和时间范围）
-- 注意：这个脚本需要根据实际情况调整匹配逻辑

UPDATE internship_apply ia
INNER JOIN student s ON ia.student_id = s.student_id
INNER JOIN internship_plan ip ON (
    ip.school_id = s.school_id
    AND (ip.college_id IS NULL OR ip.college_id = s.college_id)
    AND (ip.major_id IS NULL OR ip.major_id = s.major_id)
    AND ip.status = 4  -- 已发布
    AND (
        (ia.internship_start_date IS NOT NULL AND ia.internship_start_date >= ip.start_date)
        OR (ia.internship_start_date IS NULL AND ia.create_time >= ip.publish_time)
    )
    AND (
        (ia.internship_end_date IS NOT NULL AND ia.internship_end_date <= ip.end_date)
        OR (ia.internship_end_date IS NULL)
    )
)
SET ia.plan_id = ip.plan_id
WHERE ia.plan_id IS NULL
AND ia.delete_flag = 0
LIMIT 1;  -- 如果匹配到多个计划，只取第一个（需要根据业务规则调整）

-- 为实习日志填充 plan_id（从申请中获取）
UPDATE internship_log il
INNER JOIN internship_apply ia ON il.apply_id = ia.apply_id
SET il.plan_id = ia.plan_id
WHERE il.plan_id IS NULL
AND ia.plan_id IS NOT NULL
AND il.delete_flag = 0;
```

---

## 三、后端改动方案

### 3.1 实体类修改

#### 3.1.1 InternshipApply.java 添加 planId 字段

```java
// 在 InternshipApply.java 中添加

@ApiModelProperty(value = "关联实习计划ID", example = "1")
@TableField("plan_id")
private Long planId;

// 添加关联字段（不映射到数据库，用于前端显示）
@ApiModelProperty(value = "实习计划名称")
@TableField(exist = false)
private String planName;

@ApiModelProperty(value = "实习计划编号")
@TableField(exist = false)
private String planCode;
```

#### 3.1.2 InternshipLog.java 添加 planId 字段（如果采用直接关联方案）

```java
// 在 InternshipLog.java 中添加

@ApiModelProperty(value = "关联实习计划ID", example = "1")
@TableField("plan_id")
private Long planId;

// 添加关联字段（不映射到数据库）
@ApiModelProperty(value = "实习计划名称")
@TableField(exist = false)
private String planName;
```

### 3.2 Service 层改动

#### 3.2.1 InternshipPlanService 新增方法

```java
// 在 InternshipPlanService.java 接口中添加

/**
 * 根据学生信息获取可用的实习计划列表
 * @param studentId 学生ID
 * @return 实习计划列表
 */
List<InternshipPlan> getAvailablePlansForStudent(Long studentId);

/**
 * 根据组织架构和时间范围查询已发布的实习计划
 * @param schoolId 学校ID
 * @param collegeId 学院ID（可选）
 * @param majorId 专业ID（可选）
 * @param currentDate 当前日期（用于判断计划是否有效）
 * @return 实习计划列表
 */
List<InternshipPlan> getPublishedPlans(Long schoolId, Long collegeId, Long majorId, LocalDate currentDate);
```

#### 3.2.2 InternshipPlanServiceImpl 实现新增方法

```java
// 在 InternshipPlanServiceImpl.java 中实现

@Override
public List<InternshipPlan> getAvailablePlansForStudent(Long studentId) {
    if (studentId == null) {
        throw new BusinessException("学生ID不能为空");
    }
    
    // 获取学生信息
    Student student = studentMapper.selectById(studentId);
    if (student == null || student.getDeleteFlag().equals(DeleteFlag.DELETED.getCode())) {
        throw new BusinessException("学生信息不存在");
    }
    
    // 查询已发布的、匹配组织架构的、在有效期内的实习计划
    LocalDate currentDate = LocalDate.now();
    return getPublishedPlans(
        student.getSchoolId(), 
        student.getCollegeId(), 
        student.getMajorId(), 
        currentDate
    );
}

@Override
public List<InternshipPlan> getPublishedPlans(Long schoolId, Long collegeId, Long majorId, LocalDate currentDate) {
    LambdaQueryWrapper<InternshipPlan> wrapper = new LambdaQueryWrapper<>();
    
    // 只查询已发布的计划
    wrapper.eq(InternshipPlan::getStatus, 4)  // 4-已发布
           .eq(InternshipPlan::getDeleteFlag, DeleteFlag.NORMAL.getCode());
    
    // 组织架构匹配
    if (schoolId != null) {
        wrapper.eq(InternshipPlan::getSchoolId, schoolId);
    }
    
    // 学院匹配：计划可以是全校的（college_id为NULL）或指定学院的
    if (collegeId != null) {
        wrapper.and(w -> w.isNull(InternshipPlan::getCollegeId)
                        .or()
                        .eq(InternshipPlan::getCollegeId, collegeId));
    }
    
    // 专业匹配：计划可以是全院的（major_id为NULL）或指定专业的
    if (majorId != null) {
        wrapper.and(w -> w.isNull(InternshipPlan::getMajorId)
                        .or()
                        .eq(InternshipPlan::getMajorId, majorId));
    }
    
    // 时间范围：当前日期在计划的有效期内
    if (currentDate != null) {
        wrapper.le(InternshipPlan::getStartDate, currentDate)
               .ge(InternshipPlan::getEndDate, currentDate);
    }
    
    // 按发布时间倒序
    wrapper.orderByDesc(InternshipPlan::getPublishTime);
    
    List<InternshipPlan> plans = this.list(wrapper);
    
    // 填充关联字段
    for (InternshipPlan plan : plans) {
        fillPlanRelatedFields(plan);
    }
    
    return plans;
}
```

#### 3.2.3 InternshipPlanServiceImpl 修改 addPlan 方法（权限调整）

```java
// 在 InternshipPlanServiceImpl.java 中修改 addPlan 方法

@Override
@Transactional(rollbackFor = Exception.class)
public InternshipPlan addPlan(InternshipPlan plan) {
    // 参数校验
    if (!StringUtils.hasText(plan.getPlanName())) {
        throw new BusinessException("实习计划名称不能为空");
    }
    if (!StringUtils.hasText(plan.getPlanCode())) {
        throw new BusinessException("实习计划编号不能为空");
    }
    if (plan.getStartDate() == null || plan.getEndDate() == null) {
        throw new BusinessException("实习开始日期和结束日期不能为空");
    }
    if (plan.getStartDate().isAfter(plan.getEndDate())) {
        throw new BusinessException("实习开始日期不能晚于结束日期");
    }
    
    // 获取当前登录用户信息
    String username = SecurityUtil.getCurrentUsername();
    UserInfo currentUser = null;
    if (username != null) {
        currentUser = userMapper.selectOne(
                new LambdaQueryWrapper<UserInfo>()
                        .eq(UserInfo::getUsername, username)
                        .eq(UserInfo::getDeleteFlag, DeleteFlag.NORMAL.getCode())
        );
        if (currentUser == null) {
            throw new BusinessException("用户不存在");
        }
    }
    
    // 权限和数据权限处理
    List<String> roles = currentUser != null ? 
        userMapper.selectRolesByUserId(currentUser.getUserId()) : new ArrayList<>();
    
    // 根据角色设置组织架构信息
    if (roles.contains("ROLE_COLLEGE_LEADER")) {
        // 学院负责人：只能创建本学院的计划
        Long currentUserCollegeId = dataPermissionUtil.getCurrentUserCollegeId();
        if (currentUserCollegeId == null) {
            throw new BusinessException("学院负责人必须关联学院");
        }
        
        // 自动设置学院ID，不允许修改
        plan.setCollegeId(currentUserCollegeId);
        
        // 自动设置学校ID（从学院获取）
        College college = collegeMapper.selectById(currentUserCollegeId);
        if (college == null) {
            throw new BusinessException("学院信息不存在");
        }
        plan.setSchoolId(college.getSchoolId());
        
        // 学院负责人创建的计划，专业ID可以为NULL（表示全院）或指定专业
        // 如果指定了专业，需要验证专业是否属于本学院
        if (plan.getMajorId() != null) {
            Major major = majorMapper.selectById(plan.getMajorId());
            if (major == null || !major.getCollegeId().equals(currentUserCollegeId)) {
                throw new BusinessException("专业不属于当前学院");
            }
        }
    } else if (roles.contains("ROLE_SCHOOL_ADMIN")) {
        // 学校管理员：可以创建全校性或指定学院/专业的计划
        Long currentUserSchoolId = dataPermissionUtil.getCurrentUserInfoSchoolId();
        if (currentUserSchoolId == null) {
            throw new BusinessException("学校管理员必须关联学校");
        }
        
        // 自动设置学校ID
        plan.setSchoolId(currentUserSchoolId);
        
        // 如果指定了学院，需要验证学院是否属于本校
        if (plan.getCollegeId() != null) {
            College college = collegeMapper.selectById(plan.getCollegeId());
            if (college == null || !college.getSchoolId().equals(currentUserSchoolId)) {
                throw new BusinessException("学院不属于当前学校");
            }
        }
        
        // 如果指定了专业，需要验证专业是否属于指定的学院
        if (plan.getMajorId() != null) {
            Major major = majorMapper.selectById(plan.getMajorId());
            if (major == null) {
                throw new BusinessException("专业不存在");
            }
            if (plan.getCollegeId() != null && !major.getCollegeId().equals(plan.getCollegeId())) {
                throw new BusinessException("专业不属于指定的学院");
            }
            if (plan.getCollegeId() == null) {
                // 如果学院为NULL，需要验证专业所属学院是否属于本校
                College majorCollege = collegeMapper.selectById(major.getCollegeId());
                if (majorCollege == null || !majorCollege.getSchoolId().equals(currentUserSchoolId)) {
                    throw new BusinessException("专业所属学院不属于当前学校");
                }
            }
        }
    } else if (roles.contains("ROLE_SYSTEM_ADMIN")) {
        // 系统管理员：可以创建任意学校的计划
        if (plan.getSchoolId() == null) {
            throw new BusinessException("所属学校ID不能为空");
        }
        // 验证学校是否存在
        School school = schoolMapper.selectById(plan.getSchoolId());
        if (school == null) {
            throw new BusinessException("学校不存在");
        }
        
        // 如果指定了学院，验证学院是否属于指定的学校
        if (plan.getCollegeId() != null) {
            College college = collegeMapper.selectById(plan.getCollegeId());
            if (college == null || !college.getSchoolId().equals(plan.getSchoolId())) {
                throw new BusinessException("学院不属于指定的学校");
            }
        }
        
        // 如果指定了专业，验证专业是否属于指定的学院
        if (plan.getMajorId() != null) {
            Major major = majorMapper.selectById(plan.getMajorId());
            if (major == null) {
                throw new BusinessException("专业不存在");
            }
            if (plan.getCollegeId() != null && !major.getCollegeId().equals(plan.getCollegeId())) {
                throw new BusinessException("专业不属于指定的学院");
            }
        }
    } else {
        throw new BusinessException("无权限创建实习计划");
    }
    
    // 检查计划编号是否已存在
    LambdaQueryWrapper<InternshipPlan> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(InternshipPlan::getPlanCode, plan.getPlanCode())
           .eq(InternshipPlan::getDeleteFlag, DeleteFlag.NORMAL.getCode());
    InternshipPlan existPlan = this.getOne(wrapper);
    if (existPlan != null) {
        throw new BusinessException("实习计划编号已存在");
    }
    
    // 设置默认值
    if (plan.getStatus() == null) {
        plan.setStatus(0); // 默认草稿
    }
    plan.setDeleteFlag(DeleteFlag.NORMAL.getCode());
    
    // 设置创建人ID
    if (currentUser != null) {
        plan.setCreateUserId(currentUser.getUserId());
    }
    
    // 保存
    this.save(plan);
    return plan;
}
```

#### 3.2.4 InternshipPlanServiceImpl 修改 updatePlan 方法（权限调整）

```java
// 在 InternshipPlanServiceImpl.java 中修改 updatePlan 方法

@Override
@Transactional(rollbackFor = Exception.class)
public InternshipPlan updatePlan(InternshipPlan plan) {
    if (plan.getPlanId() == null) {
        throw new BusinessException("实习计划ID不能为空");
    }
    
    // 检查计划是否存在
    InternshipPlan existPlan = this.getById(plan.getPlanId());
    if (existPlan == null || existPlan.getDeleteFlag().equals(DeleteFlag.DELETED.getCode())) {
        throw new BusinessException("实习计划不存在");
    }
    
    // 如果状态为已发布，不允许修改
    if (existPlan.getStatus() != null && existPlan.getStatus() == 4) {
        throw new BusinessException("已发布的实习计划不允许修改");
    }
    
    // 权限检查：只有创建者或更高级别的管理员可以修改
    String username = SecurityUtil.getCurrentUsername();
    UserInfo currentUser = null;
    if (username != null) {
        currentUser = userMapper.selectOne(
                new LambdaQueryWrapper<UserInfo>()
                        .eq(UserInfo::getUsername, username)
                        .eq(UserInfo::getDeleteFlag, DeleteFlag.NORMAL.getCode())
        );
    }
    
    if (currentUser != null) {
        List<String> roles = userMapper.selectRolesByUserId(currentUser.getUserId());
        
        // 系统管理员和学校管理员可以修改所有计划
        boolean canModify = roles.contains("ROLE_SYSTEM_ADMIN") || 
                           roles.contains("ROLE_SCHOOL_ADMIN");
        
        // 学院负责人只能修改自己创建的计划
        if (!canModify && roles.contains("ROLE_COLLEGE_LEADER")) {
            if (!existPlan.getCreateUserId().equals(currentUser.getUserId())) {
                throw new BusinessException("只能修改自己创建的实习计划");
            }
            
            // 学院负责人不能修改组织架构信息
            if (plan.getSchoolId() != null && !plan.getSchoolId().equals(existPlan.getSchoolId())) {
                throw new BusinessException("不能修改计划的学校");
            }
            if (plan.getCollegeId() != null && !plan.getCollegeId().equals(existPlan.getCollegeId())) {
                throw new BusinessException("不能修改计划的学院");
            }
        }
        
        if (!canModify && !roles.contains("ROLE_COLLEGE_LEADER")) {
            throw new BusinessException("无权限修改实习计划");
        }
    }
    
    // 如果修改了计划编号，检查新编号是否已存在
    if (StringUtils.hasText(plan.getPlanCode()) 
            && !plan.getPlanCode().equals(existPlan.getPlanCode())) {
        LambdaQueryWrapper<InternshipPlan> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(InternshipPlan::getPlanCode, plan.getPlanCode())
               .ne(InternshipPlan::getPlanId, plan.getPlanId())
               .eq(InternshipPlan::getDeleteFlag, DeleteFlag.NORMAL.getCode());
        InternshipPlan codeExistPlan = this.getOne(wrapper);
        if (codeExistPlan != null) {
            throw new BusinessException("实习计划编号已存在");
        }
    }
    
    // 更新
    this.updateById(plan);
    return this.getById(plan.getPlanId());
}
```

#### 3.2.5 InternshipApplyService 修改申请方法

```java
// 在 InternshipApplyServiceImpl.java 中修改 addCooperationApply 方法

@Override
@Transactional(rollbackFor = Exception.class)
public InternshipApply addCooperationApply(InternshipApply apply) {
    // ... 原有的参数校验代码 ...
    
    // 新增：验证实习计划
    if (apply.getPlanId() != null) {
        InternshipPlan plan = internshipPlanService.getById(apply.getPlanId());
        if (plan == null || plan.getDeleteFlag().equals(DeleteFlag.DELETED.getCode())) {
            throw new BusinessException("实习计划不存在");
        }
        
        // 验证计划状态：必须是已发布
        if (plan.getStatus() == null || plan.getStatus() != 4) {
            throw new BusinessException("只能选择已发布的实习计划");
        }
        
        // 验证组织架构匹配
        if (!plan.getSchoolId().equals(student.getSchoolId())) {
            throw new BusinessException("实习计划与学生的学校不匹配");
        }
        if (plan.getCollegeId() != null && !plan.getCollegeId().equals(student.getCollegeId())) {
            throw new BusinessException("实习计划与学生的学院不匹配");
        }
        if (plan.getMajorId() != null && !plan.getMajorId().equals(student.getMajorId())) {
            throw new BusinessException("实习计划与学生的专业不匹配");
        }
        
        // 验证时间范围：如果申请中指定了实习时间，需要验证是否在计划范围内
        if (apply.getInternshipStartDate() != null) {
            if (apply.getInternshipStartDate().isBefore(plan.getStartDate())) {
                throw new BusinessException("实习开始日期不能早于计划的开始日期");
            }
        }
        if (apply.getInternshipEndDate() != null) {
            if (apply.getInternshipEndDate().isAfter(plan.getEndDate())) {
                throw new BusinessException("实习结束日期不能晚于计划的结束日期");
            }
        }
        
        // 如果申请中没有指定实习时间，使用计划的时间范围
        if (apply.getInternshipStartDate() == null) {
            apply.setInternshipStartDate(plan.getStartDate());
        }
        if (apply.getInternshipEndDate() == null) {
            apply.setInternshipEndDate(plan.getEndDate());
        }
    } else {
        // 如果没有选择计划，尝试自动匹配
        List<InternshipPlan> availablePlans = internshipPlanService.getAvailablePlansForStudent(student.getStudentId());
        if (!availablePlans.isEmpty()) {
            // 如果有匹配的计划，使用第一个（或者提示用户选择）
            // 这里可以根据业务需求决定是自动选择还是要求用户选择
            // 建议：要求用户必须选择，所以这里抛出异常
            throw new BusinessException("请选择实习计划");
        }
    }
    
    // ... 原有的保存逻辑 ...
    
    // 保存后，填充计划信息
    if (apply.getPlanId() != null) {
        InternshipPlan plan = internshipPlanService.getById(apply.getPlanId());
        if (plan != null) {
            apply.setPlanName(plan.getPlanName());
            apply.setPlanCode(plan.getPlanCode());
        }
    }
    
    return apply;
}

// 同样修改 addSelfApply 方法
@Override
@Transactional(rollbackFor = Exception.class)
public InternshipApply addSelfApply(InternshipApply apply) {
    // ... 类似的验证逻辑 ...
}
```

#### 3.2.4 InternshipApplyService 修改查询方法，填充计划信息

```java
// 在 InternshipApplyServiceImpl.java 中修改查询方法

private void fillApplyRelatedFields(InternshipApply apply) {
    // ... 原有的填充逻辑 ...
    
    // 新增：填充实习计划信息
    if (apply.getPlanId() != null) {
        InternshipPlan plan = internshipPlanService.getById(apply.getPlanId());
        if (plan != null) {
            apply.setPlanName(plan.getPlanName());
            apply.setPlanCode(plan.getPlanCode());
        }
    }
}
```

### 3.3 Controller 层改动

#### 3.3.1 InternshipPlanController 修改权限和新增接口

```java
// 在 InternshipPlanController.java 中修改

// 修改创建权限：允许学院负责人创建
@ApiOperation("创建实习计划")
@PreAuthorize("hasAnyRole('ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER')")
@PostMapping
public Result<InternshipPlan> addPlan(@RequestBody InternshipPlan plan) {
    InternshipPlan result = internshipPlanService.addPlan(plan);
    return Result.success("创建实习计划成功", result);
}

// 修改更新权限：允许学院负责人更新自己创建的计划
@ApiOperation("更新实习计划")
@PreAuthorize("hasAnyRole('ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER')")
@PutMapping
public Result<InternshipPlan> updatePlan(@RequestBody InternshipPlan plan) {
    InternshipPlan result = internshipPlanService.updatePlan(plan);
    return Result.success("更新实习计划成功", result);
}

// 修改审核权限：学院负责人创建的计划由学校管理员审核
@ApiOperation("审核实习计划")
@PreAuthorize("hasAnyRole('ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN')")
@PostMapping("/{planId}/audit")
public Result<?> auditPlan(
        @ApiParam(value = "计划ID", required = true) @PathVariable Long planId,
        @ApiParam(value = "审核状态（2-已通过，3-已拒绝）", required = true) @RequestParam Integer auditStatus,
        @ApiParam(value = "审核意见", required = false) @RequestParam(required = false) String auditOpinion) {
    internshipPlanService.auditPlan(planId, auditStatus, auditOpinion);
    return Result.success("审核成功");
}

// 新增：获取学生可用的实习计划列表
@ApiOperation("获取学生可用的实习计划列表")
@PreAuthorize("hasRole('ROLE_STUDENT')")
@GetMapping("/available")
public Result<List<InternshipPlan>> getAvailablePlans() {
    // 获取当前登录学生信息
    String username = SecurityUtil.getCurrentUsername();
    UserInfo user = userMapper.selectOne(
        new LambdaQueryWrapper<UserInfo>()
            .eq(UserInfo::getUsername, username)
            .eq(UserInfo::getDeleteFlag, DeleteFlag.NORMAL.getCode())
    );
    
    if (user == null) {
        return Result.error("用户不存在");
    }
    
    Student student = studentMapper.selectOne(
        new LambdaQueryWrapper<Student>()
            .eq(Student::getUserId, user.getUserId())
            .eq(Student::getDeleteFlag, DeleteFlag.NORMAL.getCode())
    );
    
    if (student == null) {
        return Result.error("学生信息不存在");
    }
    
    List<InternshipPlan> plans = internshipPlanService.getAvailablePlansForStudent(student.getStudentId());
    return Result.success(plans);
}
```

#### 3.3.2 InternshipApplyController 修改接口

```java
// 在 InternshipApplyController.java 中，确保返回的申请信息包含计划信息
// 这个已经在 Service 层的 fillApplyRelatedFields 方法中处理了
```

---

## 四、前端改动方案

### 4.1 API 接口定义

#### 4.1.1 修改 internship/plan.js

```javascript
// 在 internship-web/src/api/internship/plan.js 中添加

// 获取学生可用的实习计划列表
getAvailablePlans() {
  return request.get('/internship/plan/available')
}
```

### 4.2 实习申请页面改动

#### 4.2.1 合作企业申请表单添加计划选择

```vue
<!-- 在 internship-web/src/views/student/InternshipApply.vue 中修改 -->

<template>
  <!-- 申请岗位对话框 -->
  <el-dialog
    v-model="applyPostDialogVisible"
    title="申请岗位"
    width="600px"
    :close-on-click-modal="false"
  >
    <el-form
      ref="applyPostFormRef"
      :model="applyPostForm"
      :rules="applyPostFormRules"
      label-width="120px"
    >
      <!-- 新增：选择实习计划 -->
      <el-form-item label="实习计划" prop="planId" required>
        <el-select
          v-model="applyPostForm.planId"
          placeholder="请选择实习计划"
          style="width: 100%"
          @change="handlePlanChange"
        >
          <el-option
            v-for="plan in availablePlans"
            :key="plan.planId"
            :label="`${plan.planName} (${plan.planCode})`"
            :value="plan.planId"
          >
            <div>
              <div>{{ plan.planName }}</div>
              <div style="font-size: 12px; color: #999;">
                {{ formatDate(plan.startDate) }} ~ {{ formatDate(plan.endDate) }}
              </div>
            </div>
          </el-option>
        </el-option>
        <el-empty v-if="availablePlans.length === 0" description="暂无可用的实习计划" />
      </el-form-item>
      
      <!-- 显示计划详情 -->
      <el-form-item v-if="selectedPlan" label="计划详情">
        <el-card shadow="never" style="margin-top: 10px;">
          <div v-if="selectedPlan.planOutline">
            <h4>实习大纲：</h4>
            <div v-html="selectedPlan.planOutline" style="margin-bottom: 10px;"></div>
          </div>
          <div v-if="selectedPlan.taskRequirements">
            <h4>任务要求：</h4>
            <div v-html="selectedPlan.taskRequirements" style="margin-bottom: 10px;"></div>
          </div>
          <div v-if="selectedPlan.assessmentStandards">
            <h4>考核标准：</h4>
            <div v-html="selectedPlan.assessmentStandards"></div>
          </div>
        </el-card>
      </el-form-item>
      
      <!-- 原有的其他表单项 -->
      <el-form-item label="岗位名称">
        <el-input v-model="applyPostForm.postName" disabled />
      </el-form-item>
      <!-- ... 其他字段 ... -->
      
      <!-- 实习时间（根据计划自动填充，可手动调整） -->
      <el-form-item label="实习开始日期" prop="internshipStartDate">
        <el-date-picker
          v-model="applyPostForm.internshipStartDate"
          type="date"
          placeholder="选择开始日期"
          style="width: 100%"
          :disabled-date="(date) => disabledStartDate(date)"
        />
      </el-form-item>
      <el-form-item label="实习结束日期" prop="internshipEndDate">
        <el-date-picker
          v-model="applyPostForm.internshipEndDate"
          type="date"
          placeholder="选择结束日期"
          style="width: 100%"
          :disabled-date="(date) => disabledEndDate(date)"
        />
      </el-form-item>
    </el-form>
    
    <template #footer>
      <el-button @click="applyPostDialogVisible = false">取消</el-button>
      <el-button type="primary" :loading="applyPostLoading" @click="handleSubmitApplyPost">
        提交申请
      </el-button>
    </template>
  </el-dialog>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue'
import { planApi } from '@/api/internship/plan'
// ... 其他导入 ...

// 新增：可用计划列表
const availablePlans = ref([])
const selectedPlan = ref(null)
const loadingPlans = ref(false)

// 修改：申请表单
const applyPostForm = reactive({
  planId: null,  // 新增
  enterpriseId: null,
  postId: null,
  enterpriseName: '',
  postName: '',
  applyReason: '',
  internshipStartDate: null,  // 新增
  internshipEndDate: null,    // 新增
  resumeAttachment: ''
})

// 新增：表单验证规则
const applyPostFormRules = {
  planId: [
    { required: true, message: '请选择实习计划', trigger: 'change' }
  ],
  internshipStartDate: [
    { required: true, message: '请选择实习开始日期', trigger: 'change' }
  ],
  internshipEndDate: [
    { required: true, message: '请选择实习结束日期', trigger: 'change' }
  ],
  applyReason: [
    { required: true, message: '请输入申请理由', trigger: 'blur' }
  ]
}

// 新增：加载可用计划列表
const loadAvailablePlans = async () => {
  loadingPlans.value = true
  try {
    const res = await planApi.getAvailablePlans()
    if (res.code === 200) {
      availablePlans.value = res.data || []
      if (availablePlans.value.length === 0) {
        ElMessage.warning('当前没有可用的实习计划，请联系管理员')
      }
    } else {
      ElMessage.error(res.message || '加载实习计划失败')
    }
  } catch (error) {
    ElMessage.error('加载实习计划失败：' + (error.message || '未知错误'))
  } finally {
    loadingPlans.value = false
  }
}

// 新增：计划选择变化处理
const handlePlanChange = (planId) => {
  selectedPlan.value = availablePlans.value.find(p => p.planId === planId)
  if (selectedPlan.value) {
    // 自动填充实习时间
    applyPostForm.internshipStartDate = selectedPlan.value.startDate
    applyPostForm.internshipEndDate = selectedPlan.value.endDate
  }
}

// 新增：禁用开始日期（不能早于计划开始日期，不能晚于计划结束日期）
const disabledStartDate = (date) => {
  if (!selectedPlan.value) return false
  const planStart = new Date(selectedPlan.value.startDate)
  const planEnd = new Date(selectedPlan.value.endDate)
  return date < planStart || date > planEnd
}

// 新增：禁用结束日期（不能早于开始日期，不能晚于计划结束日期）
const disabledEndDate = (date) => {
  if (!selectedPlan.value) return false
  const planStart = new Date(selectedPlan.value.startDate)
  const planEnd = new Date(selectedPlan.value.endDate)
  if (applyPostForm.internshipStartDate) {
    const startDate = new Date(applyPostForm.internshipStartDate)
    return date < startDate || date > planEnd
  }
  return date < planStart || date > planEnd
}

// 修改：打开申请对话框时加载计划列表
const handleApply = (row) => {
  applyPostForm.enterpriseId = row.enterpriseId
  applyPostForm.postId = row.postId
  applyPostForm.enterpriseName = row.enterpriseName || ''
  applyPostForm.postName = row.postName
  applyPostForm.planId = null
  applyPostForm.applyReason = ''
  applyPostForm.internshipStartDate = null
  applyPostForm.internshipEndDate = null
  selectedPlan.value = null
  resumeFileList.value = []
  resumeAttachmentUrls.value = []
  
  // 加载可用计划
  loadAvailablePlans()
  
  applyPostDialogVisible.value = true
}

// 修改：提交申请
const handleSubmitApplyPost = async () => {
  if (!applyPostFormRef.value) return
  
  try {
    await applyPostFormRef.value.validate()
    applyPostLoading.value = true
    
    const res = await applyApi.addCooperationApply({
      planId: applyPostForm.planId,
      enterpriseId: applyPostForm.enterpriseId,
      postId: applyPostForm.postId,
      applyReason: applyPostForm.applyReason,
      resumeAttachment: applyPostForm.resumeAttachment,
      internshipStartDate: applyPostForm.internshipStartDate,
      internshipEndDate: applyPostForm.internshipEndDate
    })
    
    if (res.code === 200) {
      ElMessage.success('申请提交成功')
      applyPostDialogVisible.value = false
      loadApplyList()
    } else {
      ElMessage.error(res.message || '申请提交失败')
    }
  } catch (error) {
    if (error.message && !error.message.includes('validation')) {
      ElMessage.error('申请提交失败：' + (error.message || '未知错误'))
    }
  } finally {
    applyPostLoading.value = false
  }
}

// 同样修改自主实习申请表单
// ... 类似的改动 ...
</script>
```

### 4.3 实习申请详情页面显示计划信息

```vue
<!-- 在申请详情对话框中添加计划信息显示 -->

<el-descriptions-item label="实习计划" :span="2">
  <div v-if="applyDetailData.planName">
    <div>{{ applyDetailData.planName }}</div>
    <div style="font-size: 12px; color: #999;">{{ applyDetailData.planCode }}</div>
  </div>
  <span v-else>-</span>
</el-descriptions-item>
```

### 4.4 实习日志/周报页面显示计划要求

```vue
<!-- 在 internship-web/src/views/student/InternshipLog.vue 中修改 -->

<template>
  <PageLayout>
    <!-- 新增：显示关联的实习计划信息 -->
    <el-card v-if="currentPlan" style="margin-bottom: 20px;">
      <template #header>
        <div class="card-header">
          <span>实习计划：{{ currentPlan.planName }}</span>
        </div>
      </template>
      <div v-if="currentPlan.taskRequirements">
        <h4>任务要求：</h4>
        <div v-html="currentPlan.taskRequirements"></div>
      </div>
      <div v-if="currentPlan.assessmentStandards" style="margin-top: 10px;">
        <h4>考核标准：</h4>
        <div v-html="currentPlan.assessmentStandards"></div>
      </div>
    </el-card>
    
    <!-- 原有的日志列表 -->
    <!-- ... -->
  </PageLayout>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { planApi } from '@/api/internship/plan'
import { applyApi } from '@/api/internship/apply'

const currentPlan = ref(null)

// 加载当前实习的计划信息
const loadCurrentPlan = async () => {
  try {
    // 获取当前学生的实习申请
    const applyRes = await applyApi.getApplyPage({
      current: 1,
      size: 1,
      status: 1  // 已通过
    })
    
    if (applyRes.code === 200 && applyRes.data.records.length > 0) {
      const apply = applyRes.data.records[0]
      if (apply.planId) {
        const planRes = await planApi.getPlanById(apply.planId)
        if (planRes.code === 200) {
          currentPlan.value = planRes.data
        }
      }
    }
  } catch (error) {
    console.error('加载实习计划失败：', error)
  }
}

onMounted(() => {
  loadCurrentPlan()
})
</script>
```

### 4.5 评价管理页面从计划获取考核标准

```vue
<!-- 在评价管理页面中 -->

<script setup>
// 加载评价指标时，从实习计划中获取
const loadEvaluationIndicators = async (applyId) => {
  try {
    // 获取申请信息
    const applyRes = await applyApi.getApplyById(applyId)
    if (applyRes.code === 200 && applyRes.data.planId) {
      // 获取计划信息
      const planRes = await planApi.getPlanById(applyRes.data.planId)
      if (planRes.code === 200) {
        const plan = planRes.data
        // 解析计划中的考核标准，转换为评价指标
        // 这里需要根据考核标准的格式来解析
        // 例如：如果考核标准是富文本，可能需要解析其中的结构化内容
        // 或者考核标准本身就是结构化的JSON格式
      }
    }
  } catch (error) {
    console.error('加载评价指标失败：', error)
  }
}
</script>
```

---

## 五、测试方案

### 5.1 数据库测试
1. 验证字段添加成功
2. 验证索引创建成功
3. 验证数据迁移正确

### 5.2 后端测试
1. 单元测试：测试计划匹配逻辑
2. 接口测试：测试新增和修改的接口
3. 集成测试：测试完整的申请流程

### 5.3 前端测试
1. 功能测试：测试计划选择、显示、验证
2. UI测试：测试界面显示和交互
3. 兼容性测试：测试不同浏览器的兼容性

---

## 六、实施时间表

### 6.1 第一阶段（1-2天）
- 数据库结构改造
- 数据迁移脚本执行
- 验证数据完整性

### 6.3 第三阶段（3-5天）
- 后端实体类修改
- Service层业务逻辑实现（申请验证、计划匹配等）
- Controller层接口实现（新增获取可用计划接口）
- 单元测试

### 6.4 第四阶段（3-5天）
- 前端API接口定义
- 申请页面改造（添加计划选择）
- 详情页面改造（显示计划信息）
- 日志/周报页面改造（显示计划要求）
- 前端路由权限调整（允许学院负责人访问计划管理页面）

### 6.5 第五阶段（2-3天）
- 集成测试
- Bug修复
- 性能优化
- 文档更新

**总计：约10-17个工作日**

---

## 七、注意事项

### 7.1 数据迁移
- 历史数据迁移需要仔细验证匹配逻辑
- 建议先在测试环境执行，验证无误后再在生产环境执行
- 对于无法匹配的历史数据，需要人工处理或标记

### 7.2 向后兼容
- 如果 `plan_id` 字段允许为 NULL，需要处理没有计划的情况
- 前端需要兼容没有计划信息的旧数据

### 7.3 权限控制
- 确保学生只能看到和选择自己可用的计划
- 确保计划信息的访问权限正确

### 7.4 性能优化
- 计划列表查询需要添加适当的索引
- 前端可以考虑缓存计划列表，减少请求次数

---

## 八、前端路由和菜单权限调整

### 8.1 路由权限调整

```javascript
// 在 internship-web/src/router/modules/internship.js 中修改

{
  path: '/admin/internship/plan',
  name: 'InternshipPlanManagement',
  component: () => import('@/views/admin/InternshipPlanManagement.vue'),
  meta: {
    title: '实习计划管理',
    requiresAuth: true,
    roles: ['ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER']  // 新增 ROLE_COLLEGE_LEADER
  }
}
```

### 8.2 菜单显示调整

需要在菜单配置中，为学院负责人角色添加"实习计划管理"菜单项。

### 8.3 前端页面权限控制

在 `InternshipPlanManagement.vue` 中，需要根据角色显示不同的操作按钮：
- **学院负责人**：只能看到"创建"、"编辑"（自己创建的）、"提交审核"按钮
- **学校管理员**：可以看到"创建"、"编辑"、"审核"、"发布"按钮
- **系统管理员**：可以看到所有按钮

**实现示例**：
```vue
<template>
  <div>
    <!-- 创建按钮：所有有权限的角色都可以看到 -->
    <el-button v-if="canCreate" type="primary" @click="handleCreate">创建计划</el-button>
    
    <!-- 编辑按钮：只有创建者或更高级别的管理员可以看到 -->
    <el-button v-if="canEdit(row)" @click="handleEdit(row)">编辑</el-button>
    
    <!-- 审核按钮：只有学校管理员和系统管理员可以看到 -->
    <el-button v-if="canAudit" @click="handleAudit(row)">审核</el-button>
    
    <!-- 发布按钮：只有学校管理员和系统管理员可以看到 -->
    <el-button v-if="canPublish" @click="handlePublish(row)">发布</el-button>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { useAuthStore } from '@/store/modules/auth'

const authStore = useAuthStore()

// 权限判断
const canCreate = computed(() => {
  const roles = authStore.roles || []
  return roles.includes('ROLE_SYSTEM_ADMIN') || 
         roles.includes('ROLE_SCHOOL_ADMIN') || 
         roles.includes('ROLE_COLLEGE_LEADER')
})

const canAudit = computed(() => {
  const roles = authStore.roles || []
  return roles.includes('ROLE_SYSTEM_ADMIN') || 
         roles.includes('ROLE_SCHOOL_ADMIN')
})

const canPublish = computed(() => {
  const roles = authStore.roles || []
  return roles.includes('ROLE_SYSTEM_ADMIN') || 
         roles.includes('ROLE_SCHOOL_ADMIN')
})

// 判断是否可以编辑某条记录
const canEdit = (row) => {
  const roles = authStore.roles || []
  const currentUserId = authStore.userInfo?.userId
  
  // 系统管理员和学校管理员可以编辑所有计划
  if (roles.includes('ROLE_SYSTEM_ADMIN') || roles.includes('ROLE_SCHOOL_ADMIN')) {
    return true
  }
  
  // 学院负责人只能编辑自己创建的计划
  if (roles.includes('ROLE_COLLEGE_LEADER')) {
    return row.createUserId === currentUserId && row.status === 0  // 只能编辑草稿状态的自己创建的计划
  }
  
  return false
}
</script>
```

## 九、后续优化建议

1. **计划版本管理**：如果计划需要修改，考虑版本管理机制
2. **计划模板**：提供计划模板功能，便于快速创建
3. **计划统计**：统计每个计划下的学生数量、完成情况等
4. **计划提醒**：计划发布后，自动通知相关学生
5. **计划对比**：允许学生对比不同计划的差异
6. **计划复制**：支持复制已有计划，修改后创建新计划

