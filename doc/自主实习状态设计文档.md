# 自主实习状态设计文档

## 一、设计目标

为自主实习申请设计独立的状态体系，与合作企业实习状态分离，使状态更清晰、更符合自主实习的业务流程。

## 二、状态定义

### 2.1 自主实习状态枚举

```java
public enum SelfInternshipApplyStatus {
    /**
     * 待审核
     * 学生提交自主实习申请后，等待班主任审核
     */
    PENDING(10, "待审核"),
    
    /**
     * 审核通过（实习中）
     * 班主任审核通过后，自动确认上岗，学生开始实习
     * 注意：自主实习审核通过后自动确认，无需学生手动确认
     */
    APPROVED_IN_PROGRESS(11, "实习中"),
    
    /**
     * 审核拒绝
     * 班主任审核拒绝
     */
    REJECTED(12, "审核拒绝"),
    
    /**
     * 实习结束
     * 实习到期或学生主动离职
     */
    COMPLETED(13, "实习结束"),
    
    /**
     * 已取消
     * 学生取消申请
     */
    CANCELLED(14, "已取消");
}
```

### 2.2 状态码范围

- **合作企业实习状态**：0-9（保持现有状态码）
- **自主实习状态**：10-19（新状态码范围）

### 2.3 状态转换流程

```
学生提交自主实习申请
  ↓
状态：待审核(10)
  ↓
班主任审核
  ├─ 通过 → 状态：实习中(11) [自动确认上岗，更新学生状态]
  └─ 拒绝 → 状态：审核拒绝(12)
  ↓
实习中(11)
  ├─ 实习到期 → 状态：实习结束(13)
  └─ 学生离职 → 状态：实习结束(13)
  ↓
学生取消申请（仅待审核状态可取消）
  ↓
状态：已取消(14)
```

## 三、数据库设计

### 3.1 状态存储

继续使用 `internship_apply.status` 字段存储状态码，但根据 `apply_type` 字段区分状态含义：

- `apply_type = 1`（合作企业）：使用 0-9 的状态码
- `apply_type = 2`（自主实习）：使用 10-19 的状态码

### 3.2 状态映射关系

| 自主实习状态 | 状态码 | 对应合作企业状态 | 说明 |
|------------|--------|----------------|------|
| 待审核 | 10 | 待审核(0) | 学生提交申请后 |
| 实习中 | 11 | 已录用(3) | 审核通过，自动确认上岗 |
| 审核拒绝 | 12 | 已拒绝(2) | 班主任审核拒绝 |
| 实习结束 | 13 | - | 实习到期或离职 |
| 已取消 | 14 | 已取消(5) | 学生取消申请 |

## 四、代码实现

### 4.1 创建自主实习状态枚举

创建 `SelfInternshipApplyStatus.java` 枚举类。

### 4.2 修改状态文本构建逻辑

在 `InternshipApplyServiceImpl` 中：
- 修改 `buildSelfApplyStatusText()` 方法，使用新的状态枚举
- 修改 `buildStatusText()` 方法，根据 `applyType` 和状态码范围判断使用哪个状态枚举

### 4.3 修改状态转换逻辑

- **审核通过**：将状态设置为 `11`（实习中），而不是 `3`（已录用）
- **审核拒绝**：将状态设置为 `12`（审核拒绝），而不是 `2`（已拒绝）
- **取消申请**：将状态设置为 `14`（已取消），而不是 `5`（已取消）
- **离职/结束**：将状态设置为 `13`（实习结束）

### 4.4 前端状态显示

修改前端状态显示逻辑：
- 根据 `applyType` 和 `status` 判断使用哪个状态枚举
- 自主实习使用新的状态文本和颜色

## 五、状态显示规则

### 5.1 状态文本显示

| 状态码 | 状态文本 | 标签颜色 | 说明 |
|--------|---------|---------|------|
| 10 | 待审核 | warning（黄色） | 等待班主任审核 |
| 11 | 实习中 | success（绿色） | 审核通过，正在实习 |
| 12 | 审核拒绝 | danger（红色） | 班主任审核拒绝 |
| 13 | 实习结束 | info（灰色） | 实习已结束 |
| 14 | 已取消 | info（灰色） | 学生取消申请 |

### 5.2 状态流转历史

自主实习的状态流转历史应显示：
- 提交申请 → 待审核(10)
- 审核通过 → 实习中(11)
- 审核拒绝 → 审核拒绝(12)
- 实习结束 → 实习结束(13)
- 取消申请 → 已取消(14)

## 六、兼容性处理

### 6.1 历史数据迁移

对于现有的自主实习申请（使用 0-9 状态码），需要进行数据迁移：

```sql
-- 将自主实习申请的状态码迁移到新范围
UPDATE internship_apply 
SET status = CASE 
    WHEN status = 0 THEN 10  -- 待审核
    WHEN status = 1 THEN 11  -- 已通过 → 实习中
    WHEN status = 2 THEN 12  -- 已拒绝 → 审核拒绝
    WHEN status = 3 THEN 11  -- 已录用 → 实习中
    WHEN status = 5 THEN 14  -- 已取消
    ELSE status
END
WHERE apply_type = 2;
```

### 6.2 代码兼容

在状态判断时，需要同时兼容旧状态码和新状态码：

```java
// 判断是否为自主实习的"实习中"状态
private boolean isSelfInternshipInProgress(Integer status) {
    return status != null && (status == 11 || status == 3); // 兼容旧数据
}
```

## 七、实施步骤

1. **创建状态枚举类**：`SelfInternshipApplyStatus.java`
2. **修改后端状态逻辑**：更新 `InternshipApplyServiceImpl` 中的状态处理
3. **修改前端状态显示**：更新状态文本和颜色映射
4. **数据迁移**：执行 SQL 迁移脚本
5. **测试验证**：测试所有状态转换流程

## 八、优势

1. **状态清晰**：自主实习有独立的状态体系，不会与合作企业混淆
2. **易于扩展**：未来可以轻松添加新的自主实习状态
3. **向后兼容**：通过状态码范围区分，不影响现有合作企业状态
4. **业务准确**：状态名称更符合自主实习的业务流程

