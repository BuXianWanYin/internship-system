# 自动化测试操作指南

本文档记录了使用浏览器自动化工具（chrome-mcp-server）进行测试时的操作技巧和最佳实践，特别是针对复杂UI组件的操作方法。

## 目录

1. [日期选择器操作](#日期选择器操作)
2. [富文本编辑器操作](#富文本编辑器操作)
3. [下拉选择器操作](#下拉选择器操作)
4. [文件上传操作](#文件上传操作)
5. [表单验证处理](#表单验证处理)
6. [常见问题解决](#常见问题解决)

---

## 日期选择器操作

### 方法一：使用JavaScript直接设置日期值（推荐）

对于Element Plus的日期选择器，可以直接通过JavaScript设置input的值并触发事件：

```javascript
// 设置日期值
const dateInput = document.querySelector('input[placeholder*="日期"]');
if (dateInput) {
  dateInput.value = '2025-11-27';
  dateInput.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
  dateInput.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));
  dateInput.dispatchEvent(new Event('blur', { bubbles: true, cancelable: true }));
}
```

**使用场景：**
- 实习日志的日志日期
- 周报的开始日期和结束日期
- 面试管理的面试时间

**优点：**
- 快速、可靠
- 不依赖日期选择器的UI交互
- 适用于自动化测试

### 方法二：通过日期选择器UI选择日期

如果方法一不生效，可以通过点击日期选择器并选择日期：

1. **点击日期输入框打开日期选择器**
   ```javascript
   // 点击日期输入框
   await browser_click({ element: "日期输入框", ref: "e1330" });
   ```

2. **切换到目标月份（如需要）**
   ```javascript
   // 点击"下个月"按钮
   await browser_click({ element: "下个月按钮", ref: "e1703" });
   ```

3. **选择具体日期**
   ```javascript
   // 点击日期（例如：1号）
   await browser_click({ element: "日期1号", ref: "e1858" });
   ```

**注意事项：**
- 日期选择器打开时可能会阻塞其他元素的点击
- 如果日期选择器打开，需要先关闭（按Escape键）才能操作其他元素
- 跨月份选择时，需要先切换到目标月份

### 方法三：通过Vue组件实例设置日期

如果上述方法都不生效，可以尝试直接操作Vue组件实例：

```javascript
const dateInput = document.querySelector('input[placeholder*="日期"]');
if (dateInput) {
  // 尝试找到Vue组件实例
  const vueInstance = dateInput.__vueParentComponent || dateInput._vueParentComponent;
  if (vueInstance && vueInstance.ctx) {
    // 直接设置表单数据
    if (vueInstance.ctx.formData) {
      vueInstance.ctx.formData.logDate = '2025-11-27';
    }
    // 强制更新
    if (vueInstance.ctx.$forceUpdate) {
      vueInstance.ctx.$forceUpdate();
    }
  }
}
```

---

## 富文本编辑器操作

### 方法一：使用Quill API设置内容（推荐）

对于Quill富文本编辑器，应该使用Quill的API来设置内容：

```javascript
const editor = document.querySelector('.ql-editor');
if (editor) {
  const quillInstance = editor.__quill;
  if (quillInstance) {
    // 使用Quill的setContents方法设置内容
    const delta = quillInstance.clipboard.convert({
      ops: [
        { insert: '标题文本\n', attributes: { bold: true } },
        { insert: '普通文本内容\n' },
        { insert: '更多内容...\n' }
      ]
    });
    quillInstance.setContents(delta, 'user');
    
    // 触发change事件
    quillInstance.root.dispatchEvent(new Event('input', { bubbles: true }));
    quillInstance.root.dispatchEvent(new Event('text-change', { bubbles: true }));
  }
}
```

**使用场景：**
- 实习日志的日志内容
- 周报的周报内容
- 成果的成果描述
- 问题反馈的反馈内容

**优点：**
- 正确触发Quill的内部状态更新
- 支持富文本格式（粗体、斜体等）
- 能够正确触发Vue的响应式更新

### 方法二：直接设置innerHTML（不推荐）

如果Quill API不可用，可以尝试直接设置innerHTML，但这种方法可能无法正确触发验证：

```javascript
const editor = document.querySelector('.ql-editor');
if (editor) {
  editor.innerHTML = '<p><strong>标题</strong></p><p>内容</p>';
  editor.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
  editor.dispatchEvent(new Event('text-change', { bubbles: true, cancelable: true }));
}
```

**注意事项：**
- 这种方法可能无法正确触发表单验证
- 建议优先使用方法一

---

## 下拉选择器操作

### 方法一：点击下拉框并选择选项

1. **点击下拉框打开选项列表**
   ```javascript
   await browser_click({ element: "下拉框", ref: "e580" });
   await browser_wait_for({ time: 1 });
   ```

2. **选择目标选项**
   ```javascript
   await browser_click({ element: "选项名称", ref: "e616" });
   ```

**使用场景：**
- 反馈类型选择
- 成果类型选择
- 批阅状态选择

### 方法二：使用JavaScript直接选择

如果方法一不生效，可以使用JavaScript：

```javascript
// 找到下拉框并点击
const select = document.querySelector('input[placeholder*="类型"]');
if (select) {
  select.click();
  setTimeout(() => {
    const options = Array.from(document.querySelectorAll('li'));
    const targetOption = options.find(li => 
      li.textContent && li.textContent.includes('目标选项')
    );
    if (targetOption) {
      targetOption.click();
    }
  }, 500);
}
```

---

## 文件上传操作

### 跳过文件上传（推荐用于自动化测试）

在自动化测试中，文件上传通常比较复杂。如果附件不是必填项，可以跳过：

```javascript
// 附件字段通常不是必填项，可以不上传文件
// 直接提交表单即可
```

**注意事项：**
- 检查表单验证规则，确认附件是否为必填项
- 如果附件是必填项，需要使用文件上传API或模拟文件选择

---

## 表单验证处理

### 处理表单验证错误

如果表单提交时出现验证错误，需要：

1. **检查所有必填字段是否已填写**
   - 日期字段：确保日期已正确设置
   - 富文本编辑器：确保内容已正确设置
   - 下拉选择器：确保已选择选项

2. **使用JavaScript强制触发验证**

```javascript
// 触发所有input的blur事件以触发验证
const inputs = document.querySelectorAll('input, textarea, .ql-editor');
inputs.forEach(input => {
  input.dispatchEvent(new Event('blur', { bubbles: true }));
});
```

3. **检查Vue表单验证状态**

```javascript
// 尝试找到表单引用并手动验证
const formRef = document.querySelector('form');
if (formRef && formRef.__vueParentComponent) {
  const vueInstance = formRef.__vueParentComponent;
  if (vueInstance.ctx && vueInstance.ctx.$refs) {
    const formRefInstance = vueInstance.ctx.$refs.formRef;
    if (formRefInstance && formRefInstance.validate) {
      formRefInstance.validate();
    }
  }
}
```

---

## 常见问题解决

### 问题1：日期选择器打开后无法点击其他元素

**解决方案：**
```javascript
// 先按Escape键关闭日期选择器
await browser_press_key({ key: "Escape" });
await browser_wait_for({ time: 1 });
```

### 问题2：富文本编辑器内容设置后验证仍失败

**解决方案：**
1. 确保使用Quill API设置内容
2. 触发text-change事件
3. 等待一段时间让Vue更新

```javascript
// 设置内容后等待Vue更新
quillInstance.setContents(delta, 'user');
quillInstance.root.dispatchEvent(new Event('text-change', { bubbles: true }));
await browser_wait_for({ time: 1 });
```

### 问题3：下拉选择器选项点击后未选择

**解决方案：**
1. 确保下拉框已完全打开（等待足够时间）
2. 使用更精确的元素定位
3. 如果仍失败，使用JavaScript直接设置值

```javascript
// 直接设置select的值
const select = document.querySelector('select');
if (select) {
  select.value = '目标值';
  select.dispatchEvent(new Event('change', { bubbles: true }));
}
```

### 问题4：对话框打开时无法点击其他元素

**解决方案：**
```javascript
// 先关闭对话框
await browser_press_key({ key: "Escape" });
// 或者点击关闭按钮
await browser_click({ element: "关闭按钮", ref: "e783" });
```

### 问题5：元素引用（ref）在页面更新后失效

**解决方案：**
1. 每次操作前重新获取快照
2. 使用更稳定的选择器（如文本内容）
3. 等待页面完全加载后再操作

```javascript
// 等待页面加载
await browser_wait_for({ time: 2 });
// 重新获取快照
await browser_snapshot();
```

---

## 最佳实践

### 1. 操作顺序

1. **先获取页面快照**：了解当前页面状态
2. **等待页面稳定**：使用`browser_wait_for`等待动画和加载完成
3. **执行操作**：点击、输入、选择等
4. **验证结果**：检查操作是否成功

### 2. 错误处理

- 如果操作超时，先检查是否有对话框或弹窗阻塞
- 如果验证失败，检查所有必填字段是否正确填写
- 如果元素找不到，重新获取快照并使用新的引用

### 3. 性能优化

- 对于复杂表单，使用JavaScript批量设置值
- 避免不必要的等待时间
- 优先使用直接设置值的方法，而不是UI交互

### 4. 代码示例模板

```javascript
// 完整的表单填写示例
async function fillForm() {
  // 1. 设置日期
  const dateInput = document.querySelector('input[placeholder*="日期"]');
  if (dateInput) {
    dateInput.value = '2025-11-27';
    dateInput.dispatchEvent(new Event('input', { bubbles: true }));
    dateInput.dispatchEvent(new Event('change', { bubbles: true }));
  }
  
  // 2. 设置富文本内容
  const editor = document.querySelector('.ql-editor');
  if (editor && editor.__quill) {
    const delta = editor.__quill.clipboard.convert({
      ops: [{ insert: '内容\n' }]
    });
    editor.__quill.setContents(delta, 'user');
    editor.dispatchEvent(new Event('text-change', { bubbles: true }));
  }
  
  // 3. 选择下拉选项
  const select = document.querySelector('input[placeholder*="类型"]');
  if (select) {
    select.click();
    setTimeout(() => {
      const option = Array.from(document.querySelectorAll('li'))
        .find(li => li.textContent && li.textContent.includes('目标选项'));
      if (option) option.click();
    }, 500);
  }
  
  return '表单已填写';
}
```

---

## 测试用例示例

### 示例1：提交实习日志

```javascript
// 1. 打开提交日志对话框
await browser_click({ element: "提交日志按钮", ref: "e676" });
await browser_wait_for({ time: 2 });

// 2. 设置日志日期
await browser_evaluate({
  function: `() => {
    const dateInput = document.querySelector('dialog input[placeholder*="日志日期"]');
    if (dateInput) {
      dateInput.value = '2025-11-27';
      dateInput.dispatchEvent(new Event('input', { bubbles: true }));
      dateInput.dispatchEvent(new Event('change', { bubbles: true }));
    }
    return '日期已设置';
  }`
});

// 3. 设置日志内容
await browser_evaluate({
  function: `() => {
    const editor = document.querySelector('dialog .ql-editor');
    if (editor && editor.__quill) {
      const delta = editor.__quill.clipboard.convert({
        ops: [{ insert: '今天的工作内容：完成了用户登录模块的开发。\n' }]
      });
      editor.__quill.setContents(delta, 'user');
      editor.dispatchEvent(new Event('text-change', { bubbles: true }));
    }
    return '内容已设置';
  }`
});

// 4. 提交表单
await browser_wait_for({ time: 1 });
await browser_click({ element: "确定按钮", ref: "e988" });
await browser_wait_for({ time: 3 });
```

### 示例2：提交周报

```javascript
// 1. 打开提交周报对话框
await browser_click({ element: "提交周报按钮", ref: "e1171" });
await browser_wait_for({ time: 2 });

// 2. 设置周次
await browser_click({ element: "增加数值按钮（周次）", ref: "e1305" });
await browser_wait_for({ time: 0.5 });

// 3. 设置开始日期
await browser_evaluate({
  function: `() => {
    const dateInput = document.querySelector('dialog input[placeholder*="开始日期"]');
    if (dateInput) {
      dateInput.value = '2025-11-25';
      dateInput.dispatchEvent(new Event('input', { bubbles: true }));
      dateInput.dispatchEvent(new Event('change', { bubbles: true }));
    }
    return '开始日期已设置';
  }`
});

// 4. 设置结束日期
await browser_evaluate({
  function: `() => {
    const dateInput = document.querySelector('dialog input[placeholder*="结束日期"]');
    if (dateInput) {
      dateInput.value = '2025-12-01';
      dateInput.dispatchEvent(new Event('input', { bubbles: true }));
      dateInput.dispatchEvent(new Event('change', { bubbles: true }));
    }
    return '结束日期已设置';
  }`
});

// 5. 设置周报内容
await browser_evaluate({
  function: `() => {
    const editor = document.querySelector('dialog .ql-editor');
    if (editor && editor.__quill) {
      const delta = editor.__quill.clipboard.convert({
        ops: [
          { insert: '本周工作内容：\n', attributes: { bold: true } },
          { insert: '1. 完成了用户登录模块的开发和测试\n' },
          { insert: '2. 参与了代码审查会议\n\n' },
          { insert: '工作收获：\n', attributes: { bold: true } },
          { insert: '通过本周的工作，我深入了解了Spring Boot框架的使用。\n' }
        ]
      });
      editor.__quill.setContents(delta, 'user');
      editor.dispatchEvent(new Event('text-change', { bubbles: true }));
    }
    return '周报内容已设置';
  }`
});

// 6. 提交表单
await browser_wait_for({ time: 1 });
await browser_click({ element: "确定按钮", ref: "e1510" });
await browser_wait_for({ time: 3 });
```

---

## 注意事项

1. **日期格式**：确保日期格式为 `YYYY-MM-DD`（例如：`2025-11-27`）
2. **等待时间**：在关键操作之间添加适当的等待时间，确保页面状态稳定
3. **元素定位**：优先使用稳定的选择器（如placeholder、label等），避免使用易变的ref
4. **错误处理**：如果操作失败，先检查是否有对话框或弹窗阻塞，然后重试
5. **验证检查**：提交表单前，确保所有必填字段都已正确填写

---

## 更新记录

- **2025-11-27**：初始版本，包含日期选择器、富文本编辑器、下拉选择器的操作方法
- 基于实际测试经验总结的最佳实践

