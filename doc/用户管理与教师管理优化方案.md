# 用户管理与教师管理优化方案

## 一、现状分析

### 1.1 当前功能情况

#### 用户管理页面 (`UserManagement.vue`)
- **访问权限**：系统管理员、学校管理员、学院负责人、班主任
- **功能**：
  - 查询所有用户（支持按角色、学校、学院、班级筛选）
  - 添加用户（基础信息：用户名、密码、真实姓名、身份证号、手机号、邮箱、状态）
  - 编辑用户（基础信息，**无角色分配功能**）
  - 重置密码
  - 停用用户
- **数据范围**：
  - 系统管理员：所有用户
  - 学校管理员：本校用户
  - 学院负责人：本学院用户
  - 班主任：本班级学生用户

#### 教师管理页面 (`TeacherManagement.vue`)
- **访问权限**：系统管理员、学校管理员、学院负责人
- **功能**：
  - 查询教师（支持按工号、学校、学院筛选）
  - 添加教师（基础信息 + **角色分配**）
  - 编辑教师（基础信息 + **角色分配**）
  - 停用教师
- **角色分配**：
  - 系统管理员：可以分配所有教师角色（ROLE_SCHOOL_ADMIN、ROLE_COLLEGE_LEADER、ROLE_CLASS_TEACHER、ROLE_INSTRUCTOR）
  - 学校管理员：可以分配学校相关角色（ROLE_SCHOOL_ADMIN、ROLE_COLLEGE_LEADER、ROLE_CLASS_TEACHER、ROLE_INSTRUCTOR）
  - 学院负责人：可以分配教师相关角色（ROLE_COLLEGE_LEADER、ROLE_CLASS_TEACHER、ROLE_INSTRUCTOR）

### 1.2 存在的问题

1. **功能重合**：
   - 用户管理和教师管理都管理用户，功能有重合
   - 用户管理可以查看所有用户（包括教师），但无法分配角色
   - 教师管理只能管理教师，但可以分配角色

2. **角色分配不一致**：
   - 用户管理编辑页面没有角色分配功能
   - 教师管理编辑页面有角色分配功能
   - 系统管理员的用户管理编辑页面应该可以分配角色

3. **角色定义问题**：
   - 系统中同时存在 `ROLE_CLASS_TEACHER`（班主任）和 `ROLE_INSTRUCTOR`（指导教师）
   - 用户反馈这两个角色实际上是同一个，应该合并为"班主任"

4. **权限显示不清晰**：
   - 不同角色的用户管理页面应该显示不同的数据范围
   - 不同角色的用户管理编辑页面应该显示不同的角色分配选项

## 二、优化方案

### 2.1 角色合并方案

#### 2.1.1 合并策略
- **保留角色**：`ROLE_CLASS_TEACHER`（班主任）
- **废弃角色**：`ROLE_INSTRUCTOR`（指导教师）
- **合并方式**：
  1. 将所有 `ROLE_INSTRUCTOR` 角色的用户角色关联改为 `ROLE_CLASS_TEACHER`
  2. 删除 `ROLE_INSTRUCTOR` 角色记录（软删除）
  3. 更新所有代码中的 `ROLE_INSTRUCTOR` 引用为 `ROLE_CLASS_TEACHER`

#### 2.1.2 数据库操作
```sql
-- 1. 将 ROLE_INSTRUCTOR 角色的用户角色关联改为 ROLE_CLASS_TEACHER
UPDATE user_role ur
INNER JOIN role_info r1 ON ur.role_id = r1.role_id AND r1.role_code = 'ROLE_INSTRUCTOR'
INNER JOIN role_info r2 ON r2.role_code = 'ROLE_CLASS_TEACHER'
SET ur.role_id = r2.role_id
WHERE ur.delete_flag = 0;

-- 2. 软删除 ROLE_INSTRUCTOR 角色
UPDATE role_info 
SET delete_flag = 1 
WHERE role_code = 'ROLE_INSTRUCTOR';
```

### 2.2 用户管理功能增强方案

#### 2.2.1 角色分配功能
在用户管理编辑页面添加角色分配功能，根据当前用户角色显示不同的角色选项：

**系统管理员**：
- 可以分配所有角色（除系统管理员外）
- 可选角色：
  - ROLE_SCHOOL_ADMIN（学校管理员）
  - ROLE_COLLEGE_LEADER（学院负责人）
  - ROLE_CLASS_TEACHER（班主任）
  - ROLE_ENTERPRISE_ADMIN（企业管理员）
  - ROLE_ENTERPRISE_MENTOR（企业导师）
  - ROLE_STUDENT（学生）

**学校管理员**：
- 可以分配学校相关角色
- 可选角色：
  - ROLE_SCHOOL_ADMIN（学校管理员）
  - ROLE_COLLEGE_LEADER（学院负责人）
  - ROLE_CLASS_TEACHER（班主任）
  - ROLE_STUDENT（学生）

**学院负责人**：
- 可以分配教师和学生角色
- 可选角色：
  - ROLE_COLLEGE_LEADER（学院负责人）
  - ROLE_CLASS_TEACHER（班主任）
  - ROLE_STUDENT（学生）

**班主任**：
- 只能分配学生角色
- 可选角色：
  - ROLE_STUDENT（学生）

#### 2.2.2 添加用户时的角色分配
在添加用户时，也应该可以分配角色（可选，如果不分配角色，用户将无法登录系统）。

### 2.3 用户管理与教师管理功能定位

#### 2.3.1 功能定位
- **用户管理**：统一管理所有用户（包括学生、教师、企业管理员等），提供基础信息管理和角色分配功能
- **教师管理**：专门管理教师，提供教师专业信息管理（工号、职称等）和角色分配功能

#### 2.3.2 功能区分
| 功能 | 用户管理 | 教师管理 |
|------|---------|---------|
| 管理范围 | 所有用户 | 仅教师 |
| 基础信息 | ✅ | ✅ |
| 角色分配 | ✅（新增） | ✅ |
| 教师专业信息 | ❌ | ✅（工号、职称） |
| 学生信息 | ✅ | ❌ |
| 企业用户 | ✅ | ❌ |

#### 2.3.3 建议
- **保留两个模块**：用户管理和教师管理各有侧重，建议保留
- **用户管理**：作为统一入口，管理所有用户的基础信息和角色
- **教师管理**：作为专业模块，管理教师的专业信息（工号、职称等）和角色分配

### 2.4 不同角色的用户管理显示方案

#### 2.4.1 系统管理员
- **显示范围**：所有用户
- **可操作**：
  - 添加用户（可分配所有角色）
  - 编辑用户（可分配所有角色）
  - 重置密码
  - 停用用户

#### 2.4.2 学校管理员
- **显示范围**：本校用户
- **可操作**：
  - 添加用户（可分配学校相关角色）
  - 编辑用户（可分配学校相关角色）
  - 重置密码
  - 停用用户（不能停用系统管理员）

#### 2.4.3 学院负责人
- **显示范围**：本学院用户
- **可操作**：
  - 添加用户（可分配教师和学生角色）
  - 编辑用户（可分配教师和学生角色）
  - 重置密码
  - 停用用户（不能停用系统管理员、学校管理员）

#### 2.4.4 班主任
- **显示范围**：本班级学生用户
- **可操作**：
  - 添加用户（只能分配学生角色）
  - 编辑用户（只能分配学生角色，或保持现有角色）
  - 重置密码
  - 停用用户（只能停用学生）

### 2.5 教师管理显示方案

#### 2.5.1 系统管理员
- **显示范围**：所有教师
- **可操作**：
  - 添加教师（可分配所有教师角色）
  - 编辑教师（可分配所有教师角色）
  - 停用教师

#### 2.5.2 学校管理员
- **显示范围**：本校教师
- **可操作**：
  - 添加教师（可分配学校相关教师角色）
  - 编辑教师（可分配学校相关教师角色）
  - 停用教师

#### 2.5.3 学院负责人
- **显示范围**：本学院教师
- **可操作**：
  - 添加教师（可分配教师角色：ROLE_COLLEGE_LEADER、ROLE_CLASS_TEACHER）
  - 编辑教师（可分配教师角色：ROLE_COLLEGE_LEADER、ROLE_CLASS_TEACHER）
  - 停用教师

## 三、实施步骤

### 3.1 第一阶段：角色合并（1天）

1. **数据库操作**：
   - 执行角色合并SQL脚本
   - 验证数据迁移正确性

2. **后端代码修改**：
   - 将所有 `ROLE_INSTRUCTOR` 引用改为 `ROLE_CLASS_TEACHER`
   - 更新权限检查逻辑
   - 更新角色分配逻辑

3. **前端代码修改**：
   - 更新角色常量定义
   - 更新角色选择下拉框（移除"指导教师"选项）
   - 更新权限检查逻辑

### 3.2 第二阶段：用户管理功能增强（2-3天）

1. **后端修改**：
   - 在 `UserController` 的 `updateUser` 方法中添加角色分配逻辑
   - 在 `UserController` 的 `addUser` 方法中添加角色分配逻辑（可选）
   - 添加角色分配验证逻辑

2. **前端修改**：
   - 在 `UserManagement.vue` 的编辑对话框中添加角色选择下拉框
   - 在 `UserManagement.vue` 的添加对话框中添加角色选择下拉框（可选）
   - 根据当前用户角色过滤可选角色列表
   - 显示用户当前角色

### 3.3 第三阶段：教师管理优化（1天）

1. **角色下拉框更新**：
   - 移除"指导教师"选项
   - 只保留"班主任"选项

2. **权限验证**：
   - 确保角色分配权限正确

### 3.4 第四阶段：测试与优化（1-2天）

1. **功能测试**：
   - 测试不同角色的用户管理功能
   - 测试角色分配功能
   - 测试数据权限过滤

2. **权限测试**：
   - 测试不同角色的权限限制
   - 测试角色分配权限

3. **数据验证**：
   - 验证角色合并后的数据完整性
   - 验证历史数据正确性

## 四、详细改动说明

### 4.1 数据库改动

#### 4.1.1 角色合并SQL
```sql
-- 1. 查询需要合并的用户角色关联
SELECT ur.user_id, ur.role_id, r.role_code, r.role_name
FROM user_role ur
INNER JOIN role_info r ON ur.role_id = r.role_id
WHERE r.role_code = 'ROLE_INSTRUCTOR' AND ur.delete_flag = 0;

-- 2. 将 ROLE_INSTRUCTOR 角色的用户角色关联改为 ROLE_CLASS_TEACHER
UPDATE user_role ur
INNER JOIN role_info r1 ON ur.role_id = r1.role_id AND r1.role_code = 'ROLE_INSTRUCTOR'
INNER JOIN role_info r2 ON r2.role_code = 'ROLE_CLASS_TEACHER' AND r2.delete_flag = 0
SET ur.role_id = r2.role_id
WHERE ur.delete_flag = 0;

-- 3. 软删除 ROLE_INSTRUCTOR 角色
UPDATE role_info 
SET delete_flag = 1, 
    status = 0
WHERE role_code = 'ROLE_INSTRUCTOR';
```

### 4.2 后端改动

#### 4.2.1 UserController 修改

**添加用户接口**（可选，建议添加）：
```java
@ApiOperation("添加用户")
@PreAuthorize("hasAnyRole('ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER', 'ROLE_CLASS_TEACHER')")
@PostMapping
public Result<UserInfo> addUser(@RequestBody UserInfo user) {
    // 如果指定了角色，验证角色分配权限
    if (user.getRoles() != null && !user.getRoles().isEmpty()) {
        for (String roleCode : user.getRoles()) {
            if (!dataPermissionUtil.canAssignRole(roleCode)) {
                throw new BusinessException("无权限分配角色：" + roleCode);
            }
        }
    }
    UserInfo result = userService.addUser(user);
    return Result.success("添加成功", result);
}
```

**更新用户接口**（必须修改）：
```java
@ApiOperation("更新用户信息")
@PreAuthorize("hasAnyRole('ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER', 'ROLE_CLASS_TEACHER')")
@PutMapping
public Result<UserInfo> updateUser(@RequestBody UserInfo user) {
    // 如果指定了角色，验证角色分配权限
    if (user.getRoles() != null && !user.getRoles().isEmpty()) {
        for (String roleCode : user.getRoles()) {
            if (!dataPermissionUtil.canAssignRole(roleCode)) {
                throw new BusinessException("无权限分配角色：" + roleCode);
            }
        }
    }
    UserInfo result = userService.updateUser(user);
    return Result.success("更新成功", result);
}
```

#### 4.2.2 UserService 修改

**addUser 方法**：
```java
@Override
@Transactional(rollbackFor = Exception.class)
public UserInfo addUser(UserInfo user) {
    // ... 原有逻辑 ...
    
    // 如果指定了角色，分配角色
    if (user.getRoles() != null && !user.getRoles().isEmpty()) {
        for (String roleCode : user.getRoles()) {
            assignRoleToUser(user.getUserId(), roleCode);
        }
    }
    
    return user;
}
```

**updateUser 方法**：
```java
@Override
@Transactional(rollbackFor = Exception.class)
public UserInfo updateUser(UserInfo user) {
    // ... 原有逻辑 ...
    
    // 如果指定了角色，更新角色分配
    if (user.getRoles() != null) {
        // 获取用户当前角色
        List<String> currentRoles = userMapper.selectRoleCodesByUserId(user.getUserId());
        
        // 计算需要添加和删除的角色
        List<String> rolesToAdd = new ArrayList<>(user.getRoles());
        rolesToAdd.removeAll(currentRoles);
        
        List<String> rolesToRemove = new ArrayList<>(currentRoles);
        rolesToRemove.removeAll(user.getRoles());
        
        // 添加新角色
        for (String roleCode : rolesToAdd) {
            assignRoleToUser(user.getUserId(), roleCode);
        }
        
        // 删除旧角色（需要实现 removeRoleFromUser 方法）
        for (String roleCode : rolesToRemove) {
            removeRoleFromUser(user.getUserId(), roleCode);
        }
    }
    
    return user;
}
```

#### 4.2.3 代码全局替换

**替换规则**：
- `ROLE_INSTRUCTOR` → `ROLE_CLASS_TEACHER`
- `"ROLE_INSTRUCTOR"` → `"ROLE_CLASS_TEACHER"`
- `指导教师` → `班主任`（注释和文档中）

**需要修改的文件**：
- 所有 Controller 文件
- 所有 Service 文件
- 所有权限检查工具类
- 所有前端页面和工具函数

### 4.3 前端改动

#### 4.3.1 UserManagement.vue 修改

**添加角色选择字段**：
```vue
<el-form-item label="角色" prop="roles" v-if="hasAnyRole(['ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN', 'ROLE_COLLEGE_LEADER', 'ROLE_CLASS_TEACHER'])">
  <el-select
    v-model="formData.roles"
    placeholder="请选择角色"
    multiple
    style="width: 100%"
    :disabled="isEdit && !canAssignRoleForUser"
  >
    <el-option
      v-for="role in filteredRoleList"
      :key="role.roleCode"
      :label="role.roleName"
      :value="role.roleCode"
    />
  </el-select>
  <div v-if="isEdit && rowRoles.length > 0" style="margin-top: 8px; font-size: 12px; color: #909399;">
    当前角色：{{ rowRoles.map(r => getRoleName(r)).join('、') }}
  </div>
</el-form-item>
```

**添加角色列表过滤逻辑**：
```javascript
// 过滤后的角色列表（根据当前用户权限）
const filteredRoleList = computed(() => {
  return roleList.value.filter(role => {
    // 系统管理员不能分配系统管理员角色
    if (role.roleCode === 'ROLE_SYSTEM_ADMIN') {
      return false
    }
    return canAssignRole(role.roleCode)
  })
})
```

**表单数据修改**：
```javascript
const formData = reactive({
  userId: null,
  username: '',
  password: '',
  realName: '',
  idCard: '',
  phone: '',
  email: '',
  status: 1,
  roles: []  // 新增：角色列表
})
```

**编辑时加载用户角色**：
```javascript
const handleEdit = async (row) => {
  isEdit.value = true
  dialogTitle.value = '编辑用户'
  try {
    const res = await userApi.getUserById(row.userId)
    if (res.code === 200) {
      Object.assign(formData, {
        userId: res.data.userId,
        username: res.data.username,
        password: '',
        realName: res.data.realName || '',
        idCard: res.data.idCard || '',
        phone: res.data.phone || '',
        email: res.data.email || '',
        status: res.data.status,
        roles: res.data.roles || []  // 加载用户角色
      })
      rowRoles.value = res.data.roles || []  // 保存原始角色用于显示
      dialogVisible.value = true
    }
  } catch (error) {
    console.error('获取用户详情失败:', error)
  }
}
```

#### 4.3.2 TeacherManagement.vue 修改

**角色下拉框更新**：
```javascript
// 加载角色列表（只加载教师相关角色，移除 ROLE_INSTRUCTOR）
const loadRoleList = async () => {
  try {
    const res = await roleApi.getAllEnabledRoles()
    if (res.code === 200) {
      // 基础教师相关角色（移除 ROLE_INSTRUCTOR）
      const teacherRoles = ['ROLE_COLLEGE_LEADER', 'ROLE_CLASS_TEACHER']
      // 学校管理员和系统管理员可以分配学校管理员角色
      if (hasAnyRole(['ROLE_SYSTEM_ADMIN', 'ROLE_SCHOOL_ADMIN'])) {
        teacherRoles.push('ROLE_SCHOOL_ADMIN')
      }
      roleList.value = (res.data || []).filter(role => teacherRoles.includes(role.roleCode))
    }
  } catch (error) {
    console.error('加载角色列表失败:', error)
  }
}
```

#### 4.3.3 permission.js 修改

**更新角色常量**：
```javascript
export const ROLES = {
  SYSTEM_ADMIN: 'ROLE_SYSTEM_ADMIN',
  SCHOOL_ADMIN: 'ROLE_SCHOOL_ADMIN',
  COLLEGE_LEADER: 'ROLE_COLLEGE_LEADER',
  CLASS_TEACHER: 'ROLE_CLASS_TEACHER',
  // ROLE_INSTRUCTOR: 'ROLE_INSTRUCTOR',  // 已废弃，合并到 ROLE_CLASS_TEACHER
  ENTERPRISE_ADMIN: 'ROLE_ENTERPRISE_ADMIN',
  ENTERPRISE_MENTOR: 'ROLE_ENTERPRISE_MENTOR',
  STUDENT: 'ROLE_STUDENT'
}
```

**更新 canAssignRole 函数**：
```javascript
export function canAssignRole(roleCode) {
  // ... 原有逻辑 ...
  
  // 学院负责人不能分配系统管理员、学校管理员角色
  // 只能分配教师相关角色（ROLE_COLLEGE_LEADER、ROLE_CLASS_TEACHER）和学生角色
  if (currentRoles.includes(ROLES.COLLEGE_LEADER)) {
    if (roleCode === ROLES.SCHOOL_ADMIN) {
      return false
    }
    // 可以分配的教师相关角色和学生角色（移除 ROLE_INSTRUCTOR）
    if (roleCode === ROLES.COLLEGE_LEADER || 
        roleCode === ROLES.CLASS_TEACHER ||
        roleCode === ROLES.STUDENT) {
      return true
    }
    // 不能分配企业相关角色等其他角色
    return false
  }
  
  // ... 其他逻辑 ...
}
```

## 五、角色分配权限矩阵

| 当前用户角色 | 可分配角色 | 说明 |
|------------|-----------|------|
| 系统管理员 | ROLE_SCHOOL_ADMIN<br>ROLE_COLLEGE_LEADER<br>ROLE_CLASS_TEACHER<br>ROLE_ENTERPRISE_ADMIN<br>ROLE_ENTERPRISE_MENTOR<br>ROLE_STUDENT | 不能分配系统管理员角色 |
| 学校管理员 | ROLE_SCHOOL_ADMIN<br>ROLE_COLLEGE_LEADER<br>ROLE_CLASS_TEACHER<br>ROLE_STUDENT | 不能分配系统管理员、企业相关角色 |
| 学院负责人 | ROLE_COLLEGE_LEADER<br>ROLE_CLASS_TEACHER<br>ROLE_STUDENT | 不能分配系统管理员、学校管理员、企业相关角色 |
| 班主任 | ROLE_STUDENT | 只能分配学生角色 |

## 六、注意事项

### 6.1 数据迁移注意事项
1. **备份数据**：在执行角色合并SQL前，必须备份 `user_role` 和 `role_info` 表
2. **验证数据**：合并后需要验证所有用户角色关联是否正确
3. **历史数据**：检查是否有历史数据依赖 `ROLE_INSTRUCTOR` 角色

### 6.2 权限验证注意事项
1. **角色分配权限**：每次分配角色时，必须验证当前用户是否有权限分配该角色
2. **数据权限**：不同角色看到的用户列表范围不同，需要正确实现数据权限过滤
3. **编辑权限**：不同角色只能编辑权限范围内的用户

### 6.3 用户体验注意事项
1. **角色显示**：编辑用户时，应该显示用户当前角色，方便用户了解
2. **角色提示**：如果用户没有分配角色，应该提示用户分配角色
3. **权限提示**：如果用户尝试分配无权限的角色，应该给出明确的错误提示

## 七、测试用例

### 7.1 角色合并测试
1. 验证所有 `ROLE_INSTRUCTOR` 角色的用户已成功合并为 `ROLE_CLASS_TEACHER`
2. 验证 `ROLE_INSTRUCTOR` 角色已软删除
3. 验证系统功能正常，无报错

### 7.2 用户管理功能测试
1. **系统管理员**：
   - 添加用户时可以分配所有角色（除系统管理员）
   - 编辑用户时可以修改角色分配
   - 可以查看所有用户

2. **学校管理员**：
   - 添加用户时可以分配学校相关角色
   - 编辑用户时可以修改角色分配（只能分配学校相关角色）
   - 只能查看本校用户

3. **学院负责人**：
   - 添加用户时可以分配教师和学生角色
   - 编辑用户时可以修改角色分配（只能分配教师和学生角色）
   - 只能查看本学院用户

4. **班主任**：
   - 添加用户时只能分配学生角色
   - 编辑用户时可以修改角色分配（只能分配学生角色）
   - 只能查看本班级学生用户

### 7.3 教师管理功能测试
1. 验证角色下拉框只显示"班主任"，不再显示"指导教师"
2. 验证角色分配权限正确
3. 验证教师专业信息管理正常

## 八、实施时间表

| 阶段 | 任务 | 预计时间 |
|------|------|---------|
| 第一阶段 | 角色合并 | 1天 |
| 第二阶段 | 用户管理功能增强 | 2-3天 |
| 第三阶段 | 教师管理优化 | 1天 |
| 第四阶段 | 测试与优化 | 1-2天 |
| **总计** | | **5-7天** |

## 九、风险评估

### 9.1 高风险项
1. **角色合并**：如果数据迁移不正确，可能导致用户权限丢失
   - **缓解措施**：充分测试，备份数据

2. **权限验证**：如果权限验证不正确，可能导致权限提升
   - **缓解措施**：严格测试权限验证逻辑

### 9.2 中风险项
1. **功能兼容性**：修改后可能影响现有功能
   - **缓解措施**：充分测试，逐步发布

2. **用户体验**：功能变更可能影响用户使用习惯
   - **缓解措施**：提供清晰的提示和帮助文档

## 十、后续优化建议

1. **角色管理页面**：考虑添加角色管理页面，允许系统管理员管理角色
2. **批量操作**：考虑添加批量分配角色功能
3. **角色历史**：考虑记录角色分配历史，便于审计
4. **权限可视化**：考虑添加权限可视化工具，帮助用户理解权限体系

