# 考勤数据权限与实习流程优化方案

## 一、问题分析

### 1.1 考勤数据权限问题

**问题描述：**
- 学生添加了考勤记录，但企业管理员和企业导师看不到数据

**根本原因：**
1. **申请状态不一致**：
   - 学生签到/签退时查询的是 `status = 1` (已通过) 的申请
   - 但面试通过后，申请状态会变成 `status = 3` (已录用)
   - 企业查询考勤时，通过 `enterpriseId` 查询申请，然后通过 `applyId` 过滤考勤
   - **问题**：学生签到时的申请状态是 `status = 1`，但企业查询时可能查询的是 `status = 3` 的申请，导致数据不匹配

2. **数据权限过滤逻辑**：
   - 企业端查询考勤时，通过 `applyId` 关联 `InternshipApply` 表，然后通过 `enterpriseId` 过滤
   - 但学生签到时的申请可能不是该企业的申请（如果是自主实习，`enterpriseId` 为 null）

**代码位置：**
- `AttendanceServiceImpl.studentCheckIn()` - 第538行：查询 `status = 1` 的申请
- `AttendanceServiceImpl.getAttendancePage()` - 第263-273行：企业端通过 `enterpriseId` 查询申请

### 1.2 面试通过后的流程问题

**当前流程：**
1. 学生提交申请 → `status = 0` (待审核)
2. 学校审核通过 → `status = 1` (已通过)
3. 企业安排面试 → 创建面试记录
4. 面试通过 → 企业可以录用（`status = 3`）或拒绝录用（`status = 4`）

**缺失的流程：**
1. ❌ **没有"确认上岗"功能**：面试通过后，学生应该确认是否接受该企业的实习机会
2. ❌ **没有学生绑定企业的机制**：学生表没有 `currentEnterpriseId` 字段，无法直接绑定当前实习企业
3. ❌ **没有离职/解绑功能**：学生无法主动离职或解绑企业
4. ❌ **没有班主任审核解绑的流程**：解绑需要审核机制

### 1.3 考勤记录绑定问题

**当前实现：**
- 考勤记录通过 `applyId` 关联 `InternshipApply` 表
- 然后通过 `InternshipApply.enterpriseId` 关联企业

**问题：**
- 如果学生有多个申请，可能绑定到错误的申请
- 没有明确的"当前实习企业"概念
- 考勤记录应该绑定到"已确认上岗"的申请

## 二、优化方案

### 2.1 数据库设计优化

#### 2.1.1 学生表添加字段

```sql
ALTER TABLE student_info ADD COLUMN current_apply_id BIGINT COMMENT '当前实习申请ID';
ALTER TABLE student_info ADD COLUMN current_enterprise_id BIGINT COMMENT '当前实习企业ID';
ALTER TABLE student_info ADD COLUMN internship_status INT DEFAULT 0 COMMENT '实习状态：0-未实习，1-实习中，2-已离职，3-已结束';
```

#### 2.1.2 申请表添加字段

```sql
ALTER TABLE internship_apply ADD COLUMN student_confirm_status INT DEFAULT 0 COMMENT '学生确认状态：0-未确认，1-已确认上岗，2-已拒绝';
ALTER TABLE internship_apply ADD COLUMN student_confirm_time DATETIME COMMENT '学生确认时间';
ALTER TABLE internship_apply ADD COLUMN unbind_status INT DEFAULT 0 COMMENT '解绑状态：0-未申请，1-申请解绑，2-已解绑，3-解绑被拒绝';
ALTER TABLE internship_apply ADD COLUMN unbind_reason VARCHAR(500) COMMENT '解绑原因';
ALTER TABLE internship_apply ADD COLUMN unbind_audit_user_id BIGINT COMMENT '解绑审核人ID（班主任）';
ALTER TABLE internship_apply ADD COLUMN unbind_audit_time DATETIME COMMENT '解绑审核时间';
ALTER TABLE internship_apply ADD COLUMN unbind_audit_opinion VARCHAR(500) COMMENT '解绑审核意见';
```

### 2.2 流程优化

#### 2.2.1 新的申请状态流程

```
1. 学生提交申请 → status = 0 (待审核)
2. 学校审核通过 → status = 1 (已通过)
3. 企业安排面试 → 创建面试记录
4. 面试通过 → 企业可以录用（status = 3）或拒绝录用（status = 4）
5. 【新增】学生确认上岗 → student_confirm_status = 1 (已确认上岗)
   - 此时绑定学生到企业：student.current_apply_id = applyId, student.current_enterprise_id = enterpriseId
   - 学生状态：student.internship_status = 1 (实习中)
6. 学生可以申请离职/解绑 → unbind_status = 1 (申请解绑)
7. 班主任审核解绑 → unbind_status = 2 (已解绑) 或 3 (解绑被拒绝)
   - 如果解绑通过：student.current_apply_id = null, student.current_enterprise_id = null, student.internship_status = 2 (已离职)
```

#### 2.2.2 考勤记录绑定优化

**修改逻辑：**
- 学生签到/签退时，查询 `student.current_apply_id` 对应的申请
- 如果 `current_apply_id` 为 null，提示"您还没有确认上岗的实习申请"
- 考勤记录绑定到 `current_apply_id` 对应的申请
- 企业查询考勤时，通过 `student.current_enterprise_id` 或 `apply.enterpriseId` 过滤

### 2.3 功能实现

#### 2.3.1 学生确认上岗功能

**后端接口：**
```java
@PostMapping("/internship/apply/{applyId}/confirm-onboard")
@PreAuthorize("hasRole('ROLE_STUDENT')")
public Result<?> confirmOnboard(@PathVariable Long applyId) {
    // 1. 验证申请状态为已录用（status = 3）
    // 2. 验证学生确认状态为未确认（student_confirm_status = 0）
    // 3. 如果学生已有其他已确认的申请，需要先解绑
    // 4. 更新申请：student_confirm_status = 1, student_confirm_time = now()
    // 5. 更新学生：current_apply_id = applyId, current_enterprise_id = enterpriseId, internship_status = 1
    // 6. 返回成功
}
```

**前端页面：**
- 在"我的面试"页面，面试通过后显示"确认上岗"按钮
- 在"实习申请"页面，已录用的申请显示"确认上岗"按钮
- 确认上岗后，显示当前实习企业信息

#### 2.3.2 学生申请离职/解绑功能

**后端接口：**
```java
@PostMapping("/internship/apply/{applyId}/apply-unbind")
@PreAuthorize("hasRole('ROLE_STUDENT')")
public Result<?> applyUnbind(@PathVariable Long applyId, @RequestParam String reason) {
    // 1. 验证申请是当前学生的已确认申请（current_apply_id = applyId）
    // 2. 验证解绑状态为未申请（unbind_status = 0）
    // 3. 更新申请：unbind_status = 1, unbind_reason = reason
    // 4. 返回成功
}
```

**前端页面：**
- 在"我的实习"页面，显示当前实习企业信息
- 提供"申请离职"按钮
- 填写离职原因后提交

#### 2.3.3 班主任审核解绑功能

**后端接口：**
```java
@PostMapping("/internship/apply/{applyId}/audit-unbind")
@PreAuthorize("hasAnyRole('ROLE_CLASS_TEACHER', 'ROLE_COLLEGE_LEADER')")
public Result<?> auditUnbind(@PathVariable Long applyId, 
                             @RequestParam Integer auditStatus, 
                             @RequestParam(required = false) String auditOpinion) {
    // 1. 验证申请的解绑状态为申请解绑（unbind_status = 1）
    // 2. 验证申请的学生属于当前用户管理的班级
    // 3. 如果审核通过（auditStatus = 2）：
    //    - 更新申请：unbind_status = 2, unbind_audit_user_id = currentUserId, unbind_audit_time = now(), unbind_audit_opinion = auditOpinion
    //    - 更新学生：current_apply_id = null, current_enterprise_id = null, internship_status = 2
    //    - 更新申请：student_confirm_status = 0 (重置确认状态)
    // 4. 如果审核拒绝（auditStatus = 3）：
    //    - 更新申请：unbind_status = 3, unbind_audit_user_id = currentUserId, unbind_audit_time = now(), unbind_audit_opinion = auditOpinion
    // 5. 返回成功
}
```

**前端页面：**
- 在班主任/学院负责人的"实习管理"页面，显示待审核的解绑申请
- 提供"审核"按钮，可以批准或拒绝

#### 2.3.4 学生端显示当前实习企业

**后端接口：**
```java
@GetMapping("/internship/apply/current")
@PreAuthorize("hasRole('ROLE_STUDENT')")
public Result<InternshipApply> getCurrentInternship() {
    // 1. 获取当前学生信息
    // 2. 查询 current_apply_id 对应的申请
    // 3. 填充关联字段（企业信息、岗位信息等）
    // 4. 返回申请信息
}
```

**前端页面：**
- 在"我的实习"页面，显示当前实习企业信息
- 包括：企业名称、岗位名称、实习开始时间、实习状态等
- 提供"申请离职"按钮

### 2.4 考勤记录修复

#### 2.4.1 修改学生签到/签退逻辑

**修改 `AttendanceServiceImpl.studentCheckIn()` 和 `studentCheckOut()`：**

```java
// 修改前：查询 status = 1 的申请
applyWrapper.eq(InternshipApply::getStatus, 1) // 已通过

// 修改后：查询当前学生的已确认申请
Long studentId = dataPermissionUtil.getCurrentStudentId();
Student student = studentMapper.selectById(studentId);
if (student == null || student.getCurrentApplyId() == null) {
    throw new BusinessException("您还没有确认上岗的实习申请，无法签到");
}
InternshipApply apply = internshipApplyMapper.selectById(student.getCurrentApplyId());
if (apply == null || apply.getDeleteFlag().equals(DeleteFlag.DELETED.getCode())) {
    throw new BusinessException("您的实习申请不存在或已删除");
}
if (apply.getStudentConfirmStatus() == null || apply.getStudentConfirmStatus() != 1) {
    throw new BusinessException("您还没有确认上岗，无法签到");
}
```

#### 2.4.2 修改企业查询考勤逻辑

**优化 `AttendanceServiceImpl.getAttendancePage()`：**

```java
// 企业端查询时，除了通过 applyId 关联，还可以通过 student.current_enterprise_id 过滤
if (dataPermissionUtil.hasAnyRole("ROLE_ENTERPRISE_ADMIN", "ROLE_ENTERPRISE_MENTOR")) {
    Long currentUserEnterpriseId = dataPermissionUtil.getCurrentUserEnterpriseId();
    if (currentUserEnterpriseId != null) {
        // 方式1：通过 applyId 关联查询（保持原有逻辑）
        List<InternshipApply> applies = internshipApplyMapper.selectList(
            new LambdaQueryWrapper<InternshipApply>()
                .eq(InternshipApply::getEnterpriseId, currentUserEnterpriseId)
                .eq(InternshipApply::getDeleteFlag, DeleteFlag.NORMAL.getCode())
                .select(InternshipApply::getApplyId)
        );
        
        // 方式2：通过 student.current_enterprise_id 查询（新增）
        List<Student> students = studentMapper.selectList(
            new LambdaQueryWrapper<Student>()
                .eq(Student::getCurrentEnterpriseId, currentUserEnterpriseId)
                .eq(Student::getDeleteFlag, DeleteFlag.NORMAL.getCode())
                .select(Student::getStudentId)
        );
        
        // 合并两种方式的查询结果
        if ((applies != null && !applies.isEmpty()) || (students != null && !students.isEmpty())) {
            List<Long> applyIds = new ArrayList<>();
            if (applies != null && !applies.isEmpty()) {
                applyIds.addAll(applies.stream()
                    .map(InternshipApply::getApplyId)
                    .collect(Collectors.toList()));
            }
            if (students != null && !students.isEmpty()) {
                List<Long> studentIds = students.stream()
                    .map(Student::getStudentId)
                    .collect(Collectors.toList());
                List<InternshipApply> studentApplies = internshipApplyMapper.selectList(
                    new LambdaQueryWrapper<InternshipApply>()
                        .in(InternshipApply::getStudentId, studentIds)
                        .eq(InternshipApply::getDeleteFlag, DeleteFlag.NORMAL.getCode())
                        .select(InternshipApply::getApplyId)
                );
                if (studentApplies != null && !studentApplies.isEmpty()) {
                    applyIds.addAll(studentApplies.stream()
                        .map(InternshipApply::getApplyId)
                        .collect(Collectors.toList()));
                }
            }
            if (!applyIds.isEmpty()) {
                wrapper.in(Attendance::getApplyId, applyIds);
            } else {
                wrapper.eq(Attendance::getAttendanceId, -1L);
            }
        } else {
            wrapper.eq(Attendance::getAttendanceId, -1L);
        }
    }
}
```

## 三、实施步骤

### 3.1 数据库迁移

1. 执行 SQL 脚本，添加新字段
2. 迁移现有数据：
   - 对于 `status = 3` (已录用) 的申请，如果学生已开始实习，设置 `student_confirm_status = 1`
   - 更新学生的 `current_apply_id` 和 `current_enterprise_id`

### 3.2 后端开发

1. 修改 `Student` 实体类，添加新字段
2. 修改 `InternshipApply` 实体类，添加新字段
3. 实现学生确认上岗功能
4. 实现学生申请离职功能
5. 实现班主任审核解绑功能
6. 修改考勤签到/签退逻辑
7. 优化企业查询考勤逻辑
8. 添加获取当前实习企业的接口

### 3.3 前端开发

1. 在"我的面试"页面添加"确认上岗"按钮
2. 在"实习申请"页面添加"确认上岗"按钮
3. 创建"我的实习"页面，显示当前实习企业信息
4. 添加"申请离职"功能
5. 在班主任/学院负责人页面添加"审核解绑"功能
6. 修改考勤页面，使用新的逻辑

### 3.4 测试

1. 测试学生确认上岗流程
2. 测试学生申请离职流程
3. 测试班主任审核解绑流程
4. 测试考勤记录的正确绑定
5. 测试企业端能正确查看考勤记录

## 四、流程完善性分析

### 4.1 当前流程的问题

1. **状态流转不清晰**：
   - 面试通过后直接就是已录用，缺少学生确认环节
   - 没有明确的"实习中"状态

2. **数据绑定不明确**：
   - 学生可能有多条申请，不清楚哪条是当前实习
   - 考勤记录绑定逻辑不够清晰

3. **离职流程缺失**：
   - 学生无法主动离职
   - 没有审核机制

### 4.2 优化后的流程

1. **清晰的状态流转**：
   - 面试通过 → 企业录用 → 学生确认上岗 → 实习中
   - 每个状态都有明确的含义和操作

2. **明确的数据绑定**：
   - 学生表有 `current_apply_id` 和 `current_enterprise_id`
   - 考勤记录绑定到 `current_apply_id`

3. **完整的离职流程**：
   - 学生申请离职 → 班主任审核 → 解绑企业

### 4.3 其他优化建议

1. **添加实习开始/结束时间**：
   - 在申请表中添加 `internship_start_date` 和 `internship_end_date`
   - 用于计算实习时长和考勤统计

2. **添加实习评价功能**：
   - 实习结束后，企业和学生可以互相评价
   - 评价结果影响后续申请

3. **添加实习证明生成**：
   - 实习结束后，自动生成实习证明
   - 包含实习时长、企业信息、评价等

4. **优化考勤统计**：
   - 按实习企业统计考勤
   - 支持导出考勤报表

## 五、总结

通过以上优化，可以解决以下问题：

1. ✅ **考勤数据权限问题**：企业端能正确查看学生的考勤记录
2. ✅ **面试通过后的流程**：添加了学生确认上岗功能
3. ✅ **学生绑定企业**：通过 `current_apply_id` 和 `current_enterprise_id` 明确绑定
4. ✅ **离职/解绑功能**：完整的离职申请和审核流程
5. ✅ **流程完善性**：清晰的状态流转和操作流程

建议按照实施步骤逐步推进，确保每个功能都经过充分测试。

