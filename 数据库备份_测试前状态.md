# 数据库备份 - 测试前状态

**备份时间**: 2025-11-29  
**数据库**: internship_management_db  
**目的**: 记录"结束实习"功能测试前的数据状态，用于测试后回滚

---

## 一、关键表数据快照

### 1. internship_apply（实习申请表）

#### 表结构
- `apply_id`: bigint (主键, 自增)
- `student_id`: bigint
- `user_id`: bigint
- `apply_type`: tinyint(1) - 1=合作企业, 2=自主实习
- `status`: tinyint(1) - 状态码
- `internship_start_date`: date - 实习开始日期
- `internship_end_date`: date - 实习结束日期
- `unbind_status`: int - 解绑状态
- `unbind_audit_opinion`: varchar(500) - 解绑备注（结束实习时可能更新）
- `mentor_id`: bigint - 企业导师ID
- `delete_flag`: tinyint(1) - 删除标志

#### 当前数据记录

**记录1: apply_id = 21**
```json
{
  "apply_id": 21,
  "student_id": 66,
  "user_id": 128,
  "plan_id": 6,
  "apply_type": 2,
  "enterprise_id": 11,
  "post_id": null,
  "status": 11,
  "internship_start_date": "2025-11-27",
  "internship_end_date": null,
  "unbind_status": 0,
  "unbind_audit_opinion": null,
  "mentor_id": null,
  "delete_flag": 0,
  "create_time": "2025-11-28 13:10:24",
  "update_time": "2025-11-29 06:52:11"
}
```
**说明**: 自主实习，状态=11（实习中），未结束

**记录2: apply_id = 22**
```json
{
  "apply_id": 22,
  "student_id": 67,
  "user_id": 129,
  "plan_id": 6,
  "apply_type": 1,
  "enterprise_id": 10,
  "post_id": 10,
  "status": 3,
  "internship_start_date": "2025-09-10",
  "internship_end_date": "2026-01-04",
  "unbind_status": 0,
  "unbind_audit_opinion": null,
  "mentor_id": 11,
  "delete_flag": 0,
  "create_time": "2025-11-28 13:10:50",
  "update_time": "2025-11-28 13:10:50"
}
```
**说明**: 合作企业实习，状态=3（已录用），未结束，有企业导师

---

### 2. student_info（学生信息表）

#### 表结构
- `student_id`: bigint (主键, 自增)
- `user_id`: bigint
- `student_no`: varchar(50)
- `current_apply_id`: bigint - 当前实习申请ID
- `current_enterprise_id`: bigint - 当前企业ID
- `internship_status`: int - 实习状态（0=未开始, 1=实习中, 3=已结束）

#### 当前数据记录

**记录1: student_id = 66**
```json
{
  "student_id": 66,
  "user_id": 128,
  "student_no": "2021001001",
  "class_id": 20,
  "current_apply_id": 21,
  "current_enterprise_id": 11,
  "internship_status": 1
}
```
**说明**: 学生张三，实习中，关联申请ID=21

**记录2: student_id = 67**
```json
{
  "student_id": 67,
  "user_id": 129,
  "student_no": "2021001002",
  "class_id": 20,
  "current_apply_id": 22,
  "current_enterprise_id": 10,
  "internship_status": 1
}
```
**说明**: 学生李四，实习中，关联申请ID=22

---

### 3. enterprise_evaluation（企业评价表）

#### 当前数据
**无记录** - 当前没有企业评价数据

---

### 4. school_evaluation（学校评价表）

#### 当前数据
**无记录** - 当前没有学校评价数据

---

### 5. user_info（用户信息表）- 相关用户

#### 当前数据记录

**用户1: user_id = 126（班主任）**
```json
{
  "user_id": 126,
  "username": "pku_teacher1",
  "real_name": "刘老师",
  "phone": "13800003001"
}
```
**说明**: 班主任，可以操作自主实习结束

**用户2: user_id = 128（学生张三）**
```json
{
  "user_id": 128,
  "username": "2021001001",
  "real_name": "张三",
  "phone": "13800004001"
}
```
**说明**: 学生张三，关联 student_id=66

**用户3: user_id = 129（学生李四）**
```json
{
  "user_id": 129,
  "username": "2021001002",
  "real_name": "李四",
  "phone": "13800004002"
}
```
**说明**: 学生李四，关联 student_id=67

---

### 6. enterprise_mentor_info（企业导师信息表）

#### 当前数据记录

**企业导师: mentor_id = 11**
```json
{
  "mentor_id": 11,
  "user_id": 137,
  "enterprise_id": 10
}
```
**说明**: 企业导师，关联企业ID=10（腾讯科技），可以操作合作企业实习结束

---

### 7. enterprise_info（企业信息表）

#### 当前数据记录

**企业1: enterprise_id = 10**
```json
{
  "enterprise_id": 10,
  "enterprise_name": "腾讯科技"
}
```
**说明**: 合作企业，关联申请ID=22

**企业2: enterprise_id = 11**
```json
{
  "enterprise_id": 11,
  "enterprise_name": "测试自主实习"
}
```
**说明**: 自主实习企业名称（学生填写），关联申请ID=21

---

## 二、关键状态字段说明

### internship_apply.status 状态码
- **合作企业 (apply_type=1)**:
  - 0: 待审核
  - 1: 已通过
  - 2: 已拒绝
  - 3: 已录用
  - 4: 已拒绝录用
  - 5: 已取消
  - **7: 实习结束** (测试目标状态)

- **自主实习 (apply_type=2)**:
  - 0: 待审核
  - 1: 已通过
  - 2: 已拒绝
  - 5: 已取消
  - 11: 实习中
  - **13: 实习结束** (测试目标状态)

### student_info.internship_status 状态码
- 0: 未开始
- 1: 实习中
- **3: 已结束** (测试目标状态)

### internship_apply.unbind_status 解绑状态
- 0: 在职
- 1: 已申请解绑
- 2: 已解绑
- 3: 解绑已拒绝
- 4: 企业已审批

**重要**: 根据"方案A"，结束实习时**不更新** `unbind_status`，保持原值。

---

## 三、测试场景数据

### 场景1: 合作企业实习结束（apply_id=22）
- **当前状态**: status=3（已录用）, internship_status=1（实习中）
- **目标状态**: status=7（实习结束）, internship_status=3（已结束）
- **操作角色**: 企业导师（mentor_id=11）或企业管理员
- **学生**: 李四（student_id=67, student_no=2021001002）

### 场景2: 自主实习结束（apply_id=21）
- **当前状态**: status=11（实习中）, internship_status=1（实习中）
- **目标状态**: status=13（实习结束）, internship_status=3（已结束）
- **操作角色**: 班主任
- **学生**: 张三（student_id=66, student_no=2021001001）

---

## 四、回滚SQL脚本

### 回滚 apply_id=21（自主实习）
```sql
-- 回滚实习申请状态
UPDATE internship_apply 
SET 
  status = 11,
  internship_end_date = NULL,
  unbind_audit_opinion = NULL,
  update_time = NOW()
WHERE apply_id = 21;

-- 回滚学生实习状态
UPDATE student_info 
SET 
  internship_status = 1,
  update_time = NOW()
WHERE student_id = 66;
```

### 回滚 apply_id=22（合作企业实习）
```sql
-- 回滚实习申请状态
UPDATE internship_apply 
SET 
  status = 3,
  internship_end_date = '2026-01-04',  -- 恢复原值
  unbind_audit_opinion = NULL,
  update_time = NOW()
WHERE apply_id = 22;

-- 回滚学生实习状态
UPDATE student_info 
SET 
  internship_status = 1,
  update_time = NOW()
WHERE student_id = 67;
```

---

## 五、数据统计

- **实习申请总数**: 2条（未删除）
- **学生总数**: 2条（未删除）
- **企业评价总数**: 0条
- **学校评价总数**: 0条

---

## 六、注意事项

1. **状态联动字段**:
   - `internship_apply.status` - 必须更新
   - `internship_apply.internship_end_date` - 必须更新
   - `internship_apply.unbind_audit_opinion` - 可选更新（如果有备注）
   - `student_info.internship_status` - 必须更新
   - `internship_apply.unbind_status` - **保持不变**
   - `student_info.current_apply_id` - **保持不变**
   - `student_info.current_enterprise_id` - **保持不变**

2. **测试后回滚**:
   - 使用上述回滚SQL脚本恢复数据
   - 确保所有状态字段都恢复到测试前状态
   - 检查 `update_time` 字段是否正常更新

3. **数据完整性**:
   - 确保外键关系正确
   - 确保逻辑删除标志正确
   - 确保时间戳字段正确

---

**备份完成时间**: 2025-11-29  
**备份人**: AI Assistant  
**用途**: "结束实习"功能测试数据回滚

