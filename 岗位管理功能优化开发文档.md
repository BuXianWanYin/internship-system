# 岗位管理功能优化开发文档

## 一、需求概述

### 1.1 背景
当前岗位管理功能存在以下问题：
1. 岗位审核通过后自动发布，企业管理员无法控制发布时间
2. 岗位达到招聘人数后，学生仍能看到该岗位
3. 不同角色查询岗位时的过滤逻辑需要优化

### 1.2 目标
1. 修改审核流程：学校审核通过后，岗位状态为"已通过"，由企业管理员手动发布
2. 允许企业管理员取消发布已发布的岗位
3. 允许企业管理员下架岗位（即使报名人数和录用人数已满）
4. 学生端查询时，自动过滤掉招聘人数已满的岗位
5. 优化不同角色查询岗位时的过滤逻辑

---

## 二、功能设计

### 2.1 岗位状态流转

```
待审核(0) 
  ↓ [学校管理员审核通过]
已通过(1) 
  ↓ [企业管理员发布]
已发布(3) ←→ [企业管理员取消发布] → 已通过(1)
  ↓ [企业管理员下架]
已关闭(4)
```

**状态说明：**
- **待审核(0)**：企业管理员创建岗位，等待学校管理员审核
- **已通过(1)**：学校管理员审核通过，等待企业管理员发布（或取消发布后）
- **已拒绝(2)**：学校管理员审核拒绝
- **已发布(3)**：岗位已发布，学生可以申请（且招聘人数未满）
- **已关闭(4)**：岗位已下架，不再接受申请

### 2.2 功能点

#### 2.2.1 取消发布功能
- **触发条件**：岗位状态为"已发布"(3)
- **操作角色**：企业管理员
- **业务规则**：
  - 取消发布后，岗位状态变为"已通过"(1)
  - 学生无法再看到该岗位
  - 企业管理员可以重新发布该岗位

#### 2.2.2 下架岗位功能
- **触发条件**：岗位状态为"已发布"(3)
- **操作角色**：企业管理员
- **业务规则**：
  - 下架后，岗位状态变为"已关闭"(4)
  - 无论报名人数和录用人数是否已满，都可以下架
  - 下架后，学生无法再看到该岗位
  - 下架后，企业管理员无法重新发布（需要重新审核）

#### 2.2.3 岗位查询过滤规则

| 角色 | 查询条件 | 说明 |
|------|---------|------|
| **企业管理员** | `enterprise_id = 当前企业ID` | 只能查看自己企业的所有岗位（所有状态） |
| **学生** | `status = 3 AND enterprise_id IN (合作企业ID列表) AND (accepted_count < recruit_count OR recruit_count IS NULL)` | 只能查看已发布的合作企业岗位，且招聘人数未满 |
| **学校管理员** | `enterprise_id IN (合作企业ID列表)` | 可以查看所有合作企业的岗位（所有状态） |
| **系统管理员** | 无限制 | 可以查看所有岗位（所有状态） |
| **班主任/学院负责人** | `enterprise_id IN (合作企业ID列表)` | 可以查看所有合作企业的岗位（所有状态） |

**学生端过滤逻辑说明：**
- 只显示状态为"已发布"(3)的岗位
- 只显示合作企业的岗位
- **自动过滤掉招聘人数已满的岗位**：`accepted_count >= recruit_count` 的岗位不显示
- 如果 `recruit_count` 为 null，则认为未满，显示该岗位
- 如果 `accepted_count` 为 null，则认为0，显示该岗位

---

## 三、技术实现

### 3.1 后端实现

#### 3.1.1 新增接口

**1. 取消发布岗位接口**

```java
@ApiOperation("取消发布岗位")
@PreAuthorize("hasRole('ROLE_ENTERPRISE_ADMIN')")
@PostMapping("/{postId}/unpublish")
public Result<?> unpublishPost(
        @ApiParam(value = "岗位ID", required = true) @PathVariable Long postId) {
    internshipPostService.unpublishPost(postId);
    return Result.success("取消发布成功");
}
```

**2. 下架岗位接口（复用现有的closePost接口）**

```java
@ApiOperation("下架岗位")
@PreAuthorize("hasRole('ROLE_ENTERPRISE_ADMIN')")
@PostMapping("/{postId}/close")
public Result<?> closePost(
        @ApiParam(value = "岗位ID", required = true) @PathVariable Long postId) {
    internshipPostService.closePost(postId);
    return Result.success("下架成功");
}
```

#### 3.1.2 Service层实现

**1. 取消发布方法**

```java
@Override
@Transactional(rollbackFor = Exception.class)
public boolean unpublishPost(Long postId) {
    if (postId == null) {
        throw new BusinessException("岗位ID不能为空");
    }
    
    InternshipPost post = this.getById(postId);
    EntityValidationUtil.validateEntityExists(post, "岗位");
    
    // 数据权限：企业管理员只能取消发布自己企业的岗位
    Long currentUserEnterpriseId = dataPermissionUtil.getCurrentUserEnterpriseId();
    if (currentUserEnterpriseId != null && !currentUserEnterpriseId.equals(post.getEnterpriseId())) {
        throw new BusinessException("无权取消发布该岗位");
    }
    
    // 只有已发布的才能取消发布
    EntityValidationUtil.validateStatusEquals(post, InternshipPostStatus.PUBLISHED.getCode(), 
        "岗位", "只有已发布的岗位才能取消发布");
    
    // 更新状态为已通过（审核通过但未发布）
    post.setStatus(InternshipPostStatus.APPROVED.getCode());
    // 清空发布时间
    post.setPublishTime(null);
    
    return this.updateById(post);
}
```

**2. 下架方法（修改现有closePost方法）**

```java
@Override
@Transactional(rollbackFor = Exception.class)
public boolean closePost(Long postId) {
    if (postId == null) {
        throw new BusinessException("岗位ID不能为空");
    }
    
    InternshipPost post = this.getById(postId);
    EntityValidationUtil.validateEntityExists(post, "岗位");
    
    // 数据权限：企业管理员只能下架自己企业的岗位
    Long currentUserEnterpriseId = dataPermissionUtil.getCurrentUserEnterpriseId();
    if (currentUserEnterpriseId != null && !currentUserEnterpriseId.equals(post.getEnterpriseId())) {
        throw new BusinessException("无权下架该岗位");
    }
    
    // 只有已发布的才能下架（无论报名人数和录用人数是否已满）
    EntityValidationUtil.validateStatusEquals(post, InternshipPostStatus.PUBLISHED.getCode(), 
        "岗位", "只有已发布的岗位才能下架");
    
    // 更新状态为已关闭
    post.setStatus(InternshipPostStatus.CLOSED.getCode());
    post.setCloseTime(LocalDateTime.now());
    
    return this.updateById(post);
}
```

#### 3.1.3 查询过滤优化

**修改 `getPostPage` 方法，优化过滤逻辑：**

```java
@Override
public Page<InternshipPost> getPostPage(Page<InternshipPost> page, InternshipPostQueryDTO queryDTO) {
    LambdaQueryWrapper<InternshipPost> wrapper = new LambdaQueryWrapper<>();
    
    // 只查询未删除的数据
    QueryWrapperUtil.notDeleted(wrapper, InternshipPost::getDeleteFlag);
    
    // 数据权限过滤
    Long currentUserEnterpriseId = dataPermissionUtil.getCurrentUserEnterpriseId();
    List<Long> cooperationEnterpriseIds = dataPermissionUtil.getCooperationEnterpriseIds();
    
    // 企业管理员：只能查看自己企业的岗位（所有状态）
    if (currentUserEnterpriseId != null) {
        wrapper.eq(InternshipPost::getEnterpriseId, currentUserEnterpriseId);
    }
    // 学生端：只显示已发布的合作企业岗位
    else if (queryDTO != null && queryDTO.getCooperationOnly() != null && queryDTO.getCooperationOnly()) {
        if (cooperationEnterpriseIds == null || cooperationEnterpriseIds.isEmpty()) {
            // 如果没有合作关系，返回空列表
            return page;
        }
        wrapper.in(InternshipPost::getEnterpriseId, cooperationEnterpriseIds);
        // 学生只能看到已发布的岗位
        wrapper.eq(InternshipPost::getStatus, InternshipPostStatus.PUBLISHED.getCode());
        // 过滤掉招聘人数已满的岗位（acceptedCount >= recruitCount）
        // 逻辑：如果recruitCount为null，则认为未满；如果acceptedCount为null，则认为0
        // SQL: (recruit_count IS NULL) OR (IFNULL(accepted_count, 0) < recruit_count)
        wrapper.and(w -> w.isNull(InternshipPost::getRecruitCount)
                .or()
                .apply("IFNULL(accepted_count, 0) < recruit_count"));
    }
    // 学校管理员、班主任、学院负责人：只显示合作企业的岗位（所有状态）
    else if (EntityValidationUtil.isNotEmpty(cooperationEnterpriseIds)) {
        wrapper.in(InternshipPost::getEnterpriseId, cooperationEnterpriseIds);
    }
    // 系统管理员：不添加企业过滤，可以查看所有岗位
    
    // 条件查询
    if (queryDTO != null) {
        if (StringUtils.hasText(queryDTO.getPostName())) {
            wrapper.like(InternshipPost::getPostName, queryDTO.getPostName());
        }
        if (queryDTO.getEnterpriseId() != null) {
            wrapper.eq(InternshipPost::getEnterpriseId, queryDTO.getEnterpriseId());
        }
        if (queryDTO.getStatus() != null) {
            wrapper.eq(InternshipPost::getStatus, queryDTO.getStatus());
        }
    }
    
    // 按创建时间倒序
    wrapper.orderByDesc(InternshipPost::getCreateTime);
    
    Page<InternshipPost> result = this.page(page, wrapper);
    
    // 填充关联字段
    if (EntityValidationUtil.hasRecords(result)) {
        for (InternshipPost post : result.getRecords()) {
            fillPostRelatedFields(post);
        }
    }
    
    return result;
}
```

### 3.2 前端实现

#### 3.2.1 企业管理员岗位管理页面

**文件：`internship-web/src/views/enterprise/InternshipPostManagement.vue`**

**1. 添加取消发布按钮**

```vue
<el-button
  v-if="row.status === 3 && hasAnyRole(['ROLE_ENTERPRISE_ADMIN'])"
  link
  type="warning"
  size="small"
  @click="handleUnpublish(row)"
>
  取消发布
</el-button>
```

**2. 添加下架按钮（修改现有的关闭按钮文案）**

```vue
<el-button
  v-if="row.status === 3 && hasAnyRole(['ROLE_ENTERPRISE_ADMIN'])"
  link
  type="danger"
  size="small"
  @click="handleClose(row)"
>
  下架
</el-button>
```

**3. 添加取消发布方法**

```javascript
// 取消发布
const handleUnpublish = async (row) => {
  try {
    await ElMessageBox.confirm(
      '取消发布后，学生将无法看到该岗位，但您可以重新发布。确定要取消发布吗？',
      '取消发布确认',
      {
        type: 'warning',
        confirmButtonText: '确定',
        cancelButtonText: '取消'
      }
    )
    const res = await postApi.unpublishPost(row.postId)
    if (res.code === 200) {
      ElMessage.success('取消发布成功')
      loadData()
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('取消发布失败:', error)
      ElMessage.error(error.response?.data?.message || '取消发布失败')
    }
  }
}
```

**4. 修改下架方法（修改现有的handleClose方法）**

```javascript
// 下架岗位
const handleClose = async (row) => {
  try {
    await ElMessageBox.confirm(
      `确定要下架该岗位吗？下架后，学生将无法看到该岗位，且无法重新发布。\n\n当前状态：\n- 招聘人数：${row.recruitCount || 0}\n- 已申请：${row.appliedCount || 0}\n- 已录用：${row.acceptedCount || 0}`,
      '下架岗位确认',
      {
        type: 'warning',
        confirmButtonText: '确定下架',
        cancelButtonText: '取消'
      }
    )
    const res = await postApi.closePost(row.postId)
    if (res.code === 200) {
      ElMessage.success('下架成功')
      loadData()
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('下架失败:', error)
      ElMessage.error(error.response?.data?.message || '下架失败')
    }
  }
}
```

#### 3.2.2 API接口

**文件：`internship-web/src/api/internship/post.js`**

```javascript
// 取消发布岗位
unpublishPost(postId) {
  return request.post(`/internship/post/${postId}/unpublish`)
},

// 下架岗位（复用现有的closePost方法）
closePost(postId) {
  return request.post(`/internship/post/${postId}/close`)
}
```

---

## 四、数据库变更

### 4.1 无需数据库变更

当前数据库表结构已支持所需功能，无需修改。

### 4.2 数据说明

- `status` 字段：岗位状态（0-待审核，1-已通过，2-已拒绝，3-已发布，4-已关闭）
- `publish_time` 字段：发布时间（取消发布时清空）
- `close_time` 字段：关闭时间（下架时设置）

---

## 五、业务规则说明

### 5.1 审核流程规则

1. **学校管理员审核通过**：
   - 岗位状态变为"已通过"(1)
   - **不自动发布**，等待企业管理员手动发布
   - 企业管理员可以在岗位管理页面看到"发布"按钮

2. **企业管理员发布**：
   - 只有状态为"已通过"(1)的岗位才能发布
   - 发布后状态变为"已发布"(3)
   - 设置发布时间
   - 学生可以看到该岗位（如果招聘人数未满）

### 5.2 取消发布规则

1. **允许条件**：
   - 岗位状态必须为"已发布"(3)
   - 操作人必须是该岗位所属企业的管理员

2. **操作结果**：
   - 岗位状态变为"已通过"(1)
   - 发布时间清空
   - 学生无法再看到该岗位
   - 企业管理员可以重新发布该岗位

3. **限制**：
   - 已关闭的岗位不能取消发布
   - 待审核、已拒绝、已通过的岗位不能取消发布

### 5.3 下架规则

1. **允许条件**：
   - 岗位状态必须为"已发布"(3)
   - 操作人必须是该岗位所属企业的管理员
   - **无论报名人数和录用人数是否已满，都可以下架**

2. **操作结果**：
   - 岗位状态变为"已关闭"(4)
   - 关闭时间设置为当前时间
   - 学生无法再看到该岗位
   - 企业管理员无法重新发布（需要重新审核）

3. **限制**：
   - 已关闭的岗位不能再次下架
   - 待审核、已拒绝、已通过的岗位不能下架

### 5.4 查询过滤规则

#### 5.4.1 学生端过滤规则

1. **状态过滤**：
   - 只显示状态为"已发布"(3)的岗位

2. **企业过滤**：
   - 只显示合作企业的岗位

3. **招聘人数过滤**：
   - **自动过滤掉招聘人数已满的岗位**
   - 判断条件：`accepted_count >= recruit_count`
   - 特殊情况处理：
     - 如果 `recruit_count` 为 null，则认为未满，显示该岗位
     - 如果 `accepted_count` 为 null，则认为0，显示该岗位

4. **示例**：
   - 岗位A：招聘5人，已录用3人 → 显示
   - 岗位B：招聘5人，已录用5人 → 不显示
   - 岗位C：招聘5人，已录用6人 → 不显示
   - 岗位D：招聘人数未设置 → 显示

#### 5.4.2 其他角色过滤规则

1. **企业管理员**：
   - 只能查看自己企业的岗位
   - 可以查看所有状态的岗位

2. **学生**：
   - 只能查看已发布的岗位（status = 3）
   - 只能查看合作企业的岗位
   - **自动过滤掉招聘人数已满的岗位**
   - 如果学校没有合作企业，返回空列表

3. **学校管理员/班主任/学院负责人**：
   - 只能查看合作企业的岗位
   - 可以查看所有状态的岗位

4. **系统管理员**：
   - 可以查看所有企业的岗位
   - 可以查看所有状态的岗位

---

## 六、测试用例

### 6.1 审核流程测试

| 测试场景 | 前置条件 | 操作 | 预期结果 |
|---------|---------|------|---------|
| 审核通过 | 岗位状态为"待审核" | 学校管理员审核通过 | 状态变为"已通过"，不自动发布 |
| 企业发布 | 岗位状态为"已通过" | 企业管理员点击"发布" | 状态变为"已发布"，学生可以看到 |

### 6.2 取消发布功能测试

| 测试场景 | 前置条件 | 操作 | 预期结果 |
|---------|---------|------|---------|
| 正常取消发布 | 岗位状态为"已发布" | 企业管理员点击"取消发布" | 状态变为"已通过"，学生无法看到 |
| 无权限取消发布 | 岗位状态为"已发布"，但非本企业管理员 | 点击"取消发布" | 提示"无权取消发布该岗位" |
| 状态不允许 | 岗位状态为"已关闭" | 点击"取消发布" | 提示"只有已发布的岗位才能取消发布" |
| 重新发布 | 岗位状态为"已通过"（取消发布后） | 企业管理员点击"发布" | 状态变为"已发布"，学生可以看到 |

### 6.3 下架功能测试

| 测试场景 | 前置条件 | 操作 | 预期结果 |
|---------|---------|------|---------|
| 正常下架 | 岗位状态为"已发布" | 企业管理员点击"下架" | 状态变为"已关闭"，学生无法看到 |
| 满员下架 | 岗位状态为"已发布"，报名人数和录用人数已满 | 企业管理员点击"下架" | 状态变为"已关闭"，下架成功 |
| 无权限下架 | 岗位状态为"已发布"，但非本企业管理员 | 点击"下架" | 提示"无权下架该岗位" |
| 状态不允许 | 岗位状态为"已关闭" | 点击"下架" | 提示"只有已发布的岗位才能下架" |

### 6.4 查询过滤测试

| 测试场景 | 角色 | 查询条件 | 预期结果 |
|---------|------|---------|---------|
| 企业管理员查询 | 企业管理员 | 无 | 只返回本企业的所有岗位（所有状态） |
| 学生查询已满岗位 | 学生 | status=3, cooperationOnly=true | 不返回招聘人数已满的岗位 |
| 学生查询未满岗位 | 学生 | status=3, cooperationOnly=true | 返回已发布的合作企业岗位（招聘人数未满） |
| 学校管理员查询 | 学校管理员 | 无 | 返回所有合作企业的岗位（所有状态） |
| 系统管理员查询 | 系统管理员 | 无 | 返回所有企业的岗位（所有状态） |

| 测试场景 | 角色 | 查询条件 | 预期结果 |
|---------|------|---------|---------|
| 企业管理员查询 | 企业管理员 | 无 | 只返回本企业的所有岗位（所有状态） |
| 学生查询 | 学生 | status=3, cooperationOnly=true | 只返回已发布的合作企业岗位 |
| 学校管理员查询 | 学校管理员 | 无 | 返回所有合作企业的岗位（所有状态） |
| 系统管理员查询 | 系统管理员 | 无 | 返回所有企业的岗位（所有状态） |

---

## 七、实施计划

### 7.1 开发步骤

1. **后端开发**（预计2小时）
   - [x] 修改 `auditPost` 方法（审核通过后不自动发布）
   - [ ] 实现 `unpublishPost` 方法
   - [ ] 修改 `closePost` 方法（移除满员限制）
   - [ ] 优化 `getPostPage` 方法的过滤逻辑（学生端过滤已满岗位）
   - [ ] 添加接口文档注释

2. **前端开发**（预计2小时）
   - [ ] 修改岗位管理页面，显示"已通过"状态的岗位可以发布
   - [ ] 添加"取消发布"按钮
   - [ ] 修改"关闭"按钮为"下架"按钮
   - [ ] 实现 `handleUnpublish` 方法
   - [ ] 修改 `handleClose` 方法
   - [ ] 添加API接口方法

3. **测试**（预计1小时）
   - [ ] 功能测试
   - [ ] 权限测试
   - [ ] 边界条件测试

### 7.2 注意事项

1. **数据一致性**：
   - 取消发布时，需要清空 `publish_time` 字段
   - 下架时，需要设置 `close_time` 字段

2. **权限控制**：
   - 确保只有企业管理员可以操作自己企业的岗位
   - 确保学生只能看到已发布的岗位

3. **用户体验**：
   - 操作前需要确认对话框
   - 操作后需要提示成功/失败信息
   - 操作后需要刷新列表

---

## 八、接口文档

### 8.1 取消发布岗位

**接口地址：** `POST /internship/post/{postId}/unpublish`

**权限要求：** `ROLE_ENTERPRISE_ADMIN`

**请求参数：**
- `postId` (Path): 岗位ID

**响应示例：**
```json
{
  "code": 200,
  "message": "取消发布成功",
  "data": null
}
```

### 8.2 下架岗位

**接口地址：** `POST /internship/post/{postId}/close`

**权限要求：** `ROLE_ENTERPRISE_ADMIN`

**请求参数：**
- `postId` (Path): 岗位ID

**响应示例：**
```json
{
  "code": 200,
  "message": "下架成功",
  "data": null
}
```

---

## 九、总结

本开发文档详细说明了岗位管理功能的优化需求，包括：
1. **审核流程优化**：学校审核通过后不自动发布，由企业管理员手动发布
2. **取消发布功能**：允许企业管理员取消已发布的岗位
3. **下架功能**：允许企业管理员下架岗位（无论是否满员）
4. **招聘人数过滤**：学生端自动过滤掉招聘人数已满的岗位
5. **查询过滤优化**：不同角色查询岗位时的过滤逻辑

实施后，将提升岗位管理的灵活性和用户体验，同时避免学生申请已满员的岗位。

