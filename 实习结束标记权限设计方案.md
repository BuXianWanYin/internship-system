# 实习结束标记权限设计方案

## 一、问题分析

### 1.1 业务场景
实习结束标记涉及不同角色，需要区分两种实习类型：

**合作企业实习：**
- **企业导师/企业管理员**：直接管理学生实习，了解实习实际情况
- **班主任**：管理学生，需要了解学生实习状态

**自主实习：**
- **学生**：自主实习的当事人，了解实习实际情况
- **班主任**：管理学生，需要了解学生实习状态
- **无企业参与**：自主实习没有企业导师或企业管理员

### 1.2 核心问题
应该由谁来标记实习结束？这涉及到：
- 谁更了解实习实际情况
- 谁有权限决定实习结束
- 如何保证数据的准确性和及时性
- **需要区分合作企业实习和自主实习的不同处理方式**

## 二、方案对比

### 方案A：区分实习类型，分别处理（推荐）

#### 2.1 方案描述
根据实习类型采用不同的标记方式：
- **合作企业实习**：由企业导师/企业管理员标记
- **自主实习**：由班主任标记（或学生申请，班主任审核）

#### 2.2 优点
1. **信息准确性高**
   - 合作企业：企业导师直接管理学生，最清楚实习是否真的结束
   - 自主实习：学生和班主任了解实习实际情况
   - 了解实习的实际完成情况

2. **符合业务逻辑**
   - 合作企业：实习结束通常由企业决定（实习期到了、提前离职等）
   - 自主实习：没有企业参与，应该由学校（班主任）管理
   - 企业是合作企业实习的实际执行方，有责任确认实习完成情况

3. **操作及时性**
   - 合作企业：企业导师可以第一时间标记结束
   - 自主实习：班主任可以及时标记结束
   - 不需要等待不必要的确认

4. **责任明确**
   - 合作企业：企业负责确认实习完成
   - 自主实习：班主任负责确认实习完成
   - 学校负责审核和评价
   - 职责分离清晰

5. **适应不同场景**
   - 区分合作企业和自主实习的不同特点
   - 针对不同场景采用最合适的处理方式

#### 2.3 缺点
1. **合作企业依赖企业操作**
   - 如果企业忘记标记，状态可能不准确
   - 需要提醒机制

2. **自主实习依赖班主任**
   - 如果班主任忘记标记，状态可能不准确
   - 需要提醒机制

#### 2.4 适用场景
- 需要区分不同实习类型
- 企业配合度高（合作企业）
- 班主任管理规范（自主实习）

---

### 方案B：统一由班主任标记

#### 2.1 方案描述
无论是合作企业实习还是自主实习，都由班主任统一标记实习结束。

#### 2.2 优点
1. **学校主导**
   - 学校统一管理所有学生实习状态
   - 班主任可以主动控制流程
   - 统一管理，便于统计

2. **数据集中管理**
   - 所有状态变更由学校统一管理
   - 便于统计和监控
   - 管理简单

#### 2.3 缺点
1. **合作企业信息不准确**
   - 班主任可能不清楚合作企业实习是否真的结束
   - 需要向企业确认，增加沟通成本
   - 不符合业务逻辑（企业应该确认）

2. **操作不及时**
   - 合作企业：班主任需要等待企业反馈
   - 可能延迟标记

3. **不符合业务逻辑**
   - 合作企业实习结束应该由企业确认
   - 学校应该负责审核和评价，而不是确认结束

#### 2.4 适用场景
- 企业配合度低
- 需要学校统一管理
- 企业不负责确认实习完成
- **仅适用于自主实习**

---

### 方案C：双方都可以标记（推荐备选，仅合作企业）

#### 2.1 方案描述
**合作企业实习**：企业导师和班主任都可以标记实习结束，但需要设置优先级或确认机制。
**自主实习**：由班主任标记（或学生申请，班主任审核）。

#### 2.2 优点
1. **灵活性高**
   - 企业可以主动标记
   - 班主任也可以主动标记（如企业不配合）

2. **容错性强**
   - 一方忘记操作，另一方可以补充
   - 提高操作成功率

3. **适应不同场景**
   - 正常情况：企业标记
   - 特殊情况：班主任标记

#### 2.3 缺点
1. **可能重复操作**
   - 需要防止重复标记
   - 需要状态检查

2. **责任不明确**
   - 双方都可以操作，责任分散
   - 可能出现推诿

3. **需要协调机制**
   - 如果双方标记的结束日期不一致，需要处理
   - 可能需要确认机制

#### 2.4 实现方式

**方式1：先到先得**
- 谁先标记谁生效
- 已标记后不能再标记

**方式2：企业优先**
- 企业标记后，班主任不能再标记
- 班主任标记后，企业可以覆盖（需要确认）

**方式3：需要双方确认**
- 一方标记后，需要另一方确认
- 双方都确认后才生效

#### 2.5 适用场景
- 需要灵活处理各种情况
- 企业配合度不确定
- 需要容错机制

---

### 方案D：企业标记 + 班主任审核（最严格）

#### 2.1 方案描述
企业导师标记实习结束，但需要班主任审核确认。

#### 2.2 优点
1. **双重确认**
   - 企业标记，班主任审核
   - 保证数据准确性

2. **责任明确**
   - 企业负责标记
   - 班主任负责审核

#### 2.3 缺点
1. **流程复杂**
   - 需要两步操作
   - 增加流程时间

2. **可能延迟**
   - 需要等待班主任审核
   - 影响及时性

#### 2.4 适用场景
- 对数据准确性要求极高
- 需要严格审核流程
- 可以接受较长的流程时间

---

## 三、推荐方案

### 3.1 主推荐：方案A（区分实习类型，分别处理）+ 提醒机制

**理由：**
1. **符合业务逻辑**：
   - 合作企业：实习结束应该由企业确认
   - 自主实习：没有企业参与，应该由班主任管理
2. **信息准确**：
   - 合作企业：企业最清楚实习实际情况
   - 自主实习：学生和班主任了解实习实际情况
3. **操作及时**：
   - 合作企业：企业可以第一时间标记
   - 自主实习：班主任可以及时标记
4. **职责清晰**：
   - 合作企业：企业负责确认，学校负责审核评价
   - 自主实习：班主任负责确认和审核评价

**实现要点：**
- **合作企业实习**：
  - 只有企业导师/企业管理员可以标记
  - 添加提醒机制：实习结束日期前提醒企业标记
  - 如果企业未及时标记，系统管理员可以介入（兜底）
- **自主实习**：
  - 只有班主任可以标记
  - 添加提醒机制：实习结束日期前提醒班主任标记
  - 如果班主任未及时标记，系统管理员可以介入（兜底）

### 3.2 备选推荐：方案C（双方都可以标记，企业优先，仅合作企业）

**理由：**
1. **灵活性高**：适应不同场景
2. **容错性强**：一方忘记操作，另一方可以补充
3. **企业优先**：正常情况下由企业标记

**实现要点：**
- **合作企业实习**：
  - 企业可以标记（优先）
  - 班主任也可以标记（容错）
  - 企业标记后，班主任不能再标记
  - 班主任标记后，企业可以覆盖（需要确认）
- **自主实习**：
  - 由班主任标记（同方案A）

---

## 四、具体实现建议

### 4.1 方案A实现（区分实习类型，分别处理）

#### 权限设计

**合作企业实习：**
```java
// 可以标记的角色
- 企业管理员（ROLE_ENTERPRISE_ADMIN）
- 企业导师（ROLE_ENTERPRISE_MENTOR）
- 系统管理员（ROLE_SYSTEM_ADMIN）- 作为兜底

// 只能查看的角色
- 班主任（ROLE_CLASS_TEACHER）
- 学校管理员（ROLE_SCHOOL_ADMIN）
- 学院负责人（ROLE_COLLEGE_LEADER）
```

**自主实习：**
```java
// 可以标记的角色
- 班主任（ROLE_CLASS_TEACHER）
- 学校管理员（ROLE_SCHOOL_ADMIN）
- 学院负责人（ROLE_COLLEGE_LEADER）
- 系统管理员（ROLE_SYSTEM_ADMIN）- 作为兜底

// 只能查看的角色
- 学生（ROLE_STUDENT）- 可以查看自己的实习状态
```

#### 提醒机制

**合作企业实习：**
1. **自动提醒**
   - 实习结束日期前3天提醒企业标记
   - 实习结束日期当天提醒
   - 实习结束日期后3天提醒（如果未标记）

2. **手动提醒**
   - 班主任可以发送提醒给企业
   - 管理员可以发送提醒

**自主实习：**
1. **自动提醒**
   - 实习结束日期前3天提醒班主任标记
   - 实习结束日期当天提醒
   - 实习结束日期后3天提醒（如果未标记）

2. **手动提醒**
   - 学生可以申请标记结束（需要班主任审核）
   - 管理员可以发送提醒

#### 兜底机制
- **合作企业**：如果企业长期未标记，系统管理员可以标记
- **自主实习**：如果班主任长期未标记，系统管理员可以标记
- 或者可以申请管理员介入

---

### 4.2 方案C实现（双方都可以标记，仅合作企业）

#### 权限设计

**合作企业实习：**
```java
// 可以标记的角色（优先级从高到低）
1. 企业管理员（ROLE_ENTERPRISE_ADMIN）- 最高优先级
2. 企业导师（ROLE_ENTERPRISE_MENTOR）- 最高优先级
3. 班主任（ROLE_CLASS_TEACHER）- 次优先级
4. 系统管理员（ROLE_SYSTEM_ADMIN）- 兜底
```

**自主实习：**
```java
// 可以标记的角色（同方案A）
- 班主任（ROLE_CLASS_TEACHER）
- 学校管理员（ROLE_SCHOOL_ADMIN）
- 学院负责人（ROLE_COLLEGE_LEADER）
- 系统管理员（ROLE_SYSTEM_ADMIN）- 兜底
```

#### 标记规则

**合作企业实习：**
1. **企业标记**
   - 企业可以随时标记（如果未标记）
   - 企业标记后立即生效
   - 企业标记后，班主任不能再标记

2. **班主任标记**
   - 班主任可以标记（如果企业未标记）
   - 班主任标记后，企业可以覆盖（需要确认）
   - 如果企业覆盖，需要填写覆盖原因

3. **状态检查**
   - 标记前检查是否已标记
   - 如果已标记，提示"该实习已标记为结束"

**自主实习：**
- 由班主任标记（同方案A）
- 学生可以申请标记结束，需要班主任审核

---

## 五、最终建议

### 5.1 推荐方案：方案A（区分实习类型，分别处理）+ 提醒机制

**原因：**
1. **业务逻辑清晰**：
   - 合作企业：实习结束由企业确认，符合实际业务流程
   - 自主实习：没有企业参与，由班主任管理，符合实际情况
2. **信息准确**：
   - 合作企业：企业最清楚实习实际情况
   - 自主实习：学生和班主任了解实习实际情况
3. **职责明确**：
   - 合作企业：企业负责确认，学校负责审核评价
   - 自主实习：班主任负责确认和审核评价
4. **操作及时**：
   - 合作企业：企业可以第一时间标记
   - 自主实习：班主任可以及时标记

**实现要点：**
- **合作企业实习**：
  - 权限：仅企业导师/企业管理员可以标记
  - 提醒：实习结束日期前后自动提醒企业
  - 兜底：系统管理员可以标记（特殊情况）
- **自主实习**：
  - 权限：仅班主任可以标记
  - 提醒：实习结束日期前后自动提醒班主任
  - 兜底：系统管理员可以标记（特殊情况）
  - 可选：学生可以申请标记结束，需要班主任审核

### 5.2 如果企业配合度低：方案C（双方都可以标记，仅合作企业）

**原因：**
1. **灵活性高**：适应不同场景
2. **容错性强**：企业不配合时，班主任可以标记
3. **企业优先**：正常情况下由企业标记

**实现要点：**
- **合作企业实习**：
  - 企业优先标记
  - 班主任可以容错标记
  - 企业标记后，班主任不能再标记
- **自主实习**：
  - 由班主任标记（同方案A）

---

## 六、权限设计对比表

### 6.1 合作企业实习权限对比

| 方案 | 企业导师 | 企业管理员 | 班主任 | 学校管理员 | 系统管理员 |
|------|---------|-----------|--------|-----------|-----------|
| 方案A | ✅ 标记 | ✅ 标记 | ❌ 查看 | ❌ 查看 | ✅ 标记（兜底） |
| 方案B | ❌ 查看 | ❌ 查看 | ✅ 标记 | ✅ 标记 | ✅ 标记 |
| 方案C | ✅ 标记（优先） | ✅ 标记（优先） | ✅ 标记（容错） | ✅ 标记（容错） | ✅ 标记 |
| 方案D | ✅ 标记 | ✅ 标记 | ✅ 审核 | ✅ 审核 | ✅ 标记 |

### 6.2 自主实习权限对比

| 方案 | 学生 | 班主任 | 学校管理员 | 学院负责人 | 系统管理员 |
|------|------|--------|-----------|-----------|-----------|
| 方案A | ❌ 查看 | ✅ 标记 | ✅ 标记 | ✅ 标记 | ✅ 标记（兜底） |
| 方案B | ❌ 查看 | ✅ 标记 | ✅ 标记 | ✅ 标记 | ✅ 标记 |
| 方案C | ❌ 查看（可申请） | ✅ 标记 | ✅ 标记 | ✅ 标记 | ✅ 标记 |
| 方案D | ❌ 查看（可申请） | ✅ 标记 | ✅ 审核 | ✅ 审核 | ✅ 标记 |

**说明：**
- 方案A、B、C、D在自主实习中的处理方式基本相同（都由班主任标记）
- 方案C和D可以考虑让学生申请标记结束，需要班主任审核

---

## 七、代码实现要点

### 7.1 判断申请类型

在实现标记功能时，需要先判断申请类型（合作企业 or 自主实习），然后应用不同的权限规则：

```java
private void checkCompletePermission(InternshipApply apply) {
    Integer applyType = apply.getApplyType();
    
    if (applyType == null) {
        throw new BusinessException("申请类型不能为空");
    }
    
    // 根据申请类型判断权限
    if (applyType.equals(ApplyType.COOPERATION.getCode())) {
        // 合作企业实习：检查企业权限
        checkCooperationPermission(apply);
    } else if (applyType.equals(ApplyType.SELF.getCode())) {
        // 自主实习：检查学校权限
        checkSelfInternshipPermission(apply);
    } else {
        throw new BusinessException("未知的申请类型");
    }
}

// 合作企业实习权限检查
private void checkCooperationPermission(InternshipApply apply) {
    // 系统管理员可以标记所有
    if (dataPermissionUtil.isSystemAdmin()) {
        return;
    }
    
    // 企业管理员/企业导师可以标记本企业的申请
    Long currentUserEnterpriseId = dataPermissionUtil.getCurrentUserEnterpriseId();
    if (currentUserEnterpriseId != null && 
        apply.getEnterpriseId() != null &&
        currentUserEnterpriseId.equals(apply.getEnterpriseId())) {
        return;
    }
    
    throw new BusinessException("无权标记该实习申请（仅企业管理员/企业导师可以标记合作企业实习）");
}

// 自主实习权限检查
private void checkSelfInternshipPermission(InternshipApply apply) {
    // 系统管理员可以标记所有
    if (dataPermissionUtil.isSystemAdmin()) {
        return;
    }
    
    // 学校管理员可以标记本校学生的申请
    if (dataPermissionUtil.hasRole(Constants.ROLE_SCHOOL_ADMIN)) {
        // 可以添加学校ID验证
        return;
    }
    
    // 学院负责人可以标记本院学生的申请
    if (dataPermissionUtil.hasRole(Constants.ROLE_COLLEGE_LEADER)) {
        if (apply.getStudentId() == null) {
            throw new BusinessException("无权标记该实习申请");
        }
        Student student = studentMapper.selectById(apply.getStudentId());
        if (student == null || student.getCollegeId() == null) {
            throw new BusinessException("无权标记该实习申请");
        }
        Long currentUserCollegeId = dataPermissionUtil.getCurrentUserCollegeId();
        if (currentUserCollegeId != null && currentUserCollegeId.equals(student.getCollegeId())) {
            return;
        }
    }
    
    // 班主任可以标记本班学生的申请
    if (dataPermissionUtil.hasRole(Constants.ROLE_CLASS_TEACHER)) {
        if (apply.getStudentId() == null) {
            throw new BusinessException("无权标记该实习申请");
        }
        Student student = studentMapper.selectById(apply.getStudentId());
        if (student == null || student.getClassId() == null) {
            throw new BusinessException("无权标记该实习申请");
        }
        List<Long> classIds = dataPermissionUtil.getCurrentUserClassIds();
        if (classIds != null && classIds.contains(student.getClassId())) {
            return;
        }
    }
    
    throw new BusinessException("无权标记该实习申请（仅班主任/学校管理员可以标记自主实习）");
}
```

### 7.2 状态验证

根据申请类型验证状态：

```java
private void validateStatusForComplete(InternshipApply apply) {
    Integer status = apply.getStatus();
    Integer applyType = apply.getApplyType();
    
    if (applyType == null) {
        throw new BusinessException("申请类型不能为空");
    }
    
    // 合作企业：只有"已录用"（status=3）才能标记为结束
    if (applyType.equals(ApplyType.COOPERATION.getCode())) {
        if (status == null || !status.equals(InternshipApplyStatus.ACCEPTED.getCode())) {
            throw new BusinessException("只有已录用的合作企业实习申请才能标记为结束");
        }
        if (status.equals(InternshipApplyStatus.COMPLETED.getCode())) {
            throw new BusinessException("该实习申请已经标记为结束");
        }
    }
    
    // 自主实习：只有"实习中"（status=11）才能标记为结束
    if (applyType.equals(ApplyType.SELF.getCode())) {
        if (status == null || !status.equals(SelfInternshipApplyStatus.IN_PROGRESS.getCode())) {
            throw new BusinessException("只有实习中的自主实习申请才能标记为结束");
        }
        if (status.equals(SelfInternshipApplyStatus.COMPLETED.getCode())) {
            throw new BusinessException("该实习申请已经标记为结束");
        }
    }
}
```

### 7.3 状态更新

根据申请类型设置正确的状态：

```java
private void updateApplyForComplete(InternshipApply apply, LocalDate endDate, String remark) {
    // 设置实习结束日期
    if (endDate != null) {
        apply.setInternshipEndDate(endDate);
    } else {
        apply.setInternshipEndDate(LocalDate.now());
    }
    
    // 根据申请类型设置状态
    if (apply.getApplyType().equals(ApplyType.COOPERATION.getCode())) {
        // 合作企业：设置为实习结束（status=7）
        apply.setStatus(InternshipApplyStatus.COMPLETED.getCode());
    } else if (apply.getApplyType().equals(ApplyType.SELF.getCode())) {
        // 自主实习：设置为实习结束（status=13）
        apply.setStatus(SelfInternshipApplyStatus.COMPLETED.getCode());
    }
    
    // 保存备注
    if (remark != null && !remark.trim().isEmpty()) {
        apply.setUnbindAuditOpinion(remark);
    }
    
    this.updateById(apply);
}
```

---

## 八、实施建议

### 8.1 第一阶段：实施方案A
- 区分合作企业和自主实习，分别处理
- 合作企业：仅企业可以标记
- 自主实习：仅班主任可以标记
- 添加提醒机制
- 观察使用情况

### 8.2 第二阶段：根据反馈调整
- 如果企业配合度高，保持方案A
- 如果企业配合度低，调整为方案C（仅合作企业）

### 8.3 长期优化
- 根据实际使用情况优化
- 可以考虑添加自动标记功能（实习结束日期到期自动标记）
- 可以考虑让学生申请标记结束（自主实习）

---

## 八、总结

**最佳实践：**
1. **合作企业实习**：
   - 正常情况下：由企业导师/企业管理员标记（方案A）
   - 容错情况：如果企业不配合，班主任可以标记（方案C）
   - 兜底机制：系统管理员可以标记（所有方案）

2. **自主实习**：
   - 正常情况下：由班主任标记（方案A）
   - 可选：学生可以申请标记结束，需要班主任审核
   - 兜底机制：系统管理员可以标记（所有方案）

**关键点：**
- **必须区分合作企业实习和自主实习**：两种实习类型的特点不同，需要采用不同的处理方式
- **合作企业**：企业最清楚实习实际情况，应该由企业标记
- **自主实习**：没有企业参与，应该由班主任管理
- **容错机制**：防止一方不配合导致无法标记
- **提醒机制**：确保及时标记
- **兜底机制**：系统管理员可以标记（所有情况）

