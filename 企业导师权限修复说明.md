# ä¼ä¸šå¯¼å¸ˆè®¿é—®å­¦ç”Ÿåˆ—è¡¨æƒé™ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

ä¼ä¸šå¯¼å¸ˆè®¿é—®å­¦ç”Ÿè¯„ä»·æ—¶å‡ºç°403æƒé™é”™è¯¯ï¼š
```
GET /internship/apply/enterprise/students?current=1&size=10&status=7:1 
Failed to load resource: the server responded with a status of 403
```

## ğŸ” é—®é¢˜åŸå› 

`/internship/apply/enterprise/students` æ¥å£çš„æƒé™é…ç½®åªå…è®¸ä¼ä¸šç®¡ç†å‘˜è®¿é—®ï¼Œæ²¡æœ‰åŒ…å«ä¼ä¸šå¯¼å¸ˆè§’è‰²ã€‚

**åŸæƒé™é…ç½®**ï¼š
```java
@PreAuthorize("hasRole('ROLE_ENTERPRISE_ADMIN')")
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. Controllerå±‚æƒé™ä¿®å¤

**æ–‡ä»¶**ï¼š`InternshipApplyController.java`

**ä¿®æ”¹**ï¼šå°†æƒé™ä»åªå…è®¸ä¼ä¸šç®¡ç†å‘˜æ”¹ä¸ºå…è®¸ä¼ä¸šç®¡ç†å‘˜å’Œä¼ä¸šå¯¼å¸ˆï¼š

```java
// ä¿®æ”¹å‰
@PreAuthorize("hasRole('ROLE_ENTERPRISE_ADMIN')")

// ä¿®æ”¹å
@PreAuthorize("hasAnyRole('ROLE_ENTERPRISE_ADMIN', 'ROLE_ENTERPRISE_MENTOR')")
```

### 2. Serviceå±‚æ•°æ®æƒé™è¿‡æ»¤

**æ–‡ä»¶**ï¼š`InternshipApplyServiceImpl.java`

**æ–¹æ³•**ï¼š`applyEnterpriseFilterForStudents`

**ä¿®æ”¹**ï¼šæ·»åŠ ä¼ä¸šå¯¼å¸ˆçš„æ•°æ®æƒé™è¿‡æ»¤é€»è¾‘ï¼š

- **ä¼ä¸šç®¡ç†å‘˜**ï¼šå¯ä»¥æŸ¥çœ‹æœ¬ä¼ä¸šçš„æ‰€æœ‰å­¦ç”Ÿ
- **ä¼ä¸šå¯¼å¸ˆ**ï¼šåªèƒ½æŸ¥çœ‹åˆ†é…ç»™è‡ªå·±çš„å­¦ç”Ÿï¼ˆé€šè¿‡mentorIdè¿‡æ»¤ï¼‰
- **ç³»ç»Ÿç®¡ç†å‘˜**ï¼šä¸æ·»åŠ é™åˆ¶

```java
private void applyEnterpriseFilterForStudents(LambdaQueryWrapper<InternshipApply> wrapper) {
    // ç³»ç»Ÿç®¡ç†å‘˜ä¸æ·»åŠ é™åˆ¶
    if (dataPermissionUtil.isSystemAdmin()) {
        return;
    }
    
    UserInfo user = UserUtil.getCurrentUserOrNull(userMapper);
    if (user == null) {
        wrapper.eq(InternshipApply::getApplyId, -1L);
        return;
    }
    
    List<String> roleCodes = userMapper.selectRoleCodesByUserId(user.getUserId());
    
    // ä¼ä¸šå¯¼å¸ˆï¼šåªèƒ½æŸ¥çœ‹åˆ†é…ç»™è‡ªå·±çš„å­¦ç”Ÿ
    if (DataPermissionUtil.hasRole(roleCodes, Constants.ROLE_ENTERPRISE_MENTOR)) {
        Long mentorId = dataPermissionUtil.getCurrentUserMentorId();
        if (mentorId != null) {
            wrapper.eq(InternshipApply::getMentorId, mentorId);
        } else {
            wrapper.eq(InternshipApply::getApplyId, -1L);
        }
        return;
    }
    
    // ä¼ä¸šç®¡ç†å‘˜ï¼šæŸ¥çœ‹æœ¬ä¼ä¸šçš„æ‰€æœ‰å­¦ç”Ÿ
    Long currentUserEnterpriseId = dataPermissionUtil.getCurrentUserEnterpriseId();
    if (currentUserEnterpriseId != null) {
        wrapper.eq(InternshipApply::getEnterpriseId, currentUserEnterpriseId);
    } else {
        wrapper.eq(InternshipApply::getApplyId, -1L);
    }
}
```

## ğŸ“Š æ•°æ®æƒé™èŒƒå›´

### ä¼ä¸šç®¡ç†å‘˜ (ROLE_ENTERPRISE_ADMIN)
- **æ•°æ®èŒƒå›´**ï¼šæœ¬ä¼ä¸šçš„æ‰€æœ‰å·²å½•ç”¨å­¦ç”Ÿ
- **è¿‡æ»¤æ¡ä»¶**ï¼š`enterpriseId = å½“å‰ç”¨æˆ·çš„ä¼ä¸šID`

### ä¼ä¸šå¯¼å¸ˆ (ROLE_ENTERPRISE_MENTOR)
- **æ•°æ®èŒƒå›´**ï¼šåˆ†é…ç»™è‡ªå·±çš„å­¦ç”Ÿ
- **è¿‡æ»¤æ¡ä»¶**ï¼š`mentorId = å½“å‰ç”¨æˆ·çš„å¯¼å¸ˆID`

## âœ… ä¿®å¤å®Œæˆ

1. âœ… Controllerå±‚æƒé™å·²æ·»åŠ ä¼ä¸šå¯¼å¸ˆè§’è‰²
2. âœ… Serviceå±‚æ•°æ®æƒé™è¿‡æ»¤å·²å®ç°ä¼ä¸šå¯¼å¸ˆçš„é€»è¾‘
3. âœ… ä¼ä¸šå¯¼å¸ˆåªèƒ½æŸ¥çœ‹åˆ†é…ç»™è‡ªå·±çš„å­¦ç”Ÿ

## ğŸ” éªŒè¯

ä¿®å¤åï¼Œä¼ä¸šå¯¼å¸ˆåº”è¯¥èƒ½å¤Ÿï¼š
1. âœ… è®¿é—® `/internship/apply/enterprise/students` æ¥å£
2. âœ… æŸ¥çœ‹åˆ†é…ç»™è‡ªå·±çš„å­¦ç”Ÿåˆ—è¡¨
3. âœ… å¯¹å­¦ç”Ÿè¿›è¡Œè¯„ä»·æ“ä½œ

