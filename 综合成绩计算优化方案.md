# 综合成绩计算优化方案

## 当前问题分析

### 1. 配置键使用情况
✅ **配置键已在使用**：`ComprehensiveScoreServiceImpl` 中已使用了三个配置键：
- `enterprise_evaluation_weight` (默认0.4 = 40%)
- `school_evaluation_weight` (默认0.4 = 40%)
- `student_self_evaluation_weight` (默认0.2 = 20%)

### 2. 存在的逻辑问题

**问题1：未区分实习类型**
- 当前代码要求三个评价都必须完成（企业评价、学校评价、自评）
- 但**自主实习学生没有企业评价**，导致无法计算综合成绩
- 需要区分合作企业实习和自主实习两种情况

**问题2：权重分配不合理**
- 自主实习情况下，只有学校评价和自评，权重需要重新分配
- 例如：学校评价60% + 自评40%

**问题3：缺少总分显示**
- 班主任评价页面（`teacher/StudentEvaluation.vue`）只显示评价状态
- 没有显示综合成绩（总分）列

## 解决方案

### 方案一：区分实习类型计算综合成绩（推荐）

#### 1. 修改综合成绩计算逻辑

**合作企业实习 (applyType=1)**：
```
综合成绩 = 企业评价×40% + 学校评价×40% + 自评×20%
```

**自主实习 (applyType=2)**：
```
综合成绩 = 学校评价×60% + 自评×40%
```

#### 2. 实现步骤

**步骤1：修改 `checkAllEvaluationsCompleted()` 方法**
- 判断申请类型
- 合作企业实习：检查企业评价、学校评价、自评
- 自主实习：只检查学校评价和自评

**步骤2：修改 `calculateComprehensiveScore()` 方法**
- 根据申请类型选择不同的计算公式
- 合作企业实习：使用配置的权重
- 自主实习：使用固定的权重（学校60% + 自评40%）

**步骤3：在班主任评价页面添加总分列**
- 查询时关联综合成绩表
- 在列表中添加"综合成绩"列
- 显示分数和等级（优秀/良好/中等/及格/不及格）

### 方案二：使用配置键动态调整权重

#### 1. 新增配置键
- `self_internship_school_weight`：自主实习学校评价权重（默认0.6）
- `self_internship_self_weight`：自主实习自评权重（默认0.4）

#### 2. 计算逻辑
- 根据申请类型和配置键动态计算权重
- 更灵活，但需要额外的配置项

## 推荐实现方案

采用**方案一**，理由：
1. 简单直接，不需要额外的配置项
2. 自主实习的权重分配固定，符合实际需求
3. 合作企业实习仍然使用配置键，保持灵活性

## 具体实现

### 1. 后端修改

#### 修改 `ComprehensiveScoreServiceImpl.java`

```java
// 修改 checkAllEvaluationsCompleted 方法
@Override
public boolean checkAllEvaluationsCompleted(Long applyId) {
    // 获取申请信息
    InternshipApply apply = internshipApplyMapper.selectById(applyId);
    if (apply == null) {
        return false;
    }
    
    // 检查学校评价和自评（所有类型都需要）
    SchoolEvaluation schoolEval = getSchoolEvaluation(applyId);
    SelfEvaluation selfEval = getSelfEvaluation(applyId);
    
    if (schoolEval == null || selfEval == null) {
        return false;
    }
    
    // 如果是合作企业实习，还需要检查企业评价
    if (apply.getApplyType() != null && apply.getApplyType().equals(ApplyType.COOPERATION.getCode())) {
        EnterpriseEvaluation enterpriseEval = getEnterpriseEvaluation(applyId);
        return enterpriseEval != null && 
               enterpriseEval.getEvaluationStatus().equals(EvaluationStatus.SUBMITTED.getCode()) &&
               schoolEval.getEvaluationStatus().equals(EvaluationStatus.SUBMITTED.getCode()) &&
               selfEval.getEvaluationStatus().equals(EvaluationStatus.SUBMITTED.getCode());
    } else {
        // 自主实习只需要学校评价和自评
        return schoolEval.getEvaluationStatus().equals(EvaluationStatus.SUBMITTED.getCode()) &&
               selfEval.getEvaluationStatus().equals(EvaluationStatus.SUBMITTED.getCode());
    }
}

// 修改 calculateComprehensiveScore 方法
@Override
@Transactional(rollbackFor = Exception.class)
public ComprehensiveScore calculateComprehensiveScore(Long applyId) {
    // ... 前面的验证代码 ...
    
    // 判断申请类型
    boolean isCooperation = apply.getApplyType() != null && 
                           apply.getApplyType().equals(ApplyType.COOPERATION.getCode());
    
    BigDecimal comprehensiveScore;
    BigDecimal enterpriseScore = null;
    BigDecimal schoolScore = schoolEval.getTotalScore();
    BigDecimal selfScore = selfEval.getSelfScore();
    
    if (isCooperation) {
        // 合作企业实习：企业×40% + 学校×40% + 自评×20%
        enterpriseScore = enterpriseEval.getTotalScore();
        
        BigDecimal enterpriseWeight = new BigDecimal(
            SystemConfigUtil.getConfigValue(ConfigKeys.ENTERPRISE_EVALUATION_WEIGHT, "0.4")
        );
        BigDecimal schoolWeight = new BigDecimal(
            SystemConfigUtil.getConfigValue(ConfigKeys.SCHOOL_EVALUATION_WEIGHT, "0.4")
        );
        BigDecimal selfWeight = new BigDecimal(
            SystemConfigUtil.getConfigValue(ConfigKeys.STUDENT_SELF_EVALUATION_WEIGHT, "0.2")
        );
        
        BigDecimal enterprisePart = enterpriseScore.multiply(enterpriseWeight);
        BigDecimal schoolPart = schoolScore.multiply(schoolWeight);
        BigDecimal selfPart = selfScore.multiply(selfWeight);
        comprehensiveScore = enterprisePart.add(schoolPart).add(selfPart)
                                          .setScale(2, RoundingMode.HALF_UP);
    } else {
        // 自主实习：学校×60% + 自评×40%
        BigDecimal schoolWeight = new BigDecimal("0.6");
        BigDecimal selfWeight = new BigDecimal("0.4");
        
        BigDecimal schoolPart = schoolScore.multiply(schoolWeight);
        BigDecimal selfPart = selfScore.multiply(selfWeight);
        comprehensiveScore = schoolPart.add(selfPart).setScale(2, RoundingMode.HALF_UP);
    }
    
    // ... 后续保存逻辑 ...
}
```

### 2. 前端修改

#### 修改 `teacher/StudentEvaluation.vue`

```vue
<!-- 在表格中添加综合成绩列 -->
<el-table-column label="综合成绩" width="120" align="center">
  <template #default="{ row }">
    <div v-if="row.comprehensiveScore">
      <div style="font-weight: bold; color: #409eff;">
        {{ row.comprehensiveScore }}
      </div>
      <el-tag 
        :type="getGradeTagType(row.gradeLevel)" 
        size="small"
        style="margin-top: 4px;"
      >
        {{ row.gradeLevel || '-' }}
      </el-tag>
    </div>
    <span v-else style="color: #909399;">-</span>
  </template>
</el-table-column>

<script>
// 在 loadData 方法中，加载综合成绩
const loadData = async () => {
  // ... 加载评价数据 ...
  
  // 为每个学生加载综合成绩
  for (const item of tableData.value) {
    if (item.applyId) {
      const scoreRes = await comprehensiveScoreApi.getScoreByApplyId(item.applyId)
      if (scoreRes.code === 200 && scoreRes.data) {
        item.comprehensiveScore = scoreRes.data.comprehensiveScore
        item.gradeLevel = scoreRes.data.gradeLevel
      }
    }
  }
}

// 获取等级标签类型
const getGradeTagType = (gradeLevel) => {
  const typeMap = {
    '优秀': 'success',
    '良好': '',
    '中等': 'warning',
    '及格': 'info',
    '不及格': 'danger'
  }
  return typeMap[gradeLevel] || ''
}
</script>
```

## 实施建议

### 阶段一：修复综合成绩计算逻辑
1. 修改 `checkAllEvaluationsCompleted()` 方法，区分实习类型
2. 修改 `calculateComprehensiveScore()` 方法，根据类型使用不同公式
3. 测试合作企业实习和自主实习两种情况

### 阶段二：添加总分显示
1. 修改学校评价列表查询，关联综合成绩
2. 在班主任评价页面添加综合成绩列
3. 显示分数和等级

## 注意事项

1. **兼容性**：修改后需要兼容已有的综合成绩数据
2. **自动计算**：在评价提交后，可以自动触发综合成绩计算（如果所有必需评价都已完成）
3. **数据权限**：确保班主任只能看到本班学生的综合成绩

